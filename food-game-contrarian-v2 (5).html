<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>The Contrarian Â· by Food Game</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8cmFkaWFsR3JhZGllbnQgaWQ9ImxvZ29CZ0wiIGN4PSIzOCUiIGN5PSIzMiUiIHI9Ijc1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZGYwZjUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZjVlOGVmIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSJ1cmwoI2xvZ29CZ0wpIi8+CiAgPHJlY3QgeD0iNjQiIHk9IjEwMCIgd2lkdGg9IjM4NCIgaGVpZ2h0PSIwLjgiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMTUiLz4KICA8cmVjdCB4PSI2NCIgeT0iNDEyIiB3aWR0aD0iMzg0IiBoZWlnaHQ9IjAuOCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4xNSIvPgogIDx0ZXh0IHg9IjI1NiIgeT0iMjA0IiBmb250LWZhbWlseT0iUGxheWZhaXIgRGlzcGxheSwgR2VvcmdpYSwgc2VyaWYiIGZvbnQtc2l6ZT0iNDQiIGZvbnQtd2VpZ2h0PSI3MDAiIGZvbnQtc3R5bGU9Iml0YWxpYyIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC41IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iMTgiPlRIRTwvdGV4dD4KICA8dGV4dCB4PSIyNTYiIHk9IjMwOCIgZm9udC1mYW1pbHk9IlBsYXlmYWlyIERpc3BsYXksIEdlb3JnaWEsIHNlcmlmIiBmb250LXNpemU9Ijc2IiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjMGYxZjM4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iLTIiPkNvbnRyYXJpYW48L3RleHQ+CiAgPHJlY3QgeD0iMTQ4IiB5PSIzMjYiIHdpZHRoPSIyMTYiIGhlaWdodD0iMi41IiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjg1Ii8+CiAgPHRleHQgeD0iMjU2IiB5PSIzNjgiIGZvbnQtZmFtaWx5PSJETSBTYW5zLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNTAwIiBmaWxsPSJyZ2JhKDE1LDMxLDU2LDAuMzUpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iNSI+Rk9PRCBHQU1FIE1FRElBPC90ZXh0PgogIDxyZWN0IHg9IjY0IiB5PSI2NCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjY0IiB5PSI2NCIgd2lkdGg9IjIiIGhlaWdodD0iMjAiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjQyOCIgeT0iNjQiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyIiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjMiLz4KICA8cmVjdCB4PSI0NDYiIHk9IjY0IiB3aWR0aD0iMiIgaGVpZ2h0PSIyMCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4zIi8+CiAgPHJlY3QgeD0iNjQiIHk9IjQ0NiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjY0IiB5PSI0MjgiIHdpZHRoPSIyIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjMiLz4KICA8cmVjdCB4PSI0MjgiIHk9IjQ0NiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjQ0NiIgeT0iNDI4IiB3aWR0aD0iMiIgaGVpZ2h0PSIyMCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4zIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Playfair+Display:ital,wght@0,700;0,900;1,700;1,900&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0f1f38;
  --navy-mid: #1a2f52;
  --navy-light: #243b5e;
  --navy-dark: #08131f;
  --pink: #e91e8c;
  --pink-soft: #f4a7b9;
  --pink-dim: rgba(233,30,140,0.12);
  --white: #f8f8f8;
  --off-white: #f0ede8;
  --grey: #8a9ab5;
  --grey-dim: rgba(138,154,181,0.15);
  --border: rgba(244,167,185,0.1);
  --border-hover: rgba(244,167,185,0.3);
  --radius: 12px;
  --radius-sm: 8px;
  --transition: 0.18s ease;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family:'DM Sans', system-ui, sans-serif;
  background: var(--navy-dark);
  color: var(--white);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â•â•â• SCROLLBAR â•â•â• */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(244,167,185,0.2); border-radius: 2px; }

/* â•â•â• LAYOUT â•â•â• */
.app { display:flex; min-height:100vh; }

.sidebar {
  width: 260px;
  min-width: 260px;
  background: var(--navy);
  border-right: 1px solid var(--border);
  padding: 0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  position: relative;
  z-index: 10;
}

.sidebar-logo {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(233,30,140,0.06) 0%, transparent 100%);
}

.sidebar-logo .wordmark {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 28px;
  font-weight: 900;
  color: var(--white);
  line-height: 1.0;
  letter-spacing: -0.8px;
  font-style: normal;
  white-space: nowrap;
}

.sidebar-logo .wordmark span { color: var(--pink-soft); }

.sidebar-logo .tagline {
  font-size: 8px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: rgba(138,154,181,0.6);
  margin-top: 7px;
  font-weight: 600;
}

.sidebar-logo .wordmark-rule {
  width: 32px;
  height: 2px;
  background: linear-gradient(90deg, var(--pink), transparent);
  margin-top: 10px;
}

.sidebar-nav {
  padding: 12px 10px;
  flex: 1;
}

.nav-section {
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: rgba(138,154,181,0.5);
  padding: 14px 10px 6px;
  font-weight: 600;
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 10px 12px;
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  color: var(--grey);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  text-align: left;
  transition: all var(--transition);
  letter-spacing: 0.1px;
}

.nav-btn:hover { background: var(--grey-dim); color: var(--white); }
.nav-btn.active { background: var(--pink-dim); color: var(--pink-soft); }
.nav-btn.active .nav-icon { opacity: 1; }
.nav-icon { font-size: 14px; opacity: 0.6; flex-shrink: 0; }

.sidebar-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
}

.api-status-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  color: var(--grey);
  font-weight: 500;
}

.api-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #4ade80;
  flex-shrink: 0;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* â•â•â• MAIN â•â•â• */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

.topbar {
  background: var(--navy);
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-shrink: 0;
}

.topbar-title {
  font-family: 'DM Serif Display', Georgia, serif;
  font-size: 16px;
  color: var(--white);
  font-style: italic;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.hamburger {
  display: none;
  background: transparent;
  border: none;
  color: var(--white);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
}

/* â•â•â• STATUS BAR â•â•â• */
.status-bar {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 8px 28px;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  color: var(--grey);
}

.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}
.status-dot.working { background:#f59e0b; animation: pulse 1s infinite; }
.status-dot.done { background:#4ade80; }
.status-dot.error { background:#f87171; }

/* â•â•â• CONTENT AREA â•â•â• */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.panel { display: none; }
.panel.active { display: block; }

/* â•â•â• BUTTONS â•â•â• */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  letter-spacing: 0.2px;
  white-space: nowrap;
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.btn-primary {
  background: linear-gradient(135deg, #e91e8c, #c2185b);
  color: #fff;
  box-shadow: 0 4px 16px rgba(233,30,140,0.25);
}
.btn-primary:hover:not(:disabled) {
  box-shadow: 0 6px 24px rgba(233,30,140,0.4);
  transform: translateY(-1px);
}

.btn-secondary {
  background: rgba(138,154,181,0.12);
  color: var(--grey);
  border: 1px solid rgba(138,154,181,0.2);
}
.btn-secondary:hover:not(:disabled) {
  background: rgba(138,154,181,0.2);
  color: var(--white);
  border-color: rgba(138,154,181,0.35);
}

.btn-outline {
  background: transparent;
  color: var(--pink-soft);
  border: 1px solid rgba(244,167,185,0.3);
}
.btn-outline:hover:not(:disabled) {
  background: var(--pink-dim);
  border-color: rgba(244,167,185,0.5);
}

.btn-ghost {
  background: transparent;
  color: var(--grey);
  border: 1px solid var(--border);
  font-size: 12px;
  padding: 8px 14px;
}
.btn-ghost:hover:not(:disabled) { color: var(--white); border-color: var(--border-hover); }

.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

/* â•â•â• START SCREEN â•â•â• */
.start-screen {
  min-height: calc(100vh - 57px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 32px;
  background: radial-gradient(ellipse at 60% 20%, rgba(233,30,140,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 20% 80%, rgba(244,167,185,0.04) 0%, transparent 50%);
}

.start-headline {
  text-align: center;
  margin-bottom: 48px;
}

.start-headline .overline {
  font-size: 9px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--pink-soft);
  opacity: 0.7;
  margin-bottom: 14px;
  font-weight: 600;
}

.start-headline h1 {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: clamp(28px, 4vw, 44px);
  font-weight: 900;
  color: var(--white);
  line-height: 1.1;
  letter-spacing: -1px;
  margin-bottom: 12px;
}

.start-headline h1 em {
  color: var(--pink-soft);
  font-style: italic;
}

.start-headline p {
  font-size: 14px;
  color: var(--grey);
  line-height: 1.6;
  max-width: 420px;
  margin: 0 auto;
}

/* Entry point cards */
.entry-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  width: 100%;
  max-width: 780px;
  margin-bottom: 40px;
}

.entry-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px 24px;
  cursor: pointer;
  transition: all 0.22s ease;
  text-align: left;
  position: relative;
  overflow: hidden;
}

.entry-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--card-accent, var(--pink)), transparent);
  opacity: 0;
  transition: opacity 0.22s ease;
}

.entry-card:hover {
  background: rgba(255,255,255,0.06);
  border-color: var(--border-hover);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(0,0,0,0.3);
}

.entry-card:hover::before { opacity: 1; }

.entry-card .card-icon {
  font-size: 28px;
  margin-bottom: 14px;
  display: block;
}

.entry-card .card-title {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 17px;
  font-weight: 900;
  color: var(--white);
  margin-bottom: 8px;
  line-height: 1.2;
}

.entry-card .card-desc {
  font-size: 12px;
  color: var(--grey);
  line-height: 1.6;
}

.entry-card .card-action {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 16px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  color: var(--card-accent, var(--pink-soft));
  opacity: 0.8;
  text-transform: uppercase;
}

/* â•â•â• SECTION WRAPPER â•â•â• */
.section-wrap {
  max-width: 760px;
  margin: 0 auto;
  padding: 32px 28px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.section-title {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 22px;
  font-weight: 900;
  color: var(--white);
  font-style: italic;
}

.section-subtitle {
  font-size: 12px;
  color: var(--grey);
  margin-top: 4px;
}

/* â•â•â• FORMS â•â•â• */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--grey);
  margin-bottom: 8px;
}

.form-label span {
  font-weight: 400;
  letter-spacing: 0;
  text-transform: none;
  color: rgba(138,154,181,0.5);
  font-size: 10px;
  margin-left: 6px;
}

.form-input, .form-textarea {
  width: 100%;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  color: var(--white);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  transition: border-color var(--transition);
  resize: none;
}

.form-input:focus, .form-textarea:focus {
  outline: none;
  border-color: rgba(244,167,185,0.4);
  background: rgba(255,255,255,0.06);
}

.form-input::placeholder, .form-textarea::placeholder {
  color: rgba(138,154,181,0.4);
  font-style: italic;
}

/* Word count chips */
.chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.chip {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--grey);
  transition: all var(--transition);
  font-family: 'DM Sans', sans-serif;
}
.chip:hover { border-color: var(--border-hover); color: var(--white); }
.chip.active { background: var(--pink-dim); border-color: rgba(233,30,140,0.4); color: var(--pink-soft); }

/* â•â•â• URL DROP PANEL â•â•â• */
.url-drop-zone {
  border: 2px dashed var(--border);
  border-radius: 16px;
  padding: 32px;
  text-align: center;
  transition: all 0.2s ease;
  margin-bottom: 20px;
  cursor: pointer;
}

.url-drop-zone:hover, .url-drop-zone.dragover {
  border-color: rgba(244,167,185,0.4);
  background: rgba(244,167,185,0.04);
}

.url-drop-zone .drop-icon { font-size: 32px; margin-bottom: 10px; }
.url-drop-zone .drop-title { font-size: 15px; font-weight: 600; color: var(--white); margin-bottom: 6px; }
.url-drop-zone .drop-hint { font-size: 12px; color: var(--grey); }

/* Multi URL list */
.url-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.url-item {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  font-size: 12px;
}

.url-item .url-text {
  flex: 1;
  color: var(--pink-soft);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.url-item .url-status { font-size: 11px; color: var(--grey); flex-shrink: 0; }

.url-item .url-remove {
  background: transparent;
  border: none;
  color: var(--grey);
  cursor: pointer;
  font-size: 14px;
  padding: 2px 4px;
  transition: color var(--transition);
  flex-shrink: 0;
}
.url-item .url-remove:hover { color: #f87171; }

/* â•â•â• TOPIC INTELLIGENCE â•â•â• */
.intel-mode-tabs {
  display: flex;
  gap: 4px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 24px;
}

.intel-tab {
  flex: 1;
  padding: 10px;
  background: transparent;
  border: none;
  border-radius: 7px;
  color: var(--grey);
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  text-align: center;
}

.intel-tab.active {
  background: var(--navy-mid);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.intel-tab-panel { display: none; }
.intel-tab-panel.active { display: block; }

/* Region grid */
.region-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.region-btn {
  padding: 10px 8px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--grey);
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  text-align: center;
}

.region-btn:hover { border-color: var(--border-hover); color: var(--white); }
.region-btn.active { background: var(--pink-dim); border-color: rgba(233,30,140,0.4); color: var(--pink-soft); }

/* Date range */
.date-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.api-stub-notice {
  background: rgba(245,158,11,0.08);
  border: 1px solid rgba(245,158,11,0.2);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  font-size: 12px;
  color: rgba(245,158,11,0.8);
  margin-bottom: 20px;
  line-height: 1.5;
}

.api-stub-notice strong { color: rgba(245,158,11,1); }

/* Digest results */
.digest-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.digest-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 20px;
  transition: all 0.2s ease;
  cursor: pointer;
  position: relative;
}

.digest-card:hover {
  background: rgba(255,255,255,0.06);
  border-color: var(--border-hover);
}

.digest-card.selected {
  background: var(--pink-dim);
  border-color: rgba(233,30,140,0.3);
}

.digest-rank {
  position: absolute;
  top: 12px;
  right: 14px;
  font-size: 10px;
  font-weight: 700;
  color: var(--grey);
  opacity: 0.5;
}

.digest-source-tag {
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--pink-soft);
  opacity: 0.7;
  margin-bottom: 6px;
  font-weight: 600;
}

.digest-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--white);
  line-height: 1.4;
  margin-bottom: 8px;
}

.digest-angle {
  font-size: 12px;
  color: var(--grey);
  line-height: 1.6;
  margin-bottom: 10px;
  font-style: italic;
}

.digest-url {
  font-size: 11px;
  color: rgba(138,154,181,0.5);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.digest-actions {
  display: flex;
  gap: 6px;
  margin-top: 12px;
}

/* â•â•â• SOURCES â•â•â• */
.source-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 16px;
  margin-bottom: 10px;
  transition: border-color var(--transition);
}

.source-card:hover { border-color: var(--border-hover); }

.source-check {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 8px;
}

.source-check input[type="checkbox"] {
  margin-top: 2px;
  accent-color: var(--pink);
  width: 14px;
  height: 14px;
  flex-shrink: 0;
  cursor: pointer;
}

.source-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--white);
  line-height: 1.4;
  flex: 1;
}

.source-snippet {
  font-size: 12px;
  color: var(--grey);
  line-height: 1.6;
  margin-bottom: 8px;
}

.source-url {
  font-size: 11px;
  color: rgba(244,167,185,0.5);
  text-decoration: none;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
}
.source-url:hover { color: var(--pink-soft); }

/* â•â•â• OUTPUT â•â•â• */
.output-tabs {
  display: flex;
  gap: 4px;
  padding: 0 28px;
  border-bottom: 1px solid var(--border);
  background: var(--navy);
}

.output-tab {
  padding: 12px 16px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--grey);
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  margin-bottom: -1px;
}

.output-tab.active { color: var(--white); border-bottom-color: var(--pink); }
.output-tab:hover:not(.active) { color: var(--white); }

.output-content { padding: 28px; }

.output-preview {
  background: var(--off-white);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.output-raw, .output-html-code {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
  font-family: 'DM Mono', 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.7;
  color: var(--grey);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 500px;
  overflow-y: auto;
}

/* â•â•â• HISTORY â•â•â• */
.history-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
  margin-bottom: 10px;
  transition: border-color var(--transition);
}

.history-item:hover { border-color: var(--border-hover); }
.history-title { font-size: 14px; font-weight: 700; color: var(--white); margin-bottom: 4px; }
.history-meta { font-size: 11px; color: var(--grey); margin-bottom: 10px; }

/* â•â•â• TOAST â•â•â• */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--navy-mid);
  color: var(--white);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  border: 1px solid var(--border-hover);
  z-index: 1000;
  transition: transform 0.25s ease;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* â•â•â• OVERLAY â•â•â• */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9;
  backdrop-filter: blur(2px);
}
.overlay.show { display: block; }

/* â•â•â• DIVIDER â•â•â• */
.divider {
  height: 1px;
  background: var(--border);
  margin: 24px 0;
}

/* â•â•â• INFO BOX â•â•â• */
.info-box {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  font-size: 12px;
  color: var(--grey);
  line-height: 1.6;
  margin-bottom: 20px;
}

.info-box strong { color: var(--pink-soft); font-weight: 600; }

/* â•â•â• HELP â•â•â• */
.help-wrap { padding: 32px 28px; max-width: 680px; }
.help-section { margin-bottom: 32px; }
.help-section h3 {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--pink-soft);
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  font-style: italic;
}
.help-section p { font-size: 13px; color: var(--grey); line-height: 1.75; margin-bottom: 10px; }
.help-section li { font-size: 13px; color: var(--grey); line-height: 1.75; margin-bottom: 6px; margin-left: 16px; }
.help-section strong { color: var(--white); font-weight: 600; }
.help-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.help-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--grey); vertical-align: top; }
.help-table td:first-child { color: var(--white); font-weight: 600; white-space: nowrap; }

/* â•â•â• RESPONSIVE â•â•â• */
@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: -280px;
    top: 0;
    height: 100%;
    transition: left 0.25s ease;
    z-index: 100;
    width: 260px;
    min-width: 260px;
  }
  .sidebar.open { left: 0; }
  .hamburger { display: block; }
  .entry-grid { grid-template-columns: 1fr; }
  .region-grid { grid-template-columns: repeat(2, 1fr); }
  .date-row { grid-template-columns: 1fr; }
  .section-wrap { padding: 20px 16px; }
  .output-content { padding: 16px; }
  .help-wrap { padding: 20px 16px; }
  .topbar { padding: 12px 16px; }
  .start-screen { padding: 32px 16px; }
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="wordmark">The <span>Contrarian</span></div>
      <div class="wordmark-rule"></div>
      <div class="tagline">by Food Game Media</div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">Start</div>
      <button class="nav-btn active" data-panel="start" onclick="switchPanel('start',this)">
        <span class="nav-icon">âš¡</span> New Piece
      </button>

      <div class="nav-section">Write</div>
      <button class="nav-btn" data-panel="compose" onclick="switchPanel('compose',this)">
        <span class="nav-icon">âœï¸</span> Compose Brief
      </button>
      <button class="nav-btn" data-panel="sources" onclick="switchPanel('sources',this)">
        <span class="nav-icon">ğŸ“š</span> Review Sources
      </button>
      <button class="nav-btn" data-panel="output" onclick="switchPanel('output',this)">
        <span class="nav-icon">ğŸ“„</span> Output
      </button>

      <div class="nav-section">Discover</div>
      <button class="nav-btn" data-panel="intel" onclick="switchPanel('intel',this)">
        <span class="nav-icon">ğŸ”­</span> Topic Intelligence
      </button>
      <button class="nav-btn" data-panel="url" onclick="switchPanel('url',this)">
        <span class="nav-icon">ğŸ”—</span> Drop a Link
      </button>
      <button class="nav-btn" data-panel="social" onclick="switchPanel('social',this)">
        <span class="nav-icon">ğŸ’¬</span> Social Comment
      </button>

      <div class="nav-section">Library</div>
      <button class="nav-btn" data-panel="articles" onclick="switchPanel('articles',this); renderHistory();">
        <span class="nav-icon">ğŸ“</span> Articles
      </button>
      <button class="nav-btn" data-panel="help" onclick="switchPanel('help',this)">
        <span class="nav-icon">â“</span> Help & Guide
      </button>
    </nav>

    <div class="sidebar-footer">
      <div class="api-status-badge">
        <div class="api-dot"></div>
        Claude Sonnet 4.6 Â· Live
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
      <div class="topbar-title" id="topbarTitle">New Piece</div>
      <div class="topbar-right">
        <div id="localModeBadge" style="display:none;align-items:center;gap:5px;font-size:10px;font-weight:600;color:#f59e0b;background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.25);padding:4px 10px;border-radius:20px;letter-spacing:0.5px;">âš¡ LOCAL MODE</div>
        <button class="btn btn-ghost" onclick="testConnection()">ğŸ”Œ Test</button>
      </div>
    </div>

    
    <div class="status-bar" id="statusBar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText"></span>
    </div>

    <div class="content">

      <!-- â•â•â• START SCREEN â•â•â• -->
      <div class="panel active" id="panel-start">
        <div class="start-screen">
          <div class="start-headline">
            <div class="overline">Food Game Media</div>
            <h1>The argument<br><em>nobody's making.</em></h1>
            <p>Research-to-writing intelligence for Australian hospitality. Pick your starting point.</p>
          </div>

          <div class="entry-grid">
            <div class="entry-card" style="--card-accent:#f4a7b9;" onclick="switchPanel('intel', document.querySelector('[data-panel=intel]'))">
              <span class="card-icon">ğŸ”­</span>
              <div class="card-title">Find a Topic</div>
              <div class="card-desc">Discover what's trending today â€” globally or by region. Or search a specific topic and find the 10 best articles around it.</div>
              <div class="card-action">Explore trends â†’</div>
            </div>

            <div class="entry-card" style="--card-accent:#e91e8c;" onclick="switchPanel('url', document.querySelector('[data-panel=url]'))">
              <span class="card-icon">ğŸ”—</span>
              <div class="card-title">Drop a Link</div>
              <div class="card-desc">Found an article? Paste the URL and jump straight to writing. Add multiple links to synthesise a combined commentary.</div>
              <div class="card-action">Drop URL â†’</div>
            </div>

            <div class="entry-card" style="--card-accent:#8a9ab5;" onclick="switchPanel('compose', document.querySelector('[data-panel=compose]'))">
              <span class="card-icon">âœï¸</span>
              <div class="card-title">Write from Scratch</div>
              <div class="card-desc">Have a topic or angle in mind? Go straight to the brief, set your search queries, and let the engine find sources.</div>
              <div class="card-action">Start writing â†’</div>
            </div>
          </div>

          <div style="text-align:center;">
            <div style="font-size:11px;color:rgba(138,154,181,0.4);letter-spacing:1px;text-transform:uppercase;">or load from</div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
              <button class="btn btn-ghost" onclick="switchPanel('articles',document.querySelector('[data-panel=history]'));renderHistory();">ğŸ“ Articles</button>
              <button class="btn btn-ghost" onclick="document.getElementById('importFileInput').click()">ğŸ“¤ Import File</button>
              <input type="file" id="importFileInput" accept=".html,.htm" style="display:none;" onchange="handleImport(event)">
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• COMPOSE BRIEF â•â•â• -->
      <div class="panel" id="panel-compose">
        <div class="section-wrap">
          <div class="section-header">
            <div>
              <div class="section-title">Compose Brief</div>
              <div class="section-subtitle">Define your topic, angle, and direction</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Topic or Angle <span>â€” be specific. The sharper the angle, the better the output.</span></label>
            <input class="form-input" id="topicInput" placeholder="e.g. Why hospitality's obsession with 'experience' is killing profitability">
          </div>

          <div class="form-group">
            <label class="form-label">Additional Context <span>â€” optional. Data points, articles you've read, arguments you want to make.</span></label>
            <textarea class="form-textarea" id="contextInput" rows="3" placeholder="e.g. I read that 3 Melbourne venues closed last month citing 'customer experience costs' â€” I want to reframe this..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Search Queries <span>â€” one per line. Leave blank to auto-generate.</span></label>
            <textarea class="form-textarea" id="searchQueries" rows="4" placeholder="One query per line. Leave blank to auto-generate.&#10;e.g.&#10;hospitality experience economy Australia&#10;restaurant profitability vs customer experience"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Target Length</label>
            <div class="chips">
              <button class="chip" data-words="600" onclick="selectLength(this)">600w â€” Short</button>
              <button class="chip active" data-words="1000" onclick="selectLength(this)">1000w â€” Standard</button>
              <button class="chip" data-words="1400" onclick="selectLength(this)">1400w â€” Deep</button>
              <button class="chip" data-words="1800" onclick="selectLength(this)">1800w â€” Long</button>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" id="researchBtn" onclick="runResearch()">ğŸ” Research Sources</button>
            <button class="btn btn-outline" id="directWriteBtn" onclick="directWrite()">âš¡ Skip to Write</button>
            <button class="btn btn-secondary" onclick="resetAll()">â†© Reset</button>
          </div>
        </div>
      </div>

      <!-- â•â•â• REVIEW SOURCES â•â•â• -->
      <div class="panel" id="panel-sources">
        <div class="section-wrap">
          <div class="section-header">
            <div>
              <div class="section-title">Review Sources</div>
              <div class="section-subtitle" id="sourcesCount">No sources yet</div>
            </div>
            <div class="btn-row">
              <button class="btn btn-ghost" onclick="selectAllSources()">All</button>
              <button class="btn btn-ghost" onclick="deselectAllSources()">None</button>
            </div>
          </div>

          <div id="sourcesList">
            <div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">Run Research first to find sources.</div>
          </div>

          <div class="divider"></div>

          <div class="btn-row">
            <button class="btn btn-primary" id="writeBtn" onclick="runWrite()" disabled>âœï¸ Write Piece</button>
            <button class="btn btn-secondary" onclick="switchPanel('compose',document.querySelector('[data-panel=compose]'))">â† Back</button>
          </div>
        </div>
      </div>

      <!-- â•â•â• OUTPUT â•â•â• -->
      <div class="panel" id="panel-output">
        <div class="output-tabs">
          <button class="output-tab active" onclick="switchOutputTab('preview',this)">Preview</button>
          <button class="output-tab" onclick="switchOutputTab('raw',this)">Raw Text</button>
          <button class="output-tab" onclick="switchOutputTab('html',this)">HTML</button>
        </div>

        <div class="status-bar" id="outputStatus" style="display:none;">
          <div class="status-dot" id="outputStatusDot"></div>
          <span id="outputStatusText"></span>
        </div>

        <div class="output-content">
          <div id="tabPreview">
            <div class="form-group" id="headlineGroup" style="display:none;margin-bottom:16px;">
              <label class="form-label">Headline <span>â€” edit before publishing</span></label>
              <input class="form-input" id="headlineInput" type="text" placeholder="Engine-generated headline..." oninput="updatePreviewHeadline()">
            </div>
            <div class="output-preview" id="outputPreview">
              <div style="padding:60px;text-align:center;color:#888;">Your piece will appear here.</div>
            </div>
          </div>
          <div id="tabRaw" style="display:none;">
            <pre class="output-raw" id="outputRaw"></pre>
          </div>
          <div id="tabHtml" style="display:none;">
            <pre class="output-html-code" id="outputHtml"></pre>
          </div>

          <div class="divider"></div>

          <div class="btn-row" style="flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="copyRawText()">ğŸ“‹ Copy Text</button>
            <button class="btn btn-secondary" onclick="copyHtml()">ğŸ“‹ Copy HTML</button>
            <button class="btn btn-secondary" onclick="downloadHtml()">â¬‡ï¸ Download</button>
            <button class="btn btn-secondary" onclick="saveToHistory()">ğŸ’¾ Save</button>
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="btn btn-outline" onclick="editBackToBrief()" title="Go back to the brief with this topic and sources loaded â€” tweak and regenerate">âœï¸ Edit Brief</button>
            <button class="btn btn-outline" onclick="newAngleSameSources()" title="Keep the sources, clear the angle â€” write a completely different piece">â†» New Angle</button>
            <button class="btn btn-ghost" onclick="switchPanel('start',document.querySelector('[data-panel=start]'))">â† New Piece</button>
          </div>

          <!-- REWRITE PANEL -->
          <div id="rewritePanel" style="display:none;margin-top:24px;border-top:1px solid var(--border);padding-top:20px;">
            <div style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey);margin-bottom:12px;">âœï¸ Rewrite</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;" id="toneChips">
              <button class="chip" onclick="selectTone(this,'punchier')">More punchy</button>
              <button class="chip" onclick="selectTone(this,'softer')">More sympathetic</button>
              <button class="chip" onclick="selectTone(this,'funnier')">Funnier</button>
              <button class="chip" onclick="selectTone(this,'sharper')">Sharper argument</button>
              <button class="chip" onclick="selectTone(this,'shorter')">Tighten it up</button>
              <button class="chip" onclick="selectTone(this,'longer')">Expand it</button>
              <button class="chip" onclick="selectTone(this,'opener')">Stronger opener</button>
              <button class="chip" onclick="selectTone(this,'closer')">Stronger closer</button>
            </div>
            <div class="form-group" style="margin-bottom:10px;">
              <input class="form-input" id="rewriteCustom" placeholder="Or describe what to change â€” e.g. 'add a specific example about coffee shops'" style="font-size:13px;">
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="runRewrite()" id="rewriteBtn">âœ¨ Rewrite</button>
              <button class="btn btn-ghost" onclick="undoRewrite()" id="undoRewriteBtn" style="display:none;">â†© Undo</button>
              <button class="btn btn-ghost" onclick="toggleRewrite()">Close</button>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn btn-ghost" onclick="toggleRewrite()" id="rewriteToggleBtn" style="display:none;width:100%;">âœï¸ Rewrite this piece</button>
          </div>
        </div>
      </div>

      <!-- â•â•â• TOPIC INTELLIGENCE â•â•â• -->
      <div class="panel" id="panel-intel">
        <div class="section-wrap">
          <div class="section-header">
            <div>
              <div class="section-title">Topic Intelligence</div>
              <div class="section-subtitle">Discover what's worth writing about</div>
            </div>
          </div>

          <div class="intel-mode-tabs">
            <button class="intel-tab active" data-mode="trending" onclick="switchIntelMode('trending',this)">ğŸ”¥ What's Trending</button>
            <button class="intel-tab" data-mode="search" onclick="switchIntelMode('search',this)">ğŸ” Search a Topic</button>
          </div>

          <!-- TRENDING MODE -->
          <div class="intel-tab-panel active" id="intel-trending">
            <div class="api-stub-notice">
              <strong>NewsData.io not yet connected.</strong> Trending search currently uses Claude web search â€” excellent coverage but without strict date filtering. Add your NewsData.io API key when ready to unlock precise date ranges and trending volume signals.
            </div>

            <div class="form-group">
              <label class="form-label">Region</label>
              <div class="region-grid">
                <button class="region-btn active" data-region="" onclick="selectRegion(this)">ğŸŒ Global</button>
                <button class="region-btn" data-region="au" onclick="selectRegion(this)">ğŸ‡¦ğŸ‡º Australian</button>
                <button class="region-btn" data-region="au,nz" onclick="selectRegion(this)">ğŸ‡¦ğŸ‡ºğŸ‡³ğŸ‡¿ ANZ</button>
                <button class="region-btn" data-region="au,nz,jp,kr,sg,my,id,th" onclick="selectRegion(this)">ğŸŒ Asia Pacific</button>
                <button class="region-btn" data-region="us" onclick="selectRegion(this)">ğŸ‡ºğŸ‡¸ USA</button>
                <button class="region-btn" data-region="gb,de,fr,it,es,nl" onclick="selectRegion(this)">ğŸ‡ªğŸ‡º Europe</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Time Period</label>
              <div class="chips">
                <button class="chip active" data-period="today" onclick="selectPeriod(this)">Today</button>
                <button class="chip" data-period="7days" onclick="selectPeriod(this)">Last 7 days</button>
                <button class="chip" data-period="30days" onclick="selectPeriod(this)">Last 30 days</button>
                <button class="chip" data-period="custom" onclick="selectPeriod(this);toggleTrendingCustomDates(true)">Custom range</button>
              </div>
              <div id="trendingCustomDates" style="display:none;margin-top:12px;">
                <div class="date-row">
                  <div>
                    <label class="form-label">From</label>
                    <input class="form-input" id="trendingDateFrom" type="date">
                  </div>
                  <div>
                    <label class="form-label">To</label>
                    <input class="form-input" id="trendingDateTo" type="date">
                  </div>
                </div>
              </div>
            </div>

            <button class="btn btn-primary" onclick="runTrending()" id="trendingBtn">ğŸ”¥ Find Trending Topics</button>
          </div>

          <!-- SEARCH MODE -->
          <div class="intel-tab-panel" id="intel-search">
            <div class="api-stub-notice">
              <strong>NewsData.io not yet connected.</strong> Topic search currently uses Claude web search. Add your NewsData.io and Guardian API keys when ready to unlock structured results from 87,000+ sources.
            </div>

            <div class="form-group">
              <label class="form-label">Topic or Keywords</label>
              <input class="form-input" id="intelTopicInput" placeholder="e.g. restaurant staff retention Australia">
            </div>

            <div class="date-row">
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">From Date <span>optional</span></label>
                <input class="form-input" id="intelDateFrom" type="date">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">To Date <span>optional</span></label>
                <input class="form-input" id="intelDateTo" type="date">
              </div>
            </div>

            <div class="form-group" style="margin-top:20px;">
              <label class="form-label">Region</label>
              <div class="region-grid">
                <button class="region-btn active" data-region="" onclick="selectSearchRegion(this)">ğŸŒ Global</button>
                <button class="region-btn" data-region="au" onclick="selectSearchRegion(this)">ğŸ‡¦ğŸ‡º Australian</button>
                <button class="region-btn" data-region="au,nz" onclick="selectSearchRegion(this)">ğŸ‡¦ğŸ‡ºğŸ‡³ğŸ‡¿ ANZ</button>
                <button class="region-btn" data-region="au,nz,jp,kr,sg,my,id,th" onclick="selectSearchRegion(this)">ğŸŒ Asia Pacific</button>
                <button class="region-btn" data-region="us" onclick="selectSearchRegion(this)">ğŸ‡ºğŸ‡¸ USA</button>
                <button class="region-btn" data-region="gb,de,fr,it,es,nl" onclick="selectSearchRegion(this)">ğŸ‡ªğŸ‡º Europe</button>
              </div>
            </div>

            <button class="btn btn-primary" onclick="runTopicSearch()" id="topicSearchBtn">ğŸ” Find Articles</button>
          </div>

          <!-- DIGEST RESULTS -->
          <div id="intelResults" style="display:none; margin-top:28px;">
            <div class="divider"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <div style="font-size:13px;font-weight:600;color:var(--white);" id="intelResultsTitle">Results</div>
              <div class="btn-row">
                <button class="btn btn-ghost" onclick="selectAllDigest()">Select All</button>
                <button class="btn btn-outline" id="synthesiseBtn" onclick="runSynthesis()" disabled>âš¡ Synthesise Selected</button>
              </div>
            </div>
            <div class="digest-list" id="digestList"></div>
          </div>

        </div>
      </div>

      <!-- â•â•â• DROP A LINK â•â•â• -->
      <div class="panel" id="panel-url">
        <div class="section-wrap">
          <div class="section-header">
            <div>
              <div class="section-title">Drop a Link</div>
              <div class="section-subtitle">Paste URLs or drop article text directly</div>
            </div>
          </div>

          <!-- Mode tabs -->
          <div class="intel-mode-tabs" style="margin-bottom:24px;">
            <button class="intel-tab active" onclick="switchUrlMode('url',this)">ğŸ”— Paste URL(s)</button>
            <button class="intel-tab" onclick="switchUrlMode('text',this)">ğŸ“‹ Paste Article Text</button>
          </div>

          <!-- URL MODE -->
          <div id="urlModeUrl">
            <div class="info-box">
              <strong>Single URL</strong> â€” engine fetches the article and pre-fills your brief.<br>
              <strong>Multiple URLs (2â€“5)</strong> â€” synthesises all articles into one combined piece.<br>
              <strong>Note:</strong> Some sites block automated fetching (paywalled, login-required, or bot-protected pages). If fetch fails, use <em>Paste Article Text</em> instead.
            </div>

            <div class="form-group">
              <label class="form-label">Paste a URL</label>
              <div style="display:flex;gap:8px;">
                <input class="form-input" id="urlInput" placeholder="https://..." style="flex:1;" onkeydown="if(event.key==='Enter')addUrl()">
                <button class="btn btn-outline" onclick="addUrl()">Add</button>
              </div>
            </div>

            <div id="urlList" class="url-list" style="display:none;"></div>

            <div id="urlSingleActions" style="display:none;">
              <div class="form-group" style="margin-bottom:12px;">
                <label class="form-label">Word Count</label>
                <div class="chips" id="urlWordChips">
                  <button class="chip" onclick="setUrlWords(450,this)">450</button>
                  <button class="chip" onclick="setUrlWords(600,this)">600</button>
                  <button class="chip active" onclick="setUrlWords(1000,this)">1000</button>
                  <button class="chip" onclick="setUrlWords(1200,this)">1200</button>
                  <button class="chip" onclick="setUrlWords(1500,this)">1500</button>
                </div>
              </div>
              <div class="btn-row">
                <button class="btn btn-primary" onclick="runUrlFetch()" id="urlSingleBtn">ğŸ”— Fetch Article</button>
                <button class="btn btn-outline" onclick="runUrlSynthesis()" id="urlSynthBtn" style="display:none;">âš¡ Multi-story Synthesis</button>
                <button class="btn btn-secondary" onclick="clearUrls()">Clear All</button>
              </div>
            </div>
          </div>

          <!-- TEXT MODE -->
          <div id="urlModeText" style="display:none;">
            <div class="info-box">
              <strong>Can't fetch the URL?</strong> Open the article in your browser, select all the text, copy it, and paste it here. Works with paywalled articles, LinkedIn posts, PDFs you've read â€” anything you can copy.<br><br>
              Add a source URL below so it can be cited in the piece.
            </div>

            <div class="form-group">
              <label class="form-label">Article Text <span>â€” paste the full article content here</span></label>
              <textarea class="form-textarea" id="pasteTextInput" rows="10" placeholder="Paste the article text here..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Source URL <span>â€” optional, for citation</span></label>
              <input class="form-input" id="pasteUrlInput" placeholder="https://...">
            </div>

            <div class="form-group">
              <label class="form-label">Source Title <span>â€” optional</span></label>
              <input class="form-input" id="pasteTitleInput" placeholder="e.g. The Guardian â€” Why restaurants are failing...">
            </div>

            <div class="form-group" style="margin-bottom:12px;">
              <label class="form-label">Word Count</label>
              <div class="chips" id="textWordChips">
                <button class="chip" onclick="setTextWords(600,this)">600</button>
                <button class="chip active" onclick="setTextWords(1000,this)">1000</button>
                <button class="chip" onclick="setTextWords(1200,this)">1200</button>
                <button class="chip" onclick="setTextWords(1500,this)">1500</button>
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="runTextBrief()">âœï¸ Build Brief from Text</button>
              <button class="btn btn-outline" onclick="runTextDirect()">âš¡ Write Directly</button>
              <button class="btn btn-secondary" onclick="clearPasteText()">Clear</button>
            </div>
          </div>

        </div>
      </div>

      <!-- â•â•â• SOCIAL COMMENT â•â•â• -->
      <div class="panel" id="panel-social">
        <div class="section-wrap">
          <div class="section-header">
            <div>
              <div class="section-title">Social Comment</div>
              <div class="section-subtitle">Generate a sharp LinkedIn comment in Rory's style</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Post or article you're responding to</label>
            <textarea class="form-textarea" id="socialInput" rows="5" placeholder="Paste the post, headline, or article excerpt you want to comment on..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Style <span>â€” pick one or describe your own below</span></label>
            <div class="chips" id="socialStyleChips">
              <button class="chip active" onclick="setSocialStyle(this,'counterintuitive')">Counterintuitive</button>
              <button class="chip" onclick="setSocialStyle(this,'question')">Provocative question</button>
              <button class="chip" onclick="setSocialStyle(this,'reframe')">Agree but reframe</button>
              <button class="chip" onclick="setSocialStyle(this,'pushback')">Respectful pushback</button>
              <button class="chip" onclick="setSocialStyle(this,'stat')">The stat nobody mentions</button>
            </div>
            <input class="form-input" id="socialCustomStyle" placeholder="Or describe your own â€” e.g. dry humour, devil's advocate, add an analogy, cite behavioural economics..." style="margin-top:10px;font-size:13px;" oninput="if(this.value.trim()){document.querySelectorAll('#socialStyleChips .chip').forEach(c=>c.classList.remove('active'));socialStyle='';}">
          </div>

          <div class="form-group">
            <label class="form-label">Length</label>
            <div class="chips" id="socialLengthChips">
              <button class="chip active" onclick="setSocialLength(this,1)">1 sentence</button>
              <button class="chip" onclick="setSocialLength(this,2)">2 sentences</button>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" onclick="runSocialComment()" id="socialBtn">ğŸ’¬ Generate Comment</button>
            <button class="btn btn-ghost" onclick="document.getElementById('socialInput').value='';document.getElementById('socialOutput').style.display='none'">Clear</button>
          </div>

          <!-- OUTPUT -->
          <div id="socialOutput" style="display:none;margin-top:24px;">
            <div style="border-top:1px solid var(--border);padding-top:20px;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                <label class="form-label" style="margin:0;">Generated Comment</label>
                <div class="btn-row">
                  <button class="btn btn-primary" onclick="copySocialComment()">ğŸ“‹ Copy</button>
                  <button class="btn btn-ghost" onclick="saveSocialComment()">ğŸ’¾ Save</button>
                  <button class="btn btn-ghost" onclick="runSocialComment()">â†» Regenerate</button>
                </div>
              </div>
              <div id="socialCommentText" style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;font-size:15px;line-height:1.8;color:var(--white);font-family:'DM Sans',sans-serif;"></div>
            </div>
          </div>
        </div>
      </div>

<!-- â•â•â• HISTORY â•â•â• -->
      <div class="panel" id="panel-articles">
        <div class="section-wrap">
          <div class="section-header">
            <div class="section-title">Articles</div>
          </div>
          <div id="historyList">
            <div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No saved articles yet.</div>
          </div>
        </div>
      </div>

      <!-- â•â•â• HELP â•â•â• -->
      <div class="panel" id="panel-help">
        <div class="help-wrap">
          <div class="help-section">
            <h3>What is The Contrarian?</h3>
            <p>The opinion engine for Food Game â€” research-to-writing intelligence that creates standalone pieces in a Rory Sutherland-inspired behavioural economics style, tailored for Australian hospitality. Where the Weekly Wrap tells you what happened, The Contrarian tells you what everyone's getting wrong about it.</p>
          </div>

          <div class="help-section">
            <h3>Three Ways to Start</h3>
            <ul>
              <li><strong>Find a Topic</strong> â€” Topic Intelligence discovers what's trending or searches a specific topic. Returns a ranked digest of 10 articles. Click any to write from it, or select multiple to synthesise.</li>
              <li><strong>Drop a Link</strong> â€” Paste one URL to fetch and pre-fill a brief. Add multiple URLs for a combined multi-story commentary.</li>
              <li><strong>Write from Scratch</strong> â€” Enter your topic and angle directly. Use auto-generated or custom search queries to find sources first, or skip straight to writing.</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>Topic Intelligence â€” API Setup</h3>
            <p>Currently running on Claude web search only. Two free news APIs will be added when ready:</p>
            <ul>
              <li><strong>NewsData.io</strong> â€” sign up at newsdata.io for free tier (200 req/day). Provides date-filtered results from 87,000+ sources.</li>
              <li><strong>The Guardian API</strong> â€” free forever with full article content. Register at open-platform.theguardian.com.</li>
            </ul>
            <p>Once you have keys, enter them in the API keys section (coming) and both layers activate automatically.</p>
          </div>

          <div class="help-section">
            <h3>The Voice</h3>
            <ul>
              <li><strong>Counterintuitive reframes</strong> â€” the opposite of a good idea can also be a good idea</li>
              <li><strong>Behavioural economics lens</strong> â€” why people actually do things, not why they say they do</li>
              <li><strong>Rich analogy</strong> â€” explaining hospitality problems through unexpected parallels</li>
              <li><strong>Conversational authority</strong> â€” casual tone, serious thinking. No jargon, no frameworks</li>
              <li><strong>Sign-off:</strong> â€” JB</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>Key URLs</h3>
            <table class="help-table">
              <tr><td>Engine</td><td>https://fgww-engine.netlify.app (separate app)</td></tr>
              <tr><td>GitHub repo</td><td>github.com/FoodGameMedia/fgww-engine</td></tr>
            </table>
          </div>

          <div class="help-section">
            <h3>Technical Notes</h3>
            <ul>
              <li>Uses Claude Sonnet 4.6 via Cloudflare proxy â€” same as FGWW engine</li>
              <li>15 second cooldown between API calls, 20 second retry on 429</li>
              <li>History saved to browser localStorage</li>
              <li>Works on desktop, iPad, and iPhone</li>
            </ul>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXY_URL = 'https://young-fog-3045fgww-proxy.julian-68d.workers.dev';
const PROXY_SECRET = 'foodgame2026';
const MODEL = 'claude-sonnet-4-20250514';
const COOLDOWN_MS = 15000;


let lastApiCallTime = 0;
let targetWords = 1000;
let collectedSources = [];
let currentPiece = { topic:'', context:'', raw:'', html:'', sources:[] };
let addedUrls = [];
let selectedRegion = '';
let selectedSearchRegion = '';
let selectedPeriod = 'today';
let digestItems = [];
let intelMode = 'trending';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RORY_VOICE = `
IMPORTANT: Begin your response with a headline on the very first line, prefixed with "HEADLINE: ". Then a blank line, then the piece body. Do not use # markdown for the headline â€” just the HEADLINE: prefix.

Example format:
HEADLINE: Why Your Loyalty Program Is Making Customers Like You Less

The first paragraph of the piece...

You write for The Contrarian by Food Game â€” the opinion column that challenges what the Australian hospitality industry accepts as true. Your style is Rory Sutherland applied to hospitality.

VOICE & TONE:
- Conversational authority. You sound like the smartest person at the dinner party who also happens to run venues.
- Counterintuitive reframes are your signature move. If the obvious answer is X, explore why not-X might be more interesting.
- Rich analogy and metaphor. Explain hospitality through unexpected parallels â€” evolutionary biology, poker strategy, behavioural economics, urban planning, military logistics.
- No jargon. No frameworks. No bullet points within the piece. No subheadings. Write in flowing prose with paragraph breaks.
- Casual register, serious thinking. You can be funny but never flippant. Every joke carries a point.
- Write with the confidence of someone who has seen the same pattern a thousand times and finally understands why it keeps repeating.

STRUCTURE:
- Open with a provocative observation, paradox, or counterintuitive claim. Hook in the first two sentences.
- Build the argument through a series of connected insights, each one surprising. Not a linear march but a winding path that arrives somewhere unexpected.
- Use specific examples, data, and real situations from the source material. Cite source URLs naturally in the text as hyperlinks.
- Close with a practical provocation â€” something an operator will think about differently after reading.
- No summarising conclusion. End on a thought that keeps working after the reader finishes.

RULES:
- Never say "in conclusion", "to summarise", "key takeaways", or "in other words"
- Never use the phrase "it's worth noting" or "interestingly"
- Never use bullet points or numbered lists in the piece
- Never hedge with "arguably" or "perhaps" â€” commit to the argument
- Always ground abstract ideas in concrete hospitality examples
- Treat the reader as intelligent and experienced. Do not explain basic concepts.
- Sign off as "â€” JB" at the end
`.trim();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPanel(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  if (el) el.classList.add('active');
  const titles = {
    start:'New Piece', compose:'Compose Brief', sources:'Review Sources',
    output:'Output', intel:'Topic Intelligence', url:'Drop a Link',
    history:'Articles', help:'Help & Guide'
  };
  document.getElementById('topbarTitle').textContent = titles[id] || '';
  closeSidebar();
}

function toggleTrendingCustomDates(show) {
  document.getElementById('trendingCustomDates').style.display = show ? 'block' : 'none';
}

function switchUrlMode(mode, el) {
  document.querySelectorAll('#panel-url .intel-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('urlModeUrl').style.display = mode === 'url' ? 'block' : 'none';
  document.getElementById('urlModeText').style.display = mode === 'text' ? 'block' : 'none';
}

function clearPasteText() {
  document.getElementById('pasteTextInput').value = '';
  document.getElementById('pasteUrlInput').value = '';
  document.getElementById('pasteTitleInput').value = '';
}

async function runTextBrief() {
  const text = document.getElementById('pasteTextInput').value.trim();
  if (!text) { showToast('âš ï¸ Paste some article text first'); return; }

  const sourceUrl = document.getElementById('pasteUrlInput').value.trim();
  const sourceTitle = document.getElementById('pasteTitleInput').value.trim();

  setStatus('statusBar','statusDot','statusText','working','Analysing article text...');

  try {
    const result = await callClaude(
      'You are a research analyst. Extract key information from article text. Return ONLY JSON: {"title":"...","summary":"...","key_points":["...","...","..."],"contrarian_angle":"..."}',
      `Analyse this article and extract key information for a Contrarian piece on Australian hospitality:\n\n${text.substring(0, 8000)}\n\n${sourceUrl ? 'Source URL: ' + sourceUrl : ''}`,
      false
    );

    const data = parseJSON(result);
    document.getElementById('topicInput').value = sourceTitle || data.title || 'Article analysis';
    document.getElementById('contextInput').value = [
      data.contrarian_angle ? `Contrarian angle: ${data.contrarian_angle}` : '',
      data.summary ? `Summary: ${data.summary}` : '',
      sourceUrl ? `Source: ${sourceUrl}` : ''
    ].filter(Boolean).join('\n\n');
    document.getElementById('searchQueries').value = '';

    collectedSources = [{
      id: 0,
      title: sourceTitle || data.title || 'Pasted article',
      url: sourceUrl || '',
      snippet: data.summary || text.substring(0, 200) + '...',
      selected: true
    }];

    switchPanel('compose', document.querySelector('[data-panel=compose]'));
    setStatus('statusBar','statusDot','statusText','done','Brief pre-filled from article text');
    showToast('âœ… Brief ready â€” review and write');

  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }
}

async function runTextDirect() {
  const text = document.getElementById('pasteTextInput').value.trim();
  if (!text) { showToast('âš ï¸ Paste some article text first'); return; }

  const sourceUrl = document.getElementById('pasteUrlInput').value.trim();
  const sourceTitle = document.getElementById('pasteTitleInput').value.trim();

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Writing from article text...');
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Writing...</div>';

  try {
    const piece = await callClaude(
      RORY_VOICE,
      `Write a Contrarian opinion piece of approximately ${targetWords} words based on this source material.

SOURCE: ${sourceTitle || 'Article'}
${sourceUrl ? 'URL: ' + sourceUrl : ''}

ARTICLE CONTENT:
${text.substring(0, 8000)}

Write the piece now. Find the counterintuitive angle. ${sourceUrl ? 'Cite the source as a markdown hyperlink [text](' + sourceUrl + ') where you reference specific information.' : ''}`,
      false
    );

    const topic = sourceTitle || 'From article text';
    const srcList = [{ title: sourceTitle || 'Pasted article', url: sourceUrl || '', snippet: '' }];
    const extracted3 = extractHeadline(piece);
    currentPiece = {
      topic, context: sourceUrl || '',
      raw: piece,
      body: extracted3.body,
      headline: extracted3.headline || topic,
      html: renderPieceHTML(extracted3.body, extracted3.headline || topic, srcList),
      sources: srcList,
      date: new Date().toISOString(),
      words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = extracted3.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done Â· ~${countWords(piece)} words`);

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

function selectLength(el) {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  targetWords = parseInt(el.dataset.words);
}

function switchOutputTab(tab, el) {
  document.querySelectorAll('.output-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tabPreview').style.display = tab === 'preview' ? 'block' : 'none';
  document.getElementById('tabRaw').style.display = tab === 'raw' ? 'block' : 'none';
  document.getElementById('tabHtml').style.display = tab === 'html' ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTEL MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchIntelMode(mode, el) {
  document.querySelectorAll('.intel-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.intel-tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('intel-' + mode).classList.add('active');
  intelMode = mode;
  document.getElementById('intelResults').style.display = 'none';
}

function selectRegion(el) {
  document.querySelectorAll('#intel-trending .region-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedRegion = el.dataset.region;
}

function selectSearchRegion(el) {
  document.querySelectorAll('#intel-search .region-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedSearchRegion = el.dataset.region;
}

function selectPeriod(el) {
  document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedPeriod = el.dataset.period;
  if (selectedPeriod !== 'custom') {
    toggleTrendingCustomDates(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(barId, dotId, textId, state, msg) {
  const bar = document.getElementById(barId);
  const dot = document.getElementById(dotId);
  const txt = document.getElementById(textId);
  bar.style.display = 'flex';
  dot.className = 'status-dot ' + state;
  txt.textContent = msg;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function waitForRateLimit() {
  const elapsed = Date.now() - lastApiCallTime;
  if (elapsed < COOLDOWN_MS) {
    const wait = COOLDOWN_MS - elapsed;
    const secs = Math.ceil(wait / 1000);
    return new Promise(resolve => {
      let remaining = secs;
      const interval = setInterval(() => {
        remaining--;
        if (remaining <= 0) { clearInterval(interval); resolve(); }
      }, 1000);
    });
  }
}

async function callClaude(systemPrompt, userPrompt, useSearch = false, retries = 2) {
  await waitForRateLimit();
  lastApiCallTime = Date.now();

  const tools = useSearch ? [{ type: 'web_search_20250305', name: 'web_search' }] : undefined;

  console.log('[Contrarian] Calling API...', { model: MODEL, useSearch, promptLen: userPrompt.length });

  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      lastApiCallTime = Date.now();
      const response = await fetch(PROXY_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-FGWW-Auth': PROXY_SECRET
        },
        body: JSON.stringify(Object.assign({
          model: MODEL,
          max_tokens: 8000,
          system: systemPrompt,
          messages: [{ role: 'user', content: userPrompt }]
        }, tools ? { tools: tools } : {}))
      });

      console.log('[Contrarian] Response status:', response.status);

      if (response.status === 429 && attempt < retries) {
        await new Promise(r => setTimeout(r, 20000));
        continue;
      }

      if (!response.ok) {
        const errBody = await response.text();
        console.error('[Contrarian] API error body:', errBody);
        throw new Error('API error ' + response.status + ': ' + errBody.substring(0, 200));
      }

      const data = await response.json();
      console.log('[Contrarian] Response blocks:', data.content?.length);

      const text = (data.content || [])
        .filter(b => b.type === 'text')
        .map(b => b.text)
        .join('\n')
        .replace(/<\/?cite[^>]*>/g, '');

      if (!text) throw new Error('No text returned from API');
      return text;

    } catch(err) {
      console.error('[Contrarian] Error:', err);
      if (attempt === retries) throw err;
    }
  }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRENDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runTrending() {
  const btn = document.getElementById('trendingBtn');
  btn.disabled = true;
  setStatus('statusBar','statusDot','statusText','working','Finding trending topics...');

  const periodLabels = { today:'today', '7days':'this past week', '30days':'this past month' };
  let periodLabel;
  if (selectedPeriod === 'custom') {
    const from = document.getElementById('trendingDateFrom').value;
    const to = document.getElementById('trendingDateTo').value;
    if (!from || !to) { showToast('âš ï¸ Set both From and To dates'); btn.disabled = false; return; }
    periodLabel = `from ${from} to ${to}`;
  } else {
    periodLabel = periodLabels[selectedPeriod] || 'recently';
  }
  const regionLabel = selectedRegion || 'globally';

  try {
    const result = await callClaude(
      `You are a news intelligence analyst for The Contrarian by Food Game â€” an Australian hospitality opinion publication. Your job is to find the 10 most interesting, significant, or surprising news stories and topics from ${periodLabel} that would make compelling Contrarian opinion pieces.

You MUST search the web. Find real, current articles. For each result return:
- title: compelling headline
- url: the actual article URL
- source: publication name
- angle: 1-2 sentence Contrarian angle â€” what's the counterintuitive argument hidden in this story?
- why: why this is interesting for Australian hospitality operators

Return ONLY a JSON array of exactly 10 objects: [{"title":"...","url":"...","source":"...","angle":"...","why":"..."}]
No other text. No markdown. Just the JSON array.`,
      `Find the 10 most interesting trending stories from ${periodLabel} ${selectedRegion ? 'in these regions: ' + selectedRegion : 'globally'}. 

Focus on topics with Contrarian potential â€” stories where the obvious interpretation misses something important, where conventional wisdom is being challenged, or where something surprising is happening that hospitality operators should know about. Topics can span business, economics, consumer behaviour, technology, food, labour markets, or anything with hospitality relevance.`,
      true
    );

    let items = parseJSON(result);
    if (!Array.isArray(items) || items.length === 0) throw new Error('No results found');

    digestItems = items.map((item, i) => ({ ...item, id: i, selected: false }));
    renderDigest(`ğŸ”¥ Trending ${periodLabel} Â· ${selectedRegion ? regionLabel : 'Global'}`);

  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }

  btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOPIC SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runTopicSearch() {
  const topic = document.getElementById('intelTopicInput').value.trim();
  if (!topic) { showToast('âš ï¸ Enter a topic first'); return; }

  const btn = document.getElementById('topicSearchBtn');
  btn.disabled = true;
  setStatus('statusBar','statusDot','statusText','working','Searching for articles...');

  const dateFrom = document.getElementById('intelDateFrom').value;
  const dateTo = document.getElementById('intelDateTo').value;
  const dateRange = dateFrom ? `from ${dateFrom}${dateTo ? ' to ' + dateTo : ''}` : 'recent';

  try {
    const result = await callClaude(
      `You are a research analyst for The Contrarian by Food Game. Find the 10 best articles on a specific topic. Return ONLY a JSON array: [{"title":"...","url":"...","source":"...","angle":"...","why":"..."}]. No other text.`,
      `Find the 10 best articles about: "${topic}"
${dateRange !== 'recent' ? 'Date range: ' + dateRange : ''}
${selectedSearchRegion ? 'Prefer sources from: ' + selectedSearchRegion : ''}

For each article find: the actual URL, source publication, and write a 1-2 sentence Contrarian angle â€” what counterintuitive argument does this story enable? Return JSON array only.`,
      true
    );

    let items = parseJSON(result);
    if (!Array.isArray(items) || items.length === 0) throw new Error('No results found');

    digestItems = items.map((item, i) => ({ ...item, id: i, selected: false }));
    renderDigest(`ğŸ” "${topic}" Â· ${dateRange}`);
    setStatus('statusBar','statusDot','statusText','done', `Found ${items.length} articles`);

  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }

  btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIGEST RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDigest(title) {
  document.getElementById('intelResults').style.display = 'block';
  document.getElementById('intelResultsTitle').textContent = title;

  const list = document.getElementById('digestList');
  list.innerHTML = digestItems.map((item, i) => `
    <div class="digest-card ${item.selected ? 'selected' : ''}" id="digest-${item.id}">
      <div class="digest-rank">#${i+1}</div>
      <div class="digest-source-tag">${escapeHtml(item.source || 'Source')}</div>
      <div class="digest-title">${escapeHtml(item.title || 'Untitled')}</div>
      <div class="digest-angle">"${escapeHtml(item.angle || '')}"</div>
      <div class="digest-url">${escapeHtml(item.url || '')}</div>
      <div class="digest-actions">
        <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;" onclick="writeFromDigest(${item.id})">âœï¸ Write this</button>
        <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;" onclick="toggleDigestSelect(${item.id})">${item.selected ? 'âœ“ Selected' : '+ Select'}</button>
        <a href="${escapeHtml(item.url||'#')}" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:11px;padding:6px 12px;text-decoration:none;">â†— Open</a>
      </div>
    </div>
  `).join('');

  updateSynthesiseBtn();
  setStatus('statusBar','statusDot','statusText','done', `${digestItems.length} articles found â€” click any to write, or select multiple to synthesise`);
}

function toggleDigestSelect(id) {
  const item = digestItems.find(d => d.id === id);
  if (!item) return;
  item.selected = !item.selected;
  const card = document.getElementById('digest-' + id);
  if (card) card.classList.toggle('selected', item.selected);
  updateSynthesiseBtn();
  renderDigest(document.getElementById('intelResultsTitle').textContent);
}

function selectAllDigest() {
  digestItems.forEach(d => d.selected = true);
  renderDigest(document.getElementById('intelResultsTitle').textContent);
}

function updateSynthesiseBtn() {
  const selected = digestItems.filter(d => d.selected).length;
  const btn = document.getElementById('synthesiseBtn');
  btn.disabled = selected < 2;
  btn.textContent = selected >= 2 ? `âš¡ Synthesise ${selected} Selected` : 'âš¡ Synthesise Selected';
}

function writeFromDigest(id) {
  const item = digestItems.find(d => d.id === id);
  if (!item) return;
  document.getElementById('topicInput').value = item.title || '';
  document.getElementById('contextInput').value = item.angle ? `Contrarian angle: ${item.angle}\n\nSource: ${item.url}` : item.url || '';
  document.getElementById('searchQueries').value = '';
  switchPanel('compose', document.querySelector('[data-panel=compose]'));
  showToast('Brief pre-filled from digest');
}

async function runSynthesis() {
  const selected = digestItems.filter(d => d.selected);
  if (selected.length < 2) { showToast('âš ï¸ Select at least 2 articles'); return; }

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working',`Synthesising ${selected.length} stories...`);
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Finding the thread across all stories...</div>';

  try {
    const storiesText = selected.map((s, i) =>
      `Story ${i+1}: ${s.title}\nSource: ${s.source}\nURL: ${s.url}\nContrarian angle: ${s.angle}`
    ).join('\n\n');

    const topic = `The hidden pattern connecting: ${selected.map(s => s.title).join(' / ')}`;

    const piece = await callClaude(
      RORY_VOICE,
      `Write a Contrarian opinion piece of approximately ${targetWords} words that synthesises these ${selected.length} stories into a single, unified argument.

The piece should NOT cover each story separately. Instead, find the ONE underlying pattern, tension, or insight that connects all of them, then build a single compelling argument from that thread.

SOURCE STORIES:
${storiesText}

Write the piece now. Make a single bold argument. Cite source URLs as markdown hyperlinks [text](url) where relevant.`,
      false
    );

    const synthSources = selected.map(s => ({ title: s.title, url: s.url, snippet: s.angle }));
    const extracted4 = extractHeadline(piece);
    currentPiece = {
      topic,
      context: `Synthesised from ${selected.length} stories`,
      raw: piece,
      body: extracted4.body,
      headline: extracted4.headline || `The Pattern Nobody's Seeing`,
      html: renderPieceHTML(extracted4.body, extracted4.headline || `The Pattern Nobody's Seeing`, synthSources),
      sources: synthSources,
      date: new Date().toISOString(),
      words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = piece;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done Â· ~${countWords(piece)} words`);

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addUrl() {
  const input = document.getElementById('urlInput');
  const url = input.value.trim();
  if (!url) return;
  if (!url.startsWith('http')) { showToast('âš ï¸ Please enter a valid URL starting with http'); return; }
  if (addedUrls.find(u => u.url === url)) { showToast('âš ï¸ URL already added'); return; }
  if (addedUrls.length >= 5) { showToast('âš ï¸ Maximum 5 URLs'); return; }

  addedUrls.push({ url, status: 'pending' });
  input.value = '';
  renderUrlList();
}

function removeUrl(idx) {
  addedUrls.splice(idx, 1);
  renderUrlList();
}

function clearUrls() {
  addedUrls = [];
  renderUrlList();
}

function renderUrlList() {
  const list = document.getElementById('urlList');
  const singleActions = document.getElementById('urlSingleActions');

  if (addedUrls.length === 0) {
    list.style.display = 'none';
    singleActions.style.display = 'none';
    return;
  }

  list.style.display = 'flex';
  singleActions.style.display = 'flex';

  // Update synth button label
  const synthBtn = document.getElementById('urlSynthBtn');
  if (synthBtn) {
    synthBtn.style.display = addedUrls.length >= 2 ? 'inline-flex' : 'none';
  }

  list.innerHTML = addedUrls.map((item, i) => `
    <div class="url-item">
      <div class="url-text">${escapeHtml(item.url)}</div>
      <div class="url-status">${item.status === 'fetched' ? 'âœ…' : item.status === 'error' ? 'âŒ' : 'â³'}</div>
      <button class="url-remove" onclick="removeUrl(${i})">Ã—</button>
    </div>
  `).join('');
}

async function runUrlFetch() {
  if (addedUrls.length === 0) { showToast('âš ï¸ Add at least one URL'); return; }

  const btn = document.getElementById('urlSingleBtn');
  btn.disabled = true;
  setStatus('statusBar','statusDot','statusText','working','Fetching article content...');

  try {
    const urlsText = addedUrls.map((u, i) => `URL ${i+1}: ${u.url}`).join('\n');
    const isSingle = addedUrls.length === 1;

    const result = await callClaude(
      `You are a research assistant. Fetch and read the provided URL(s). Extract key information. 

IMPORTANT: If a URL returns a paywall, login page, bot-block, or access error â€” say so clearly in the JSON with "access_error": true and "error_reason": "paywall" | "login_required" | "bot_blocked" | "not_found".

Return ONLY JSON:
${isSingle
  ? '{"title":"...","summary":"...","key_points":["..."],"contrarian_angle":"...","access_error":false}'
  : '{"combined_topic":"...","articles":[{"title":"...","summary":"...","url":"..."}],"connecting_theme":"...","contrarian_angle":"...","access_error":false}'
}`,
      `Fetch and read ${isSingle ? 'this article' : 'these articles'}:\n\n${urlsText}`,
      true
    );

    const data = parseJSON(result);

    // Check for access errors
    if (data.access_error) {
      const reason = {
        paywall: 'This article is behind a paywall. Use "Paste Article Text" instead â€” open the article, copy all the text, and paste it.',
        login_required: 'This page requires you to be logged in. Use "Paste Article Text" â€” copy the article content and paste it directly.',
        bot_blocked: 'This site is blocking automated access. Use "Paste Article Text" instead â€” copy the article text from your browser and paste it.',
        not_found: 'The URL returned a 404 or page not found error. Check the URL is correct.'
      }[data.error_reason] || 'Could not access this URL. Try "Paste Article Text" â€” copy the content from your browser and paste it directly.';

      setStatus('statusBar','statusDot','statusText','error', 'âš ï¸ ' + reason);
      addedUrls[0].status = 'error';
      renderUrlList();
      btn.disabled = false;
      return;
    }

    if (isSingle) {
      document.getElementById('topicInput').value = data.title || addedUrls[0].url;
      document.getElementById('contextInput').value = [
        data.contrarian_angle ? `Contrarian angle: ${data.contrarian_angle}` : '',
        data.summary ? `Summary: ${data.summary}` : '',
        `Source: ${addedUrls[0].url}`
      ].filter(Boolean).join('\n\n');
      document.getElementById('searchQueries').value = '';
      addedUrls[0].status = 'fetched';
      renderUrlList();
      switchPanel('compose', document.querySelector('[data-panel=compose]'));
      showToast('âœ… Brief pre-filled from article');
    } else {
      document.getElementById('topicInput').value = data.combined_topic || 'Multi-source synthesis';
      document.getElementById('contextInput').value = data.connecting_theme || '';
      collectedSources = (data.articles || addedUrls).map((a, i) => ({
        id: i,
        title: a.title || `Article ${i+1}`,
        url: a.url || addedUrls[i]?.url || '',
        snippet: a.summary || '',
        selected: true
      }));
      addedUrls.forEach(u => u.status = 'fetched');
      renderUrlList();
      renderSources();
      switchPanel('sources', document.querySelector('[data-panel=sources]'));
      showToast('âœ… Sources loaded â€” ready to write');
    }
    setStatus('statusBar','statusDot','statusText','done', isSingle ? 'Article fetched â€” brief ready' : 'Articles fetched â€” review sources');

  } catch(err) {
    const errMsg = err.message || '';
    let friendlyMsg = 'Fetch failed â€” ';
    if (errMsg.includes('403') || errMsg.includes('401')) {
      friendlyMsg += 'access denied (paywall or login required). Use "Paste Article Text" tab instead.';
    } else if (errMsg.includes('429')) {
      friendlyMsg += 'rate limited. Wait a moment and try again.';
    } else if (errMsg.includes('404')) {
      friendlyMsg += 'page not found. Check the URL is correct.';
    } else if (errMsg.includes('network') || errMsg.includes('fetch')) {
      friendlyMsg += 'network error. Check your internet connection.';
    } else {
      friendlyMsg += 'try "Paste Article Text" if the site blocks automated access.';
    }
    setStatus('statusBar','statusDot','statusText','error', friendlyMsg);
    addedUrls.forEach(u => u.status = 'error');
    renderUrlList();
  }

  btn.disabled = false;
}

async function runUrlSynthesis() {
  if (addedUrls.length < 2) { showToast('âš ï¸ Add at least 2 URLs for synthesis'); return; }

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working',`Fetching ${addedUrls.length} articles and synthesising...`);
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Reading all articles and finding the thread...</div>';

  try {
    const urlsText = addedUrls.map((u, i) => `Article ${i+1}: ${u.url}`).join('\n');

    const piece = await callClaude(
      RORY_VOICE,
      `Read these ${addedUrls.length} articles, then write a Contrarian opinion piece of approximately ${targetWords} words that synthesises them into a single, unified argument.

The piece should NOT summarise each article separately. Find the ONE underlying pattern or tension connecting all of them, then build a compelling argument from that thread.

URLs to read:
${urlsText}

Write the piece now. Cite the source URLs as markdown hyperlinks [text](url) where you reference specific information.`,
      true
    );

    const urlSources = addedUrls.map((u, i) => ({ title: `Article ${i+1}`, url: u.url, snippet: '' }));
    const extracted5 = extractHeadline(piece);
    currentPiece = {
      topic: `Synthesis: ${addedUrls.length} articles`,
      context: addedUrls.map(u => u.url).join('\n'),
      raw: piece,
      body: extracted5.body,
      headline: extracted5.headline || `The Pattern Nobody's Seeing`,
      html: renderPieceHTML(extracted5.body, extracted5.headline || `The Pattern Nobody's Seeing`, urlSources),
      sources: urlSources,
      date: new Date().toISOString(),
      words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = piece;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done Â· ~${countWords(piece)} words`);
    addedUrls.forEach(u => u.status = 'fetched');
    renderUrlList();

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runResearch() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { showToast('âš ï¸ Enter a topic first'); return; }

  let queries = document.getElementById('searchQueries').value.trim().split('\n').filter(q => q.trim());
  setStatus('statusBar','statusDot','statusText','working','Researching sources...');
  document.getElementById('researchBtn').disabled = true;

  try {
    if (queries.length === 0) {
      setStatus('statusBar','statusDot','statusText','working','Generating search queries...');
      const qResult = await callClaude(
        'You generate web search queries. Return ONLY a JSON array of 4-5 short search query strings. No other text.',
        `Generate search queries to research this topic for a Contrarian piece on Australian hospitality:\n\nTopic: ${topic}\n\nContext: ${document.getElementById('contextInput').value.trim() || 'None'}\n\nMix: industry-specific Australian hospitality, behavioural economics angles, relevant data/statistics.`,
        false
      );
      try { queries = JSON.parse(qResult.replace(/```json\s*/g,'').replace(/```/g,'').trim()); }
      catch(e) { queries = [topic + ' Australian hospitality', topic + ' behavioural economics']; }
      document.getElementById('searchQueries').value = queries.join('\n');
    }

    setStatus('statusBar','statusDot','statusText','working',`Searching ${queries.length} queries...`);
    const searchPrompt = queries.map((q,i) => `Query ${i+1}: "${q}"`).join('\n');

    const searchResult = await callClaude(
      `Research assistant. Search the web for each query. For each result extract: title, url, and a 2-3 sentence summary. Return ONLY a JSON array: [{"title":"...","url":"...","snippet":"..."}]. Return 6-10 results. No other text.`,
      `Search the web for these queries and compile results:\n\n${searchPrompt}\n\nContext: Contrarian piece about "${topic}" for Australian hospitality operators. Prioritise articles with data, specific examples, and surprising findings.`,
      true
    );

    let sources = [];
    try {
      sources = parseJSON(searchResult);
    } catch(e) {
      const match = searchResult.match(/\[[\s\S]*\]/);
      if (match) sources = JSON.parse(match[0]);
    }

    if (!Array.isArray(sources) || sources.length === 0) throw new Error('No sources found. Try different queries.');

    collectedSources = sources.map((s, i) => ({ ...s, selected: true, id: i }));
    renderSources();
    setStatus('statusBar','statusDot','statusText','done',`Found ${sources.length} sources`);
    switchPanel('sources', document.querySelector('[data-panel=sources]'));

  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }

  document.getElementById('researchBtn').disabled = false;
}

function renderSources() {
  const list = document.getElementById('sourcesList');
  if (collectedSources.length === 0) {
    list.innerHTML = '<div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No sources found.</div>';
    document.getElementById('sourcesCount').textContent = 'No sources';
    return;
  }

  list.innerHTML = collectedSources.map(s => `
    <div class="source-card">
      <label class="source-check">
        <input type="checkbox" ${s.selected ? 'checked' : ''} onchange="toggleSource(${s.id})">
        <div class="source-title">${escapeHtml(s.title || 'Untitled')}</div>
      </label>
      <div class="source-snippet">${escapeHtml(s.snippet || '')}</div>
      <a href="${escapeHtml(s.url || '#')}" target="_blank" rel="noopener" class="source-url">${escapeHtml(s.url || '')}</a>
    </div>
  `).join('');

  updateSourcesCount();
}

function toggleSource(id) {
  const s = collectedSources.find(s => s.id === id);
  if (s) s.selected = !s.selected;
  updateSourcesCount();
}

function selectAllSources() {
  collectedSources.forEach(s => s.selected = true);
  renderSources();
}

function deselectAllSources() {
  collectedSources.forEach(s => s.selected = false);
  renderSources();
}

function updateSourcesCount() {
  const selected = collectedSources.filter(s => s.selected).length;
  document.getElementById('sourcesCount').textContent = `${selected} of ${collectedSources.length} sources selected`;
  document.getElementById('writeBtn').disabled = selected === 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WRITE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runWrite() {
  const topic = document.getElementById('topicInput').value.trim();
  const context = document.getElementById('contextInput').value.trim();
  const selected = collectedSources.filter(s => s.selected);
  if (selected.length === 0) { showToast('âš ï¸ Select at least one source'); return; }

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Writing Contrarian piece...');
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Writing...</div>';

  try {
    const sourcesText = selected.map((s, i) =>
      `[Source ${i+1}] ${s.title}\nURL: ${s.url}\nSummary: ${s.snippet}`
    ).join('\n\n');

    const piece = await callClaude(
      RORY_VOICE,
      `Write a Contrarian opinion piece of approximately ${targetWords} words.

TOPIC: ${topic}
${context ? '\nADDITIONAL CONTEXT:\n' + context + '\n' : ''}
SOURCE MATERIAL (cite as markdown hyperlinks [text](url)):
${sourcesText}

Write the piece now. Flowing prose, paragraph breaks, no subheadings or bullet points.`,
      false
    );

    const extracted1 = extractHeadline(piece);
    currentPiece = {
      topic, context,
      raw: piece,
      body: extracted1.body,
      headline: extracted1.headline || topic,
      html: renderPieceHTML(extracted1.body, extracted1.headline || topic, selected),
      sources: selected,
      date: new Date().toISOString(),
      words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = extracted1.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done Â· ~${countWords(piece)} words`);

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

async function directWrite() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { showToast('âš ï¸ Enter a topic first'); return; }
  const context = document.getElementById('contextInput').value.trim();

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Researching and writing...');
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Searching and writing...</div>';

  try {
    const piece = await callClaude(
      RORY_VOICE,
      `Write a Contrarian opinion piece of approximately ${targetWords} words.

TOPIC: ${topic}
${context ? '\nCONTEXT:\n' + context + '\n' : ''}
Search the web for relevant sources. Then write the piece using what you find. Cite source URLs as markdown hyperlinks [text](url).`,
      true
    );

    const extracted2 = extractHeadline(piece);
    currentPiece = {
      topic, context,
      raw: piece,
      body: extracted2.body,
      headline: extracted2.headline || topic,
      html: renderPieceHTML(extracted2.body, extracted2.headline || topic, []),
      sources: [],
      date: new Date().toISOString(),
      words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = extracted2.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done Â· ~${countWords(piece)} words`);

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function extractHeadline(text) {
  const lines = text.split('\n');
  const headlineLine = lines.find(l => l.startsWith('HEADLINE:'));
  if (headlineLine) {
    const headline = headlineLine.replace('HEADLINE:', '').trim();
    const body = lines.filter(l => !l.startsWith('HEADLINE:')).join('\n').replace(/^\n+/, '');
    return { headline, body };
  }
  // Fallback - use first line if short enough
  const firstLine = lines[0].trim().replace(/^#+\s*/, '');
  if (firstLine.length < 120) {
    return { headline: firstLine, body: lines.slice(1).join('\n').replace(/^\n+/, '') };
  }
  return { headline: '', body: text };
}

function showHeadlineField(headline) {
  document.getElementById('headlineGroup').style.display = 'block';
  document.getElementById('headlineInput').value = headline;
}

function updatePreviewHeadline() {
  const headline = document.getElementById('headlineInput').value;
  if (currentPiece.raw) {
    currentPiece.headline = headline;
    currentPiece.html = renderPieceHTML(currentPiece.body || currentPiece.raw, headline, currentPiece.sources);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputHtml').textContent = currentPiece.html;
  }
}

function renderPieceHTML(markdown, headline, sources) {
  sources = sources || [];
  let html = escapeHtml(markdown)
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:#e91e8c;font-weight:600;">$1</a>');

  html = html.split(/\n\n+/).map(p => {
    p = p.trim();
    if (!p) return '';
    if (p.startsWith('# ') || p.startsWith('## ')) return '';
    if (p.startsWith('> ')) return `<div style="border-left:4px solid #f4a7b9;padding:14px 18px;margin:0 0 18px;background:rgba(233,30,140,0.05);border-radius:0 8px 8px 0;font-size:14px;line-height:1.75;color:#1a1a2e;font-style:italic;">${p.replace(/^> /, '')}</div>`;
    if (p === 'â€” JB') return `<p style="font-size:13px;color:#888;margin:0;font-style:italic;">â€” JB</p>`;
    p = p.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
    return `<p style="font-size:14px;line-height:1.85;color:#333;margin:0 0 16px;font-family:'DM Sans',Arial,sans-serif;">${p.replace(/\n/g, '<br>')}</p>`;
  }).join('');

  // Source attribution block
  const validSources = sources.filter(s => s && (s.title || s.url));
  const sourceBlock = validSources.length > 0 ? `
    <div style="margin-top:24px;padding-top:18px;border-top:1px solid #e8e0f0;">
      <div style="font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:#aaa;font-weight:700;margin-bottom:8px;">Source${validSources.length > 1 ? 's' : ''}</div>
      ${validSources.map(s => `<div style="font-size:12px;color:#777;line-height:1.6;margin-bottom:4px;">
        ${s.title ? `<span style="font-weight:600;color:#555;">${escapeHtml(s.title)}</span>` : ''}
        ${s.url ? `${s.title ? ' &middot; ' : ''}<a href="${s.url}" target="_blank" rel="noopener" style="color:#e91e8c;text-decoration:none;word-break:break-all;">${s.url}</a>` : ''}
      </div>`).join('')}
    </div>` : '';

  const today = new Date().toLocaleDateString('en-AU', {day:'numeric', month:'long', year:'numeric'});

  return `
<div style="font-family:'DM Sans',Arial,sans-serif;color:#1a1a2e;max-width:660px;margin:0 auto;">

  <!-- HEADER -->
  <div style="background:#0f1f38;padding:36px 44px 30px;text-align:center;border-radius:12px 12px 0 0;">
    <div style="font-size:8px;letter-spacing:4px;text-transform:uppercase;color:#f4a7b9;margin-bottom:12px;opacity:0.8;font-weight:600;">The Contrarian &middot; by Food Game Media</div>
    <div style="font-family:'Playfair Display',Georgia,serif;font-size:clamp(22px,3.5vw,32px);font-weight:900;color:#fff;line-height:1.15;font-style:italic;letter-spacing:-0.5px;">${escapeHtml(headline)}</div>
    <div style="width:48px;height:2px;background:linear-gradient(90deg,transparent,#f4a7b9,transparent);margin:18px auto 0;"></div>
    <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:12px;letter-spacing:0.3px;">${today}</div>
  </div>

  <!-- BODY -->
  <div style="background:#cdc8d9;padding:36px 44px 40px;">

    <!-- Article label -->
    <div style="margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid rgba(15,31,56,0.12);">
      <div style="display:inline-block;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;margin-bottom:0;">Opinion</div>
    </div>

    ${html}

    ${sourceBlock}
  </div>

  <!-- AUTHOR BIO -->
  <div style="background:#cdc8d9;padding:0 44px 32px;">
    <div style="background:#fce4ec;border-radius:10px;padding:28px 32px;">
      <div style="font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#e91e8c;font-weight:700;margin-bottom:18px;">About the Author</div>
      <table cellpadding="0" cellspacing="0" border="0" width="100%"><tr>
        <td style="width:122px;vertical-align:top;padding-right:22px;">
          <img src="data:image/jpeg;base64,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" alt="Julian Blok" style="width:100px;height:100px;border-radius:50%;border:3px solid #f4a7b9;display:block;">
        </td>
        <td style="vertical-align:top;">
          <div style="font-family:'Playfair Display',Georgia,serif;font-size:16px;color:#0f1f38;font-weight:700;margin-bottom:10px;">Julian Blok</div>
          <div style="font-size:12px;color:#444;line-height:1.8;margin-bottom:11px;">Contrarians are not born. They are assembled â€” slowly, accidentally, and usually at someone else's expense. A stint in European banking teaches you that confidence and correctness are not the same thing. Extensive travel teaches you that the obvious answer is mostly just the local one. A decade supplying hospitality businesses teaches you that the industry's most repeated problems are not bad luck â€” they are bad defaults, faithfully maintained.</div>
          <div style="font-size:12px;color:#444;line-height:1.8;">Julian Blok consults on behavioural insight and systems-led change for hospitality and business operators. <em>The Contrarian</em> is what happens when someone who has spent too long watching the same mistakes recur decides, rather belatedly, to say something about it.</div>
        </td>
      </tr></table>
    </div>
  </div>

  <!-- FOOTER -->
  <div style="background:#0f1f38;padding:20px 44px;text-align:center;border-radius:0 0 12px 12px;display:flex;align-items:center;justify-content:space-between;">
    <div style="font-family:'Playfair Display',Georgia,serif;font-size:13px;color:#f4a7b9;font-style:italic;font-weight:700;">The Contrarian</div>
    <div style="font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:2px;text-transform:uppercase;">Food Game Media</div>
  </div>

</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY & SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyRawText() {
  if (!currentPiece.raw) { showToast('âš ï¸ Nothing to copy'); return; }
  navigator.clipboard.writeText(currentPiece.raw).then(() => showToast('âœ… Text copied'));
}

function copyHtml() {
  if (!currentPiece.html) { showToast('âš ï¸ Nothing to copy'); return; }
  navigator.clipboard.writeText(currentPiece.html).then(() => showToast('âœ… HTML copied'));
}

function saveToHistory() {
  if (!currentPiece.raw) { showToast('âš ï¸ Nothing to save'); return; }
  const history = JSON.parse(localStorage.getItem('fgc_history') || '[]');
  const slug = buildPieceSlug();
  history.unshift({ ...currentPiece, saved: new Date().toISOString(), slug });
  if (history.length > 50) history.pop();
  localStorage.setItem('fgc_history', JSON.stringify(history));
  showToast('ğŸ’¾ Saved â€” ' + slug);
}


function buildPieceSlug(piece) {
  piece = piece || currentPiece;
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = String(d.getFullYear()).slice(2);
  const date = dd + '.' + mm + '.' + yy;
  const headline = (piece.headline || piece.topic || 'piece')
    .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').substring(0,40);
  const source = (piece.sources && piece.sources[0] && piece.sources[0].title)
    ? piece.sources[0].title.toLowerCase().replace(/[^a-z0-9 ]+/g,'').trim().replace(/\s+/g,'-').substring(0,20)
    : '';
  return [date, headline, source].filter(Boolean).join('_');
}

function downloadHtml() {
  if (!currentPiece.html) { showToast('âš ï¸ Nothing to download'); return; }
  const fullHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>The Contrarian â€” ${escapeHtml(currentPiece.topic)}</title><link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,700;0,900;1,700&display=swap" rel="stylesheet"></head><body style="margin:0;padding:40px 16px;background:#f0ede8;">${currentPiece.html}<!-- CONTRARIAN_DATA:${btoa(unescape(encodeURIComponent(JSON.stringify({topic:currentPiece.topic,context:currentPiece.context,raw:currentPiece.raw,sources:currentPiece.sources,date:currentPiece.date,words:currentPiece.words}))))}:END_CONTRARIAN --></body></html>`;
  const blob = new Blob([fullHtml], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = buildPieceSlug() + '.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('â¬‡ï¸ Downloaded');
}

async function testConnection() {
  setStatus('statusBar','statusDot','statusText','working','Testing connection...');
  document.getElementById('statusBar').style.display = 'flex';
  try {
    const response = await fetch(PROXY_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-FGWW-Auth': PROXY_SECRET
      },
      body: JSON.stringify({
        model: MODEL,
        max_tokens: 10,
        system: 'Reply with OK only.',
        messages: [{ role: 'user', content: 'Test' }]
      })
    });
    console.log('[Contrarian] Test response:', response.status);
    if (response.status === 429) {
      setStatus('statusBar','statusDot','statusText','error','Rate limited â€” wait a moment and try again.');
    } else if (response.ok) {
      setStatus('statusBar','statusDot','statusText','done','âœ… Connection OK â€” ready to go');
      lastApiCallTime = Date.now();
    } else {
      const errBody = await response.text();
      setStatus('statusBar','statusDot','statusText','error','Connection failed: ' + response.status + ' â€” ' + errBody.substring(0, 100));
    }
  } catch(err) {
    console.error('[Contrarian] Connection test error:', err);
    setStatus('statusBar','statusDot','statusText','error','Connection failed: ' + err.message);
  }
}

function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const html = e.target.result;
      const match = html.match(/CONTRARIAN_DATA:([\s\S]*?):END_CONTRARIAN/);
      if (!match) { showToast('âš ï¸ No Contrarian data found in this file'); return; }
      const data = JSON.parse(decodeURIComponent(escape(atob(match[1]))));
      currentPiece = {
        topic: data.topic || '',
        context: data.context || '',
        raw: data.raw || '',
        html: renderPieceHTML(data.raw || '', data.topic || ''),
        sources: data.sources || [],
        date: data.date || new Date().toISOString(),
        words: data.words || 1000
      };
      document.getElementById('outputPreview').innerHTML = currentPiece.html;
      document.getElementById('outputRaw').textContent = currentPiece.raw;
      document.getElementById('outputHtml').textContent = currentPiece.html;
      document.getElementById('tabPreview').style.display = 'block';
      switchPanel('output', document.querySelector('[data-panel=output]'));
      showToast('ğŸ“‚ Imported: ' + file.name);
    } catch(err) {
      showToast('âš ï¸ Could not read file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem('fgc_history') || '[]');
  const list = document.getElementById('historyList');
  if (history.length === 0) {
    list.innerHTML = '<div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No saved articles yet.</div>';
    return;
  }
  // Separate social comments from full pieces
  const social = history.filter(h => h.type === 'social');
  const pieces = history.filter(h => h.type !== 'social');

  let html = '';

  if (social.length > 0) {
    html += '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--grey);margin-bottom:10px;font-weight:600;">ğŸ’¬ Social Comments</div>';
    html += social.map((h, i) => {
      const realIdx = history.indexOf(h);
      const date = new Date(h.saved).toLocaleDateString('en-AU', {day:'numeric',month:'short',year:'numeric'});
      return `
      <div class="history-item" style="border-left:2px solid var(--pink);padding-left:14px;">
        <div style="font-size:11px;color:var(--pink-soft);font-weight:600;margin-bottom:4px;text-transform:capitalize;">${h.style || 'comment'}</div>
        <div class="history-title" style="font-size:13px;">${escapeHtml(h.raw)}</div>
        <div class="history-meta">${date} Â· ${h.words || 0} words</div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(${JSON.stringify(h.raw)}).then(()=>showToast('ğŸ“‹ Copied'))">ğŸ“‹ Copy</button>
          <button class="btn btn-ghost" onclick="deleteFromHistory(${realIdx})">Delete</button>
        </div>
      </div>`;
    }).join('');
  }

  if (pieces.length > 0) {
    if (social.length > 0) html += '<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--grey);margin:20px 0 10px;font-weight:600;">ğŸ“„ Full Pieces</div>';
    html += pieces.map((h, i) => {
      const realIdx = history.indexOf(h);
      const date = new Date(h.saved).toLocaleDateString('en-AU', {day:'numeric',month:'short',year:'numeric'});
      const displayName = h.slug || escapeHtml(h.headline || h.topic);
      return `
      <div class="history-item">
        <div class="history-title">${escapeHtml(displayName)}</div>
        <div class="history-meta">${date} Â· ~${countWords(h.raw)} words</div>
        <div class="btn-row">
          <button class="btn btn-ghost" onclick="loadFromHistory(${realIdx})">Load</button>
          <button class="btn btn-ghost" onclick="deleteFromHistory(${realIdx})">Delete</button>
        </div>
      </div>`;
    }).join('');
  }

  list.innerHTML = html;
}

function loadFromHistory(idx) {
  const history = JSON.parse(localStorage.getItem('fgc_history') || '[]');
  const h = history[idx];
  if (!h) return;
  currentPiece = { ...h };
  // Re-render HTML in case it was saved before the new renderer
  if (currentPiece.body || currentPiece.raw) {
    currentPiece.html = renderPieceHTML(currentPiece.body || currentPiece.raw, currentPiece.headline || currentPiece.topic, currentPiece.sources || []);
  }
  document.getElementById('outputPreview').innerHTML = currentPiece.html;
  document.getElementById('outputRaw').textContent = currentPiece.body || currentPiece.raw || '';
  document.getElementById('outputHtml').textContent = currentPiece.html;
  showHeadlineField(currentPiece.headline || currentPiece.topic || '');
  document.getElementById('rewriteToggleBtn').style.display = 'block';
  switchPanel('output', document.querySelector('[data-panel=output]'));
  showToast('ğŸ“‚ Loaded');
}

function deleteFromHistory(idx) {
  if (!confirm('Delete this piece?')) return;
  const history = JSON.parse(localStorage.getItem('fgc_history') || '[]');
  history.splice(idx, 1);
  localStorage.setItem('fgc_history', JSON.stringify(history));
  renderHistory();
  showToast('ğŸ—‘ï¸ Deleted');
}

function resetAll() {
  document.getElementById('topicInput').value = '';
  document.getElementById('contextInput').value = '';
  document.getElementById('searchQueries').value = '';
  collectedSources = [];
  currentPiece = { topic:'', context:'', raw:'', html:'', sources:[] };
  document.getElementById('headlineGroup').style.display = 'none';
  document.getElementById('headlineInput').value = '';
  showToast('â†© Reset');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseJSON(text) {
  text = text.replace(/```json\s*/g,'').replace(/```/g,'').trim();
  try { return JSON.parse(text); }
  catch(e) {
    const match = text.match(/\[[\s\S]*\]/);
    if (match) return JSON.parse(match[0]);
    throw e;
  }
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function countWords(s) {
  return (s || '').trim().split(/\s+/).filter(w => w.length > 0).length;
}

document.addEventListener('DOMContentLoaded', () => {
  renderHistory();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('intelDateTo').value = today;
  const weekAgo = new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0];
  document.getElementById('intelDateFrom').value = weekAgo;
  document.getElementById('trendingDateTo').value = today;
  document.getElementById('trendingDateFrom').value = weekAgo;
});
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT BACK & NEW ANGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function editBackToBrief() {
  if (!currentPiece.raw) { showToast('âš ï¸ No piece loaded'); return; }

  // Populate compose panel with current piece's topic, context, sources
  document.getElementById('topicInput').value = currentPiece.headline || currentPiece.topic || '';
  document.getElementById('contextInput').value = currentPiece.context || '';

  // Pre-fill search queries from source URLs if available
  if (currentPiece.sources && currentPiece.sources.length > 0) {
    const urls = currentPiece.sources.map(s => s.url).filter(Boolean);
    if (urls.length > 0) {
      document.getElementById('searchQueries').value = urls.join('\n');
    }
  }

  // Scroll to compose panel
  switchPanel('compose', document.querySelector('[data-panel=compose]'));
  showToast('âœï¸ Brief loaded â€” edit and regenerate');
}

function newAngleSameSources() {
  if (!currentPiece.raw) { showToast('âš ï¸ No piece loaded'); return; }

  // Save current sources
  const savedSources = currentPiece.sources || [];
  const savedContext = currentPiece.context || '';

  // Check which panel the sources came from
  const hasUrls = savedSources.some(s => s.url);

  if (hasUrls) {
    // Go to Drop a Link panel and pre-fill the URLs
    switchPanel('url', document.querySelector('[data-panel=url]'));
    // Re-populate addedUrls
    addedUrls = savedSources.filter(s => s.url).map(s => ({ url: s.url, title: s.title || '' }));
    renderUrlList();
    document.getElementById('urlSingleActions').style.display = 'block';
    if (addedUrls.length > 1) {
      document.getElementById('urlSynthBtn').style.display = 'inline-flex';
    }
    showToast('â†» Sources loaded â€” pick a new angle and write');
  } else {
    // Go to compose and pre-fill context only, clear topic
    document.getElementById('topicInput').value = '';
    document.getElementById('contextInput').value = savedContext;
    switchPanel('compose', document.querySelector('[data-panel=compose]'));
    showToast('â†» Context kept â€” write a new angle');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCIAL COMMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let socialStyle = 'counterintuitive';
let socialLength = 1;

function setSocialStyle(el, style) {
  document.querySelectorAll('#socialStyleChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  socialStyle = style;
}

function setSocialLength(el, len) {
  document.querySelectorAll('#socialLengthChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  socialLength = len;
}

async function runSocialComment() {
  const input = document.getElementById('socialInput').value.trim();
  const customStyleVal = document.getElementById('socialCustomStyle').value.trim();
  if (!input) { showToast('âš ï¸ Paste something to respond to'); return; }

  const btn = document.getElementById('socialBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Generating...';

  const styleInstructions = {
    counterintuitive: 'Write a counterintuitive observation that flips the conventional take on its head.',
    question: 'Write a single provocative question that challenges the assumption in the post.',
    reframe: 'Agree with the surface point but reframe it with a deeper, more interesting interpretation.',
    pushback: 'Respectfully push back on the premise with a specific alternative view.',
    stat: 'Introduce one surprising data point or overlooked fact that reframes the entire conversation.'
  };

  const lengthInstruction = socialLength === 1
    ? 'Write exactly ONE sentence. Maximum 25 words. It must be complete and punchy on its own.'
    : 'Write exactly TWO sentences. Maximum 40 words total. First sentence makes the point, second lands the punch.';

  const system = `You write LinkedIn comments in the style of Rory Sutherland â€” behavioural economist, contrarian, witty. 
Your comments are short, unexpected, and make people stop scrolling. 
No preamble. No "great post". No hashtags. No emojis. No sign-off.
Just the comment itself â€” nothing else.`;

  const prompt = `Post/article to respond to:
"${input}"

Style: ${styleInstructions[socialStyle]}

${lengthInstruction}

Write the comment now:`;

  try {
    const result = await callClaude(system, prompt, false, 1);
    const comment = result.trim().replace(/^["']|["']$/g, '');
    document.getElementById('socialCommentText').textContent = comment;
    document.getElementById('socialOutput').style.display = 'block';
    document.getElementById('socialOutput').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    // Store for saving
    window._lastSocialComment = {
      comment,
      source: input.substring(0, 120),
      style: socialStyle,
      date: new Date().toISOString()
    };
  } catch(err) {
    showToast('âŒ Failed: ' + err.message);
  }

  btn.disabled = false;
  btn.textContent = 'ğŸ’¬ Generate Comment';
}

function copySocialComment() {
  const text = document.getElementById('socialCommentText').textContent;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ Copied to clipboard'));
}

function saveSocialComment() {
  const data = window._lastSocialComment;
  if (!data || !data.comment) { showToast('âš ï¸ Nothing to save'); return; }
  const history = JSON.parse(localStorage.getItem('fgc_history') || '[]');
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = String(d.getFullYear()).slice(2);
  const slug = dd + '.' + mm + '.' + yy + '_social_' + data.style;
  history.unshift({
    type: 'social',
    slug,
    topic: 'Social: ' + data.source,
    raw: data.comment,
    body: data.comment,
    style: data.style,
    saved: data.date,
    words: data.comment.split(/\s+/).length
  });
  if (history.length > 50) history.pop();
  localStorage.setItem('fgc_history', JSON.stringify(history));
  showToast('ğŸ’¾ Saved to Articles');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REWRITE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedTone = '';
let previousPiece = null;

function setUrlWords(count, el) {
  targetWords = count;
  document.querySelectorAll('#urlWordChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function setTextWords(count, el) {
  targetWords = count;
  document.querySelectorAll('#textWordChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function toggleRewrite() {
  const panel = document.getElementById('rewritePanel');
  const toggleBtn = document.getElementById('rewriteToggleBtn');
  const visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : 'block';
  toggleBtn.style.display = visible ? 'block' : 'none';
}

function selectTone(el, tone) {
  document.querySelectorAll('#toneChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedTone = tone;
}

function undoRewrite() {
  if (!previousPiece) return;
  currentPiece = { ...previousPiece };
  showHeadlineField(currentPiece.headline || currentPiece.topic);
  document.getElementById('outputPreview').innerHTML = currentPiece.html;
  document.getElementById('outputRaw').textContent = currentPiece.body || currentPiece.raw;
  document.getElementById('outputHtml').textContent = currentPiece.html;
  document.getElementById('undoRewriteBtn').style.display = 'none';
  showToast('â†© Reverted to previous version');
}

async function runRewrite() {
  if (!currentPiece.raw) { showToast('âš ï¸ Nothing to rewrite'); return; }

  const custom = document.getElementById('rewriteCustom').value.trim();
  if (!selectedTone && !custom) { showToast('âš ï¸ Select a tone or describe what to change'); return; }

  const toneInstructions = {
    punchier: 'Make the writing punchier and more direct. Shorter sentences. More impact. Cut any waffle.',
    softer: 'Rewrite with more empathy and warmth toward operators. Acknowledge the difficulty of their position while maintaining the counterintuitive angle.',
    funnier: 'Add more wit and dry humour in the Rory Sutherland style. More absurdist analogies, more comic timing.',
    sharper: 'Sharpen the central argument. Make the logic tighter and more irrefutable. Remove any tangents.',
    shorter: 'Cut this piece by roughly a third. Keep the best lines, cut the rest. No padding.',
    longer: 'Expand this piece by roughly 30%. Add a specific real-world example or analogy to reinforce the argument.',
    opener: 'Rewrite only the opening paragraph to be more arresting and counterintuitive. Keep the rest.',
    closer: 'Rewrite only the closing paragraph to land harder. The final line should be memorable.'
  };

  const instruction = toneInstructions[selectedTone] || custom;

  const btn = document.getElementById('rewriteBtn');
  btn.disabled = true;
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Rewriting...');

  try {
    previousPiece = { ...currentPiece };

    const prompt = `Here is an existing Contrarian piece:

---
${currentPiece.body || currentPiece.raw}
---

Rewrite instruction: ${instruction}
${custom && selectedTone ? 'Additional notes: ' + custom : ''}

Return the full rewritten piece. Start with HEADLINE: on the first line (you may keep or improve the original headline: "${currentPiece.headline || currentPiece.topic}").`;

    const piece = await callClaude(RORY_VOICE, prompt, false);
    const extracted = extractHeadline(piece);

    currentPiece = {
      ...currentPiece,
      raw: piece,
      body: extracted.body,
      headline: extracted.headline || currentPiece.headline,
      html: renderPieceHTML(extracted.body, extracted.headline || currentPiece.headline, currentPiece.sources)
    };

    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').textContent = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    document.getElementById('undoRewriteBtn').style.display = 'inline-flex';
    setStatus('outputStatus','outputStatusDot','outputStatusText','done','Rewrite done');
    showToast('âœ… Rewritten â€” use Undo to revert');

  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Rewrite failed: ' + err.message);
  }

  btn.disabled = false;
}

</script>

</body>
</html>
