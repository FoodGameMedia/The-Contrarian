<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>The Contrarian ¬∑ by Food Game</title>
<link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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">
<link rel="apple-touch-icon" href="data:image/png;base64,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">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8cmFkaWFsR3JhZGllbnQgaWQ9ImxvZ29CZ0wiIGN4PSIzOCUiIGN5PSIzMiUiIHI9Ijc1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZGYwZjUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZjVlOGVmIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSJ1cmwoI2xvZ29CZ0wpIi8+CiAgPHJlY3QgeD0iNjQiIHk9IjEwMCIgd2lkdGg9IjM4NCIgaGVpZ2h0PSIwLjgiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMTUiLz4KICA8cmVjdCB4PSI2NCIgeT0iNDEyIiB3aWR0aD0iMzg0IiBoZWlnaHQ9IjAuOCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4xNSIvPgogIDx0ZXh0IHg9IjI1NiIgeT0iMjA0IiBmb250LWZhbWlseT0iUGxheWZhaXIgRGlzcGxheSwgR2VvcmdpYSwgc2VyaWYiIGZvbnQtc2l6ZT0iNDQiIGZvbnQtd2VpZ2h0PSI3MDAiIGZvbnQtc3R5bGU9Iml0YWxpYyIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC41IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iMTgiPlRIRTwvdGV4dD4KICA8dGV4dCB4PSIyNTYiIHk9IjMwOCIgZm9udC1mYW1pbHk9IlBsYXlmYWlyIERpc3BsYXksIEdlb3JnaWEsIHNlcmlmIiBmb250LXNpemU9Ijc2IiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjMGYxZjM4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iLTIiPkNvbnRyYXJpYW48L3RleHQ+CiAgPHJlY3QgeD0iMTQ4IiB5PSIzMjYiIHdpZHRoPSIyMTYiIGhlaWdodD0iMi41IiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjg1Ii8+CiAgPHRleHQgeD0iMjU2IiB5PSIzNjgiIGZvbnQtZmFtaWx5PSJETSBTYW5zLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNTAwIiBmaWxsPSJyZ2JhKDE1LDMxLDU2LDAuMzUpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBsZXR0ZXItc3BhY2luZz0iNSI+Rk9PRCBHQU1FIE1FRElBPC90ZXh0PgogIDxyZWN0IHg9IjY0IiB5PSI2NCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjY0IiB5PSI2NCIgd2lkdGg9IjIiIGhlaWdodD0iMjAiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjQyOCIgeT0iNjQiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyIiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjMiLz4KICA8cmVjdCB4PSI0NDYiIHk9IjY0IiB3aWR0aD0iMiIgaGVpZ2h0PSIyMCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4zIi8+CiAgPHJlY3QgeD0iNjQiIHk9IjQ0NiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjY0IiB5PSI0MjgiIHdpZHRoPSIyIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZTkxZThjIiBvcGFjaXR5PSIwLjMiLz4KICA8cmVjdCB4PSI0MjgiIHk9IjQ0NiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIiIGZpbGw9IiNlOTFlOGMiIG9wYWNpdHk9IjAuMyIvPgogIDxyZWN0IHg9IjQ0NiIgeT0iNDI4IiB3aWR0aD0iMiIgaGVpZ2h0PSIyMCIgZmlsbD0iI2U5MWU4YyIgb3BhY2l0eT0iMC4zIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Playfair+Display:ital,wght@0,700;0,900;1,700;1,900&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0f1f38;
  --navy-mid: #1a2f52;
  --navy-light: #243b5e;
  --navy-dark: #08131f;
  --pink: #e91e8c;
  --pink-soft: #f4a7b9;
  --pink-dim: rgba(233,30,140,0.12);
  --white: #f8f8f8;
  --off-white: #f0ede8;
  --grey: #8a9ab5;
  --grey-dim: rgba(138,154,181,0.15);
  --border: rgba(244,167,185,0.1);
  --border-hover: rgba(244,167,185,0.3);
  --radius: 12px;
  --radius-sm: 8px;
  --transition: 0.18s ease;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans', system-ui, sans-serif; background: var(--navy-dark); color: var(--white); min-height: 100vh; overflow-x: hidden; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(244,167,185,0.2); border-radius: 2px; }
.app { display:flex; min-height:100vh; }
.sidebar { width: 260px; min-width: 260px; background: var(--navy); border-right: 1px solid var(--border); padding: 0; display: flex; flex-direction: column; overflow-y: auto; position: relative; z-index: 10; }
.sidebar-logo { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(233,30,140,0.06) 0%, transparent 100%); }
.sidebar-logo .wordmark { font-family: 'Playfair Display', Georgia, serif; font-size: 28px; font-weight: 900; color: var(--white); line-height: 1.0; letter-spacing: -0.8px; font-style: normal; white-space: nowrap; }
.sidebar-logo .wordmark span { color: var(--pink-soft); }
.sidebar-logo .tagline { font-size: 8px; letter-spacing: 3px; text-transform: uppercase; color: rgba(138,154,181,0.6); margin-top: 7px; font-weight: 600; }
.sidebar-logo .wordmark-rule { width: 32px; height: 2px; background: linear-gradient(90deg, var(--pink), transparent); margin-top: 10px; }
.sidebar-nav { padding: 12px 10px; flex: 1; }
.nav-section { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: rgba(138,154,181,0.5); padding: 14px 10px 6px; font-weight: 600; }
.nav-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: transparent; border: none; border-radius: var(--radius-sm); color: var(--grey); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; text-align: left; transition: all var(--transition); letter-spacing: 0.1px; }
.nav-btn:hover { background: var(--grey-dim); color: var(--white); }
.nav-btn.active { background: var(--pink-dim); color: var(--pink-soft); }
.nav-btn.active .nav-icon { opacity: 1; }
.nav-icon { font-size: 14px; opacity: 0.6; flex-shrink: 0; }
.sidebar-footer { padding: 16px 20px; border-top: 1px solid var(--border); }
.api-status-badge { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--grey); font-weight: 500; }
.api-dot { width: 6px; height: 6px; border-radius: 50%; background: #4ade80; flex-shrink: 0; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
.topbar { background: var(--navy); border-bottom: 1px solid var(--border); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-shrink: 0; }
.topbar-title { font-family: 'DM Serif Display', Georgia, serif; font-size: 16px; color: var(--white); font-style: italic; }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.hamburger { display: none; background: transparent; border: none; color: var(--white); font-size: 18px; cursor: pointer; padding: 4px; }
.status-bar { display: none; align-items: center; gap: 8px; padding: 8px 28px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--grey); }
.status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.status-dot.working { background:#f59e0b; animation: pulse 1s infinite; }
.status-dot.done { background:#4ade80; }
.status-dot.error { background:#f87171; }
.content { flex: 1; overflow-y: auto; padding: 0; }
.panel { display: none; }
.panel.active { display: block; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 7px; padding: 11px 22px; border: none; border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--transition); letter-spacing: 0.2px; white-space: nowrap; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: linear-gradient(135deg, #e91e8c, #c2185b); color: #fff; box-shadow: 0 4px 16px rgba(233,30,140,0.25); }
.btn-primary:hover:not(:disabled) { box-shadow: 0 6px 24px rgba(233,30,140,0.4); transform: translateY(-1px); }
.btn-secondary { background: rgba(138,154,181,0.12); color: var(--grey); border: 1px solid rgba(138,154,181,0.2); }
.btn-secondary:hover:not(:disabled) { background: rgba(138,154,181,0.2); color: var(--white); border-color: rgba(138,154,181,0.35); }
.btn-outline { background: transparent; color: var(--pink-soft); border: 1px solid rgba(244,167,185,0.3); }
.btn-outline:hover:not(:disabled) { background: var(--pink-dim); border-color: rgba(244,167,185,0.5); }
.btn-ghost { background: transparent; color: var(--grey); border: 1px solid var(--border); font-size: 12px; padding: 8px 14px; }
.btn-ghost:hover:not(:disabled) { color: var(--white); border-color: var(--border-hover); }
.btn-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.start-screen { min-height: calc(100vh - 57px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 32px; background: radial-gradient(ellipse at 60% 20%, rgba(233,30,140,0.06) 0%, transparent 60%), radial-gradient(ellipse at 20% 80%, rgba(244,167,185,0.04) 0%, transparent 50%); }
.start-headline { text-align: center; margin-bottom: 48px; }
.start-headline .overline { font-size: 9px; letter-spacing: 4px; text-transform: uppercase; color: var(--pink-soft); opacity: 0.7; margin-bottom: 14px; font-weight: 600; }
.start-headline h1 { font-family: 'Playfair Display', Georgia, serif; font-size: clamp(28px, 4vw, 44px); font-weight: 900; color: var(--white); line-height: 1.1; letter-spacing: -1px; margin-bottom: 12px; }
.start-headline h1 em { color: var(--pink-soft); font-style: italic; }
.start-headline p { font-size: 14px; color: var(--grey); line-height: 1.6; max-width: 420px; margin: 0 auto; }
.entry-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; width: 100%; max-width: 780px; margin-bottom: 40px; }
.entry-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 28px 24px; cursor: pointer; transition: all 0.22s ease; text-align: left; position: relative; overflow: hidden; }
.entry-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--card-accent, var(--pink)), transparent); opacity: 0; transition: opacity 0.22s ease; }
.entry-card:hover { background: rgba(255,255,255,0.06); border-color: var(--border-hover); transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
.entry-card:hover::before { opacity: 1; }
.entry-card .card-icon { font-size: 28px; margin-bottom: 14px; display: block; }
.entry-card .card-title { font-family: 'Playfair Display', Georgia, serif; font-size: 17px; font-weight: 900; color: var(--white); margin-bottom: 8px; line-height: 1.2; }
.entry-card .card-desc { font-size: 12px; color: var(--grey); line-height: 1.6; }
.entry-card .card-action { display: inline-flex; align-items: center; gap: 4px; margin-top: 16px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; color: var(--card-accent, var(--pink-soft)); opacity: 0.8; text-transform: uppercase; }
.section-wrap { max-width: 760px; margin: 0 auto; padding: 32px 28px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
.section-title { font-family: 'Playfair Display', Georgia, serif; font-size: 22px; font-weight: 900; color: var(--white); font-style: italic; }
.section-subtitle { font-size: 12px; color: var(--grey); margin-top: 4px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--grey); margin-bottom: 8px; }
.form-label span { font-weight: 400; letter-spacing: 0; text-transform: none; color: rgba(138,154,181,0.5); font-size: 10px; margin-left: 6px; }
.form-input, .form-textarea { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 14px; color: var(--white); font-family: 'DM Sans', sans-serif; font-size: 14px; transition: border-color var(--transition); resize: none; }
.form-input:focus, .form-textarea:focus { outline: none; border-color: rgba(244,167,185,0.4); background: rgba(255,255,255,0.06); }
.form-input::placeholder, .form-textarea::placeholder { color: rgba(138,154,181,0.4); font-style: italic; }
.chips { display: flex; gap: 6px; flex-wrap: wrap; }
.chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--grey); transition: all var(--transition); font-family: 'DM Sans', sans-serif; }
.chip:hover { border-color: var(--border-hover); color: var(--white); }
.chip.active { background: var(--pink-dim); border-color: rgba(233,30,140,0.4); color: var(--pink-soft); }
.url-drop-zone { border: 2px dashed var(--border); border-radius: 16px; padding: 32px; text-align: center; transition: all 0.2s ease; margin-bottom: 20px; cursor: pointer; }
.url-drop-zone:hover, .url-drop-zone.dragover { border-color: rgba(244,167,185,0.4); background: rgba(244,167,185,0.04); }
.url-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.url-item { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 14px; font-size: 12px; }
.url-item .url-text { flex: 1; color: var(--pink-soft); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.url-item .url-status { font-size: 11px; color: var(--grey); flex-shrink: 0; }
.url-item .url-remove { background: transparent; border: none; color: var(--grey); cursor: pointer; font-size: 14px; padding: 2px 4px; transition: color var(--transition); flex-shrink: 0; }
.url-item .url-remove:hover { color: #f87171; }
.intel-mode-tabs { display: flex; gap: 4px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 4px; margin-bottom: 24px; }
.intel-tab { flex: 1; padding: 10px; background: transparent; border: none; border-radius: 7px; color: var(--grey); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all var(--transition); text-align: center; }
.intel-tab.active { background: var(--navy-mid); color: var(--white); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.intel-tab-panel { display: none; }
.intel-tab-panel.active { display: block; }
.region-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
.region-btn { padding: 10px 8px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--grey); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all var(--transition); text-align: center; }
.region-btn:hover { border-color: var(--border-hover); color: var(--white); }
.region-btn.active { background: var(--pink-dim); border-color: rgba(233,30,140,0.4); color: var(--pink-soft); }
.date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
/* ‚îÄ‚îÄ API Notice variants ‚îÄ‚îÄ */
.api-stub-notice { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 12px; color: rgba(245,158,11,0.8); margin-bottom: 20px; line-height: 1.5; }
.api-stub-notice strong { color: rgba(245,158,11,1); }
.api-live-notice { background: rgba(74,222,128,0.07); border: 1px solid rgba(74,222,128,0.25); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 12px; color: rgba(74,222,128,0.85); margin-bottom: 20px; line-height: 1.5; }
.api-live-notice strong { color: rgba(74,222,128,1); }
/* Digest source badge */
.digest-source-badge { display: inline-block; font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 700; padding: 2px 7px; border-radius: 4px; margin-bottom: 8px; }
.badge-newsdata { background: rgba(74,222,128,0.15); color: #4ade80; border: 1px solid rgba(74,222,128,0.3); }
.badge-newsapi { background: rgba(96,165,250,0.15); color: #60a5fa; border: 1px solid rgba(96,165,250,0.3); }
.badge-claude { background: rgba(244,167,185,0.15); color: var(--pink-soft); border: 1px solid rgba(244,167,185,0.3); }
.digest-list { display: flex; flex-direction: column; gap: 12px; }
.digest-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; transition: all 0.2s ease; cursor: pointer; position: relative; }
.digest-card:hover { background: rgba(255,255,255,0.06); border-color: var(--border-hover); }
.digest-card.selected { background: var(--pink-dim); border-color: rgba(233,30,140,0.3); }
.digest-rank { position: absolute; top: 12px; right: 14px; font-size: 10px; font-weight: 700; color: var(--grey); opacity: 0.5; }
.digest-source-tag { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--pink-soft); opacity: 0.7; margin-bottom: 6px; font-weight: 600; }
.digest-title { font-size: 14px; font-weight: 700; color: var(--white); line-height: 1.4; margin-bottom: 8px; }
.digest-angle { font-size: 12px; color: var(--grey); line-height: 1.6; margin-bottom: 10px; font-style: italic; }
.digest-url { font-size: 11px; color: rgba(138,154,181,0.5); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.digest-actions { display: flex; gap: 6px; margin-top: 12px; }
.source-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 10px; transition: border-color var(--transition); }
.source-card:hover { border-color: var(--border-hover); }
.source-check { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
.source-check input[type="checkbox"] { margin-top: 2px; accent-color: var(--pink); width: 14px; height: 14px; flex-shrink: 0; cursor: pointer; }
.source-title { font-size: 13px; font-weight: 600; color: var(--white); line-height: 1.4; flex: 1; }
.source-snippet { font-size: 12px; color: var(--grey); line-height: 1.6; margin-bottom: 8px; }
.source-url { font-size: 11px; color: rgba(244,167,185,0.5); text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
.source-url:hover { color: var(--pink-soft); }
.output-tabs { display: flex; gap: 4px; padding: 0 28px; border-bottom: 1px solid var(--border); background: var(--navy); }
.output-tab { padding: 12px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--grey); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all var(--transition); margin-bottom: -1px; }
.output-tab.active { color: var(--white); border-bottom-color: var(--pink); }
.output-tab:hover:not(.active) { color: var(--white); }
.output-content { padding: 28px; }
.output-preview { background: var(--off-white); border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
.output-raw { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px; font-family: 'DM Mono', 'Courier New', monospace; font-size: 13px; line-height: 1.7; color: var(--grey); white-space: pre-wrap; word-break: break-word; min-height: 420px; resize: vertical; }
.output-html-code { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px; font-family: 'DM Mono', 'Courier New', monospace; font-size: 13px; line-height: 1.7; color: var(--grey); white-space: pre-wrap; word-break: break-word; max-height: 500px; overflow-y: auto; }
.history-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 16px 18px; margin-bottom: 10px; transition: border-color var(--transition); }
.history-item:hover { border-color: var(--border-hover); }
.history-title { font-size: 14px; font-weight: 700; color: var(--white); margin-bottom: 4px; }
.history-meta { font-size: 11px; color: var(--grey); margin-bottom: 10px; }
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--navy-mid); color: var(--white); padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; border: 1px solid var(--border-hover); z-index: 1000; transition: transform 0.25s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.4); white-space: nowrap; }
.toast.show { transform: translateX(-50%) translateY(0); }
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9; backdrop-filter: blur(2px); }
.overlay.show { display: block; }
.divider { height: 1px; background: var(--border); margin: 24px 0; }
.info-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 16px; font-size: 12px; color: var(--grey); line-height: 1.6; margin-bottom: 20px; }
.info-box strong { color: var(--pink-soft); font-weight: 600; }
.help-wrap { padding: 32px 28px; max-width: 680px; }
.help-section { margin-bottom: 32px; }
.help-section h3 { font-family: 'Playfair Display', Georgia, serif; font-size: 16px; font-weight: 700; color: var(--pink-soft); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); font-style: italic; }
.help-section p { font-size: 13px; color: var(--grey); line-height: 1.75; margin-bottom: 10px; }
.help-section li { font-size: 13px; color: var(--grey); line-height: 1.75; margin-bottom: 6px; margin-left: 16px; }
.help-section strong { color: var(--white); font-weight: 600; }
.help-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.help-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--grey); vertical-align: top; }
.help-table td:first-child { color: var(--white); font-weight: 600; white-space: nowrap; }
@media (max-width: 768px) {
  .sidebar { position: fixed; left: -280px; top: 0; height: 100%; transition: left 0.25s ease; z-index: 100; width: 260px; min-width: 260px; }
  .sidebar.open { left: 0; }
  .hamburger { display: block; }
  .entry-grid { grid-template-columns: 1fr; }
  .region-grid { grid-template-columns: repeat(2, 1fr); }
  .date-row { grid-template-columns: 1fr; }
  .section-wrap { padding: 20px 16px; }
  .output-content { padding: 16px; }
  .help-wrap { padding: 20px 16px; }
  .topbar { padding: 12px 16px; }
  .start-screen { padding: 32px 16px; }
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="wordmark">The <span>Contrarian</span></div>
      <div class="wordmark-rule"></div>
      <div class="tagline">by Food Game Media</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Start</div>
      <button class="nav-btn active" data-panel="start" onclick="switchPanel('start',this)"><span class="nav-icon">‚ö°</span> New Piece</button>
      <div class="nav-section">Write</div>
      <button class="nav-btn" data-panel="compose" onclick="switchPanel('compose',this)"><span class="nav-icon">‚úèÔ∏è</span> Compose Brief</button>
      <button class="nav-btn" data-panel="sources" onclick="switchPanel('sources',this)"><span class="nav-icon">üìö</span> Review Sources</button>
      <button class="nav-btn" data-panel="output" onclick="switchPanel('output',this)"><span class="nav-icon">üìÑ</span> Output</button>
      <div class="nav-section">Discover</div>
      <button class="nav-btn" data-panel="intel" onclick="switchPanel('intel',this)"><span class="nav-icon">üî≠</span> Topic Intelligence</button>
      <button class="nav-btn" data-panel="url" onclick="switchPanel('url',this)"><span class="nav-icon">üîó</span> Drop a Link</button>
      <button class="nav-btn" data-panel="social" onclick="switchPanel('social',this)"><span class="nav-icon">üí¨</span> Social Comment</button>
      <div class="nav-section">Library</div>
      <button class="nav-btn" data-panel="articles" onclick="switchPanel('articles',this);renderHistory();"><span class="nav-icon">üìÅ</span> Articles</button>
      <button class="nav-btn" data-panel="help" onclick="switchPanel('help',this)"><span class="nav-icon">‚ùì</span> Help & Guide</button>
      <button class="nav-btn" onclick="document.getElementById('importFileInput').click()"><span class="nav-icon">üì§</span> Import File</button>
    </nav>
    <div class="sidebar-footer">
      <div class="api-status-badge">
        <div class="api-dot"></div>
        Claude Sonnet 4.6 ¬∑ Live
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <div class="topbar-title" id="topbarTitle">New Piece</div>
      <div class="topbar-right">
        <div id="localModeBadge" style="display:none;align-items:center;gap:5px;font-size:10px;font-weight:600;color:#f59e0b;background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.25);padding:4px 10px;border-radius:20px;letter-spacing:0.5px;">‚ö° LOCAL MODE</div>
        <button class="btn btn-ghost" onclick="testConnection()">üîå Test</button>
      </div>
    </div>
    <div class="status-bar" id="statusBar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText"></span>
    </div>

    <div class="content">

      <!-- START SCREEN -->
      <div class="panel active" id="panel-start">
        <div class="start-screen">
          <div class="start-headline">
            <div class="overline">Food Game Media</div>
            <h1>The argument<br><em>nobody's making.</em></h1>
            <p>Research-to-writing intelligence for Australian hospitality. Pick your starting point.</p>
          </div>
          <div class="entry-grid">
            <div class="entry-card" style="--card-accent:#f4a7b9;" onclick="switchPanel('intel', document.querySelector('[data-panel=intel]'))">
              <span class="card-icon">üî≠</span>
              <div class="card-title">Find a Topic</div>
              <div class="card-desc">Discover what's trending today ‚Äî globally or by region. Or search a specific topic and find the 10 best articles around it.</div>
              <div class="card-action">Explore trends ‚Üí</div>
            </div>
            <div class="entry-card" style="--card-accent:#e91e8c;" onclick="switchPanel('url', document.querySelector('[data-panel=url]'))">
              <span class="card-icon">üîó</span>
              <div class="card-title">Drop a Link</div>
              <div class="card-desc">Found an article? Paste the URL and jump straight to writing. Add multiple links to synthesise a combined commentary.</div>
              <div class="card-action">Drop URL ‚Üí</div>
            </div>
            <div class="entry-card" style="--card-accent:#8a9ab5;" onclick="switchPanel('compose', document.querySelector('[data-panel=compose]'))">
              <span class="card-icon">‚úèÔ∏è</span>
              <div class="card-title">Write from Scratch</div>
              <div class="card-desc">Have a topic or angle in mind? Go straight to the brief, set your search queries, and let the engine find sources.</div>
              <div class="card-action">Start writing ‚Üí</div>
            </div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:rgba(138,154,181,0.4);letter-spacing:1px;text-transform:uppercase;">or load from</div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
              <button class="btn btn-ghost" onclick="switchPanel('articles',document.querySelector('[data-panel=articles]'));renderHistory();">üìÅ Articles</button>
              <button class="btn btn-ghost" onclick="document.getElementById('importFileInput').click()">üì§ Import File</button>
              <input type="file" id="importFileInput" accept=".html,.htm" style="display:none;" onchange="handleImport(event)">
            </div>
          </div>
        </div>
      </div>

      <!-- COMPOSE BRIEF -->
      <div class="panel" id="panel-compose">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Compose Brief</div><div class="section-subtitle">Define your topic, angle, and direction</div></div>
          </div>
          <div class="form-group">
            <label class="form-label">Topic or Angle <span>‚Äî be specific. The sharper the angle, the better the output.</span></label>
            <input class="form-input" id="topicInput" placeholder="e.g. Why hospitality's obsession with 'experience' is killing profitability">
          </div>
          <div class="form-group">
            <label class="form-label">Additional Context <span>‚Äî optional.</span></label>
            <textarea class="form-textarea" id="contextInput" rows="3" placeholder="e.g. I read that 3 Melbourne venues closed last month citing 'customer experience costs'..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Source <span>‚Äî e.g. SMH.com.au</span></label>
            <input class="form-input" id="sourceInput" placeholder="e.g. SMH.com.au">
          </div>
          <div class="form-group">
            <label class="form-label">Search Queries <span>‚Äî one per line. Leave blank to auto-generate.</span></label>
            <textarea class="form-textarea" id="searchQueries" rows="4" placeholder="One query per line. Leave blank to auto-generate."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Target Length</label>
            <div class="chips">
              <button class="chip" data-words="600" onclick="selectLength(this)">600w ‚Äî Short</button>
              <button class="chip active" data-words="1000" onclick="selectLength(this)">1000w ‚Äî Standard</button>
              <button class="chip" data-words="1400" onclick="selectLength(this)">1400w ‚Äî Deep</button>
              <button class="chip" data-words="1800" onclick="selectLength(this)">1800w ‚Äî Long</button>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" id="researchBtn" onclick="runResearch()">üîç Research Sources</button>
            <button class="btn btn-outline" id="directWriteBtn" onclick="directWrite()">‚ö° Skip to Write</button>
            <button class="btn btn-secondary" onclick="resetAll()">‚Ü© Reset</button>
          </div>
        </div>
      </div>

      <!-- REVIEW SOURCES -->
      <div class="panel" id="panel-sources">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Review Sources</div><div class="section-subtitle" id="sourcesCount">No sources yet</div></div>
            <div class="btn-row">
              <button class="btn btn-ghost" onclick="selectAllSources()">All</button>
              <button class="btn btn-ghost" onclick="deselectAllSources()">None</button>
            </div>
          </div>
          <div id="sourcesList"><div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">Run Research first to find sources.</div></div>
          <div class="divider"></div>
          <div class="btn-row">
            <button class="btn btn-primary" id="writeBtn" onclick="runWrite()" disabled>‚úçÔ∏è Write Piece</button>
            <button class="btn btn-secondary" onclick="switchPanel('compose',document.querySelector('[data-panel=compose]'))">‚Üê Back</button>
          </div>
        </div>
      </div>

      <!-- OUTPUT -->
      <div class="panel" id="panel-output">
        <div class="output-tabs">
          <button class="output-tab active" onclick="switchOutputTab('preview',this)">Preview</button>
          <button class="output-tab" onclick="switchOutputTab('raw',this)">Raw Text</button>
          <button class="output-tab" onclick="switchOutputTab('html',this)">HTML</button>
          <button class="output-tab" onclick="updatePreviewFromRaw()" style="margin-left:auto;color:var(--pink-soft);">‚Üª Update Preview</button>
        </div>
        <div class="status-bar" id="outputStatus" style="display:none;">
          <div class="status-dot" id="outputStatusDot"></div>
          <span id="outputStatusText"></span>
        </div>
        <div class="output-content">
          <div id="tabPreview">
            <div class="form-group" id="headlineGroup" style="display:none;margin-bottom:16px;">
              <label class="form-label">Headline <span>‚Äî edit before publishing</span></label>
              <input class="form-input" id="headlineInput" type="text" placeholder="Engine-generated headline..." oninput="updatePreviewHeadline()">
            </div>
            <div class="output-preview" id="outputPreview"><div style="padding:60px;text-align:center;color:#888;">Your piece will appear here.</div></div>
          </div>
          <div id="tabRaw" style="display:none;">
            <textarea class="output-raw" id="outputRaw" style="width:100%;min-height:420px;resize:vertical;" oninput="currentPiece.body=this.value;currentPiece.raw=this.value;"></textarea>
            <div class="info-box" style="margin-top:12px;">
              <strong>Adding images</strong> ‚Äî paste a URL from the web directly into the text as an HTML image tag:<br>
              <code style="font-size:11px;color:var(--pink-soft);display:block;margin-top:6px;word-break:break-all;">&lt;img src="https://your-image-url.com/image.jpg" alt="description" style="width:100%;border-radius:8px;margin:16px 0;"&gt;</code>
              <span style="font-size:11px;color:rgba(138,154,181,0.5);display:block;margin-top:6px;">Place the tag on its own line where you want the image to appear.</span>
            </div>
          </div>
          <div id="tabHtml" style="display:none;"><pre class="output-html-code" id="outputHtml"></pre></div>
          <div class="divider"></div>
          <div class="btn-row" style="flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="copyRawText()">üìã Copy Text</button>
            <button class="btn btn-secondary" onclick="copyHtml()">üìã Copy HTML</button>
            <button class="btn btn-secondary" onclick="downloadHtml()">‚¨áÔ∏è Download</button>
            <button class="btn btn-secondary" onclick="saveToHistory()">üíæ Save</button>
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button class="btn btn-outline" onclick="editBackToBrief()">‚úèÔ∏è Edit Brief</button>
            <button class="btn btn-outline" onclick="newAngleSameSources()">‚Üª New Angle</button>
            <button class="btn btn-ghost" onclick="switchPanel('start',document.querySelector('[data-panel=start]'))">‚Üê New Piece</button>
          </div>
          <div id="rewritePanel" style="display:none;margin-top:24px;border-top:1px solid var(--border);padding-top:20px;">
            <div style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey);margin-bottom:12px;">‚úèÔ∏è Rewrite</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;" id="toneChips">
              <button class="chip" onclick="selectTone(this,'punchier')">More punchy</button>
              <button class="chip" onclick="selectTone(this,'softer')">More sympathetic</button>
              <button class="chip" onclick="selectTone(this,'funnier')">Funnier</button>
              <button class="chip" onclick="selectTone(this,'sharper')">Sharper argument</button>
              <button class="chip" onclick="selectTone(this,'shorter')">Tighten it up</button>
              <button class="chip" onclick="selectTone(this,'longer')">Expand it</button>
              <button class="chip" onclick="selectTone(this,'opener')">Stronger opener</button>
              <button class="chip" onclick="selectTone(this,'closer')">Stronger closer</button>
            </div>
            <div class="form-group" style="margin-bottom:10px;">
              <input class="form-input" id="rewriteCustom" placeholder="Or describe what to change..." style="font-size:13px;">
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="runRewrite()" id="rewriteBtn">‚ú® Rewrite</button>
              <button class="btn btn-ghost" onclick="undoRewrite()" id="undoRewriteBtn" style="display:none;">‚Ü© Undo</button>
              <button class="btn btn-ghost" onclick="toggleRewrite()">Close</button>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn btn-ghost" onclick="toggleRewrite()" id="rewriteToggleBtn" style="display:none;width:100%;">‚úèÔ∏è Rewrite this piece</button>
          </div>
        </div>
      </div>

      <!-- TOPIC INTELLIGENCE -->
      <div class="panel" id="panel-intel">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Topic Intelligence</div><div class="section-subtitle">Discover what's worth writing about</div></div>
          </div>
          <div class="intel-mode-tabs">
            <button class="intel-tab active" data-mode="trending" onclick="switchIntelMode('trending',this)">üî• What's Trending</button>
            <button class="intel-tab" data-mode="search" onclick="switchIntelMode('search',this)">üîç Search a Topic</button>
          </div>

          <!-- TRENDING MODE -->
          <div class="intel-tab-panel active" id="intel-trending">
            <div class="api-live-notice">
              <strong>üì° NewsData.io + üì∞ NewsAPI are both live.</strong> Both sources run in parallel ‚Äî results are merged, deduplicated, and enriched by Claude for maximum coverage. Falls back to Claude web search if both fail.
            </div>
            <div class="form-group">
              <label class="form-label">Region</label>
              <div class="region-grid">
                <button class="region-btn active" data-region="" onclick="selectRegion(this)">üåç Global</button>
                <button class="region-btn" data-region="au" onclick="selectRegion(this)">üá¶üá∫ Australian</button>
                <button class="region-btn" data-region="au,nz" onclick="selectRegion(this)">üá¶üá∫üá≥üáø ANZ</button>
                <button class="region-btn" data-region="au,nz,jp,kr,sg,my,id,th" onclick="selectRegion(this)">üåè Asia Pacific</button>
                <button class="region-btn" data-region="us" onclick="selectRegion(this)">üá∫üá∏ USA</button>
                <button class="region-btn" data-region="gb,de,fr,it,es,nl" onclick="selectRegion(this)">üá™üá∫ Europe</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Time Period</label>
              <div class="chips">
                <button class="chip active" data-period="today" onclick="selectPeriod(this)">Today</button>
                <button class="chip" data-period="7days" onclick="selectPeriod(this)">Last 7 days</button>
                <button class="chip" data-period="30days" onclick="selectPeriod(this)">Last 30 days</button>
                <button class="chip" data-period="custom" onclick="selectPeriod(this);toggleTrendingCustomDates(true)">Custom range</button>
              </div>
              <div id="trendingCustomDates" style="display:none;margin-top:12px;">
                <div class="date-row">
                  <div><label class="form-label">From</label><input class="form-input" id="trendingDateFrom" type="date"></div>
                  <div><label class="form-label">To</label><input class="form-input" id="trendingDateTo" type="date"></div>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="runTrending()" id="trendingBtn">üî• Find Trending Topics</button>
          </div>

          <!-- SEARCH MODE -->
          <div class="intel-tab-panel" id="intel-search">
            <div class="api-live-notice">
              <strong>üì° NewsData.io + üì∞ NewsAPI are both live.</strong> Both sources run in parallel ‚Äî results merged and enriched by Claude. Falls back to Claude web search if both fail.
            </div>
            <div class="form-group">
              <label class="form-label">Topic or Keywords</label>
              <input class="form-input" id="intelTopicInput" placeholder="e.g. restaurant staff retention Australia">
            </div>
            <div class="date-row">
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">From Date <span>optional</span></label>
                <input class="form-input" id="intelDateFrom" type="date">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">To Date <span>optional</span></label>
                <input class="form-input" id="intelDateTo" type="date">
              </div>
            </div>
            <div class="form-group" style="margin-top:20px;">
              <label class="form-label">Region</label>
              <div class="region-grid">
                <button class="region-btn active" data-region="" onclick="selectSearchRegion(this)">üåç Global</button>
                <button class="region-btn" data-region="au" onclick="selectSearchRegion(this)">üá¶üá∫ Australian</button>
                <button class="region-btn" data-region="au,nz" onclick="selectSearchRegion(this)">üá¶üá∫üá≥üáø ANZ</button>
                <button class="region-btn" data-region="au,nz,jp,kr,sg,my,id,th" onclick="selectSearchRegion(this)">üåè Asia Pacific</button>
                <button class="region-btn" data-region="us" onclick="selectSearchRegion(this)">üá∫üá∏ USA</button>
                <button class="region-btn" data-region="gb,de,fr,it,es,nl" onclick="selectSearchRegion(this)">üá™üá∫ Europe</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Source <span>‚Äî e.g. AFR.com</span></label>
              <input class="form-input" id="sourceInputIntel" placeholder="e.g. AFR.com">
            </div>
            <button class="btn btn-primary" onclick="runTopicSearch()" id="topicSearchBtn">üîç Find Articles</button>
          </div>

          <!-- DIGEST RESULTS -->
          <div id="intelResults" style="display:none; margin-top:28px;">
            <div class="divider"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <div style="font-size:13px;font-weight:600;color:var(--white);" id="intelResultsTitle">Results</div>
              <div class="btn-row">
                <button class="btn btn-ghost" onclick="selectAllDigest()">Select All</button>
                <button class="btn btn-outline" id="synthesiseBtn" onclick="runSynthesis()" disabled>‚ö° Synthesise Selected</button>
              </div>
            </div>
            <div class="digest-list" id="digestList"></div>
          </div>
        </div>
      </div>

      <!-- DROP A LINK -->
      <div class="panel" id="panel-url">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Drop a Link</div><div class="section-subtitle">Paste URLs or drop article text directly</div></div>
          </div>
          <div class="intel-mode-tabs" style="margin-bottom:24px;">
            <button class="intel-tab active" onclick="switchUrlMode('url',this)">üîó Paste URL(s)</button>
            <button class="intel-tab" onclick="switchUrlMode('text',this)">üìã Paste Article Text</button>
          </div>
          <div id="urlModeUrl">
            <div class="info-box">
              <strong>Single URL</strong> ‚Äî engine fetches the article and pre-fills your brief.<br>
              <strong>Multiple URLs (2‚Äì5)</strong> ‚Äî synthesises all articles into one combined piece.<br>
              <strong>Note:</strong> Some sites block automated fetching. If fetch fails, use <em>Paste Article Text</em>.
            </div>
            <div class="form-group">
              <label class="form-label">Paste a URL</label>
              <div style="display:flex;gap:8px;">
                <input class="form-input" id="urlInput" placeholder="https://..." style="flex:1;" onkeydown="if(event.key==='Enter')addUrl()">
                <button class="btn btn-outline" onclick="addUrl()">Add</button>
              </div>
            </div>
            <div id="urlList" class="url-list" style="display:none;"></div>
            <div id="urlSingleActions" style="display:none;">
              <div class="form-group">
                <label class="form-label">Source <span>‚Äî e.g. SMH.com.au</span></label>
                <input class="form-input" id="sourceInputUrl" placeholder="e.g. SMH.com.au">
              </div>
              <div class="form-group" style="margin-bottom:12px;">
                <label class="form-label">Word Count</label>
                <div class="chips" id="urlWordChips">
                  <button class="chip" onclick="setUrlWords(450,this)">450</button>
                  <button class="chip" onclick="setUrlWords(600,this)">600</button>
                  <button class="chip active" onclick="setUrlWords(1000,this)">1000</button>
                  <button class="chip" onclick="setUrlWords(1200,this)">1200</button>
                  <button class="chip" onclick="setUrlWords(1500,this)">1500</button>
                </div>
              </div>
              <div class="btn-row">
                <button class="btn btn-primary" onclick="runUrlFetch()" id="urlSingleBtn">üîó Fetch Article</button>
                <button class="btn btn-outline" onclick="runUrlSynthesis()" id="urlSynthBtn" style="display:none;">‚ö° Multi-story Synthesis</button>
                <button class="btn btn-secondary" onclick="clearUrls()">Clear All</button>
              </div>
            </div>
          </div>
          <div id="urlModeText" style="display:none;">
            <div class="info-box">
              <strong>Can't fetch the URL?</strong> Open the article in your browser, copy all the text, and paste it here. Works with paywalled articles, LinkedIn posts, PDFs ‚Äî anything you can copy.
            </div>
            <div class="form-group">
              <label class="form-label">Article Text <span>‚Äî paste the full article content here</span></label>
              <textarea class="form-textarea" id="pasteTextInput" rows="10" placeholder="Paste the article text here..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Source URL <span>‚Äî optional, for citation</span></label>
              <input class="form-input" id="pasteUrlInput" placeholder="https://...">
            </div>
            <div class="form-group">
              <label class="form-label">Source Title <span>‚Äî optional</span></label>
              <input class="form-input" id="pasteTitleInput" placeholder="e.g. The Guardian ‚Äî Why restaurants are failing...">
            </div>
            <div class="form-group">
              <label class="form-label">Source <span>‚Äî e.g. TheGuardian.com</span></label>
              <input class="form-input" id="sourceInputText" placeholder="e.g. TheGuardian.com">
            </div>
            <div class="form-group" style="margin-bottom:12px;">
              <label class="form-label">Word Count</label>
              <div class="chips" id="textWordChips">
                <button class="chip" onclick="setTextWords(600,this)">600</button>
                <button class="chip active" onclick="setTextWords(1000,this)">1000</button>
                <button class="chip" onclick="setTextWords(1200,this)">1200</button>
                <button class="chip" onclick="setTextWords(1500,this)">1500</button>
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="runTextBrief()">‚úèÔ∏è Build Brief from Text</button>
              <button class="btn btn-outline" onclick="runTextDirect()">‚ö° Write Directly</button>
              <button class="btn btn-secondary" onclick="clearPasteText()">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SOCIAL COMMENT -->
      <div class="panel" id="panel-social">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Social Comment</div><div class="section-subtitle">Generate a sharp LinkedIn comment in Rory's style</div></div>
          </div>
          <div class="form-group">
            <label class="form-label">Post or article you're responding to</label>
            <textarea class="form-textarea" id="socialInput" rows="5" placeholder="Paste the post, headline, or article excerpt you want to comment on..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Style</label>
            <div class="chips" id="socialStyleChips">
              <button class="chip active" onclick="setSocialStyle(this,'counterintuitive')">Counterintuitive</button>
              <button class="chip" onclick="setSocialStyle(this,'question')">Provocative question</button>
              <button class="chip" onclick="setSocialStyle(this,'reframe')">Agree but reframe</button>
              <button class="chip" onclick="setSocialStyle(this,'pushback')">Respectful pushback</button>
              <button class="chip" onclick="setSocialStyle(this,'stat')">The stat nobody mentions</button>
            </div>
            <input class="form-input" id="socialCustomStyle" placeholder="Or describe your own..." style="margin-top:10px;font-size:13px;" oninput="if(this.value.trim()){document.querySelectorAll('#socialStyleChips .chip').forEach(c=>c.classList.remove('active'));socialStyle='';}">
          </div>
          <div class="form-group">
            <label class="form-label">Length</label>
            <div class="chips" id="socialLengthChips">
              <button class="chip active" onclick="setSocialLength(this,1)">1 sentence</button>
              <button class="chip" onclick="setSocialLength(this,2)">2 sentences</button>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runSocialComment()" id="socialBtn">üí¨ Generate Comment</button>
            <button class="btn btn-ghost" onclick="document.getElementById('socialInput').value='';document.getElementById('socialOutput').style.display='none'">Clear</button>
          </div>
          <div id="socialOutput" style="display:none;margin-top:24px;">
            <div style="border-top:1px solid var(--border);padding-top:20px;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                <label class="form-label" style="margin:0;">Generated Comment</label>
                <div class="btn-row">
                  <button class="btn btn-primary" onclick="copySocialComment()">üìã Copy</button>
                  <button class="btn btn-ghost" onclick="saveSocialComment()">üíæ Save</button>
                  <button class="btn btn-ghost" onclick="runSocialComment()">‚Üª Regenerate</button>
                </div>
              </div>
              <div id="socialCommentText" style="background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;font-size:15px;line-height:1.8;color:var(--white);font-family:'DM Sans',sans-serif;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ARTICLES -->
      <div class="panel" id="panel-articles">
        <div class="section-wrap">
          <div class="section-header">
            <div><div class="section-title">Articles</div><div class="section-subtitle">Saved to GitHub ¬∑ available on all devices</div></div>
            <button class="btn btn-ghost" onclick="renderHistory()">‚Üª Refresh</button>
          </div>
          <div id="historyList"><div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No saved articles yet.</div></div>
        </div>
      </div>

      <!-- HELP -->
      <div class="panel" id="panel-help">
        <div class="help-wrap">
          <div class="help-section">
            <h3>What is The Contrarian?</h3>
            <p>The opinion engine for Food Game ‚Äî research-to-writing intelligence for Australian hospitality in a Rory Sutherland-inspired style.</p>
          </div>
          <div class="help-section">
            <h3>Topic Intelligence ‚Äî Data Sources</h3>
            <p>Runs <strong>NewsData.io</strong> and <strong>NewsAPI</strong> in parallel ‚Äî results are merged, deduplicated, and enriched by Claude. Falls back to <strong>Claude web search</strong> if both APIs fail. Up to 15 results per search.</p>
          </div>
          <div class="help-section">
            <h3>Publishing to Substack</h3>
            <p>The Contrarian writes the piece. You send it. Here's the flow:</p>
            <ul>
              <li><strong>Step 1 ‚Äî Generate &amp; review.</strong> Write your piece as normal. Review in the preview panel. Edit headline if needed.</li>
              <li><strong>Step 2 ‚Äî Save to Articles.</strong> Click <strong>Save</strong> to store the piece locally before publishing.</li>
              <li><strong>Step 3 ‚Äî Copy the raw text.</strong> Click <strong>Copy Raw Text</strong> in the output actions. This copies the clean article body ready to paste.</li>
              <li><strong>Step 4 ‚Äî Go to Substack.</strong> Open <strong>thecontrarian.substack.com</strong> ‚Üí click <strong>New Post</strong> ‚Üí paste the text ‚Üí add the headline.</li>
              <li><strong>Step 5 ‚Äî Add the hosted link.</strong> At the bottom of the Substack post add: <em>"Read the full formatted version: [link]"</em> ‚Äî the GitHub-hosted HTML link goes here once GitHub publishing is live.</li>
              <li><strong>Step 6 ‚Äî Draft &amp; send.</strong> Save as draft ‚Üí review ‚Üí send to subscribers.</li>
            </ul>
          </div>
          <div class="help-section">
            <h3>Technical Notes</h3>
            <ul>
              <li>Claude Sonnet 4.6 via Cloudflare proxy</li>
              <li>15 second cooldown between API calls</li>
              <li>History saved to browser localStorage</li>
              <li>Works on desktop, iPad, and iPhone</li>
            </ul>
          </div>
          <div class="help-section">
            <h3>Updating the Source Code</h3>
            <p>When a new version of The Contrarian is ready, follow these steps to push it live:</p>
            <ul>
              <li><strong>Step 1 ‚Äî Get the new file.</strong> Download the updated <code>index.html</code> from your Claude session.</li>
              <li><strong>Step 2 ‚Äî Open GitHub.</strong> Go to your repository and navigate to <code>index.html</code>.</li>
              <li><strong>Step 3 ‚Äî Edit the file.</strong> Click the pencil ‚úèÔ∏è icon to open the editor, then select <strong>Upload file</strong> ‚Äî or delete all existing content and paste the new code directly.</li>
              <li><strong>Step 4 ‚Äî Commit.</strong> Scroll to <strong>Commit changes</strong>, add a short note (e.g. "Add source naming field"), then click <strong>Commit changes</strong>.</li>
              <li><strong>Step 5 ‚Äî Wait for deploy.</strong> GitHub Pages redeploys automatically within 1‚Äì2 minutes. Hard refresh the live URL to confirm.</li>
            </ul>
          </div>
          <div class="help-section">
            <h3>After Updating ‚Äî Refresh on Each Device</h3>
            <p>The app does not auto-update on saved home screen installs. Each device needs a manual refresh after a new version is deployed.</p>
            <ul>
              <li><strong>MacBook (browser)</strong> ‚Äî Hold <code>Cmd + Shift + R</code> to hard refresh, or open the URL in a new tab.</li>
              <li><strong>iPhone (home screen app)</strong> ‚Äî Press and hold the app icon ‚Üí <strong>Remove from Home Screen</strong> ‚Üí open the GitHub Pages URL in Safari ‚Üí tap <strong>Share ‚Üí Add to Home Screen</strong> again.</li>
              <li><strong>iPad (home screen app)</strong> ‚Äî Same as iPhone above.</li>
            </ul>
            <p>Note: Home screen apps cached via Safari's "Add to Home Screen" cache aggressively. Remove and re-add is always the most reliable fix.</p>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROXY_URL = 'https://young-fog-3045fgww-proxy.julian-68d.workers.dev';
const PROXY_SECRET = 'foodgame2026';
const MODEL = 'claude-sonnet-4-20250514';
const COOLDOWN_MS = 15000;

// GitHub config
const GITHUB_OWNER = 'foodgamemedia';
const GITHUB_REPO = 'The-Contrarian';
const GITHUB_TOKEN = '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';
const GITHUB_BRANCH = 'main';

// NewsAPI config
const NEWSAPI_KEY = '304c53536d2b40199015e939db220d91';
const NEWSDATA_KEY = 'pub_cc8e4578942441eebe389103f04a672c';
const NEWSAPI_DOMAINS = {
  'au': 'smh.com.au,afr.com,theguardian.com,theage.com.au,abc.net.au,businessinsider.com.au,theaustralian.com.au,news.com.au,crikey.com.au',
  'au,nz': 'smh.com.au,afr.com,theage.com.au,abc.net.au,nzherald.co.nz,stuff.co.nz',
  'au,nz,jp,kr,sg,my,id,th': 'smh.com.au,abc.net.au,straitstimes.com,channelnewsasia.com,scmp.com',
  'us': 'reuters.com,nytimes.com,wsj.com,bloomberg.com,businessinsider.com',
  'gb,de,fr,it,es,nl': 'reuters.com,bbc.co.uk,theguardian.com,ft.com',
  '': 'reuters.com,bbc.co.uk,nytimes.com,theguardian.com,bloomberg.com,smh.com.au,afr.com'
};
const NEWSDATA_COUNTRIES = {
  'au':'au', 'au,nz':'au,nz', 'au,nz,jp,kr,sg,my,id,th':'au,nz,jp,kr,sg',
  'us':'us', 'gb,de,fr,it,es,nl':'gb,de,fr,it,es,nl', '':''
};

let lastApiCallTime = 0;
let targetWords = 1000;
let collectedSources = [];
let currentPiece = { topic:'', context:'', raw:'', html:'', sources:[] };
let addedUrls = [];
let selectedRegion = '';
let selectedSearchRegion = '';
let selectedPeriod = 'today';
let digestItems = [];
let intelMode = 'trending';
let socialStyle = 'counterintuitive';
let socialLength = 1;
let selectedTone = '';
let previousPieceHTML = '';
let previousPieceRaw = '';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RORY_VOICE = `
IMPORTANT: Begin your response with a headline on the very first line, prefixed with "HEADLINE: ". Then a blank line, then the piece body. Do not use # markdown for the headline ‚Äî just the HEADLINE: prefix.

Example format:
HEADLINE: Why Your Loyalty Program Is Making Customers Like You Less

The first paragraph of the piece...

You write for The Contrarian by Food Game Media ‚Äî the opinion column that finds the argument nobody is making, across business, economics, culture, behavioural observations, what we think people might be up to, people watching, and wherever ideas intersect with how and why people do what they do. Your style is Rory Sutherland: finding the overlooked signal in ordinary behaviour.

VOICE & TONE:
- Conversational authority. You sound like the smartest person at the dinner party who has read everything and worked out why most of it is wrong.
- Counterintuitive reframes are your signature move. If the obvious answer is X, explore why not-X might be more interesting.
- Rich analogy and metaphor. Explain ideas through unexpected parallels ‚Äî evolutionary biology, poker strategy, behavioural economics, urban planning, military logistics, architecture, game theory, whatever makes the point land hardest.
- No jargon. No frameworks. No bullet points within the piece. No subheadings. Write in flowing prose with paragraph breaks.
- Casual register, serious thinking. You can be funny but never flippant. Every joke carries a point.
- Write with the confidence of someone who has seen the same pattern a thousand times and finally understands why it keeps repeating.

STRUCTURE:
- Open with a provocative observation, paradox, or counterintuitive claim. Hook in the first two sentences.
- Build the argument through a series of connected insights, each one surprising. Not a linear march but a winding path that arrives somewhere unexpected.
- Use specific examples, data, and real situations from the source material. Cite source URLs naturally in the text as hyperlinks.
- Close with a practical provocation ‚Äî something the reader will think about differently after reading. This speaks to anyone making decisions in the face of uncertainty ‚Äî so essentially everyone.
- No summarising conclusion. End on a thought that keeps working after the reader finishes.

RULES:
- Never say "in conclusion", "to summarise", "key takeaways", or "in other words"
- Never use the phrase "it's worth noting" or "interestingly"
- Never use bullet points or numbered lists in the piece
- Never hedge with "arguably" or "perhaps" ‚Äî commit to the argument
- Never use em dashes (‚Äî). Use a comma, a full stop, or rewrite the sentence instead.
- Never open a sentence with "Moreover", "Furthermore", "Indeed", "This is", "It is", "What is", "There is", or "There are"
- Never use the words "delve", "nuanced", "multifaceted", "landscape", "crucial", "pivotal", "foster", "leverage", or "paradigm"
- Ground abstract ideas in concrete, specific examples drawn from the source material. The best analogy is the most surprising one, not the most obvious one.
- Treat the reader as intelligent and experienced. Do not explain basic concepts.
- Sign off as "- JB" at the end
`.trim();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPanel(id, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  if (el) el.classList.add('active');
  const titles = {
    start:'New Piece', compose:'Compose Brief', sources:'Review Sources',
    output:'Output', intel:'Topic Intelligence', url:'Drop a Link',
    articles:'Articles', help:'Help & Guide', social:'Social Comment'
  };
  document.getElementById('topbarTitle').textContent = titles[id] || '';
  closeSidebar();
}

function toggleTrendingCustomDates(show) {
  document.getElementById('trendingCustomDates').style.display = show ? 'block' : 'none';
}

function switchUrlMode(mode, el) {
  document.querySelectorAll('#panel-url .intel-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('urlModeUrl').style.display = mode === 'url' ? 'block' : 'none';
  document.getElementById('urlModeText').style.display = mode === 'text' ? 'block' : 'none';
}

function clearPasteText() {
  document.getElementById('pasteTextInput').value = '';
  document.getElementById('pasteUrlInput').value = '';
  document.getElementById('pasteTitleInput').value = '';
  document.getElementById('sourceInputText').value = '';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

function selectLength(el) {
  document.querySelectorAll('[data-words]').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  targetWords = parseInt(el.dataset.words);
}

function switchOutputTab(tab, el) {
  document.querySelectorAll('.output-tab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tabPreview').style.display = tab === 'preview' ? 'block' : 'none';
  document.getElementById('tabRaw').style.display = tab === 'raw' ? 'block' : 'none';
  document.getElementById('tabHtml').style.display = tab === 'html' ? 'block' : 'none';
}

function switchIntelMode(mode, el) {
  document.querySelectorAll('.intel-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.intel-tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('intel-' + mode).classList.add('active');
  intelMode = mode;
  document.getElementById('intelResults').style.display = 'none';
}

function selectRegion(el) {
  document.querySelectorAll('#intel-trending .region-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedRegion = el.dataset.region;
}

function selectSearchRegion(el) {
  document.querySelectorAll('#intel-search .region-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedSearchRegion = el.dataset.region;
}

function selectPeriod(el) {
  document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  selectedPeriod = el.dataset.period;
  if (selectedPeriod !== 'custom') toggleTrendingCustomDates(false);
}

function setUrlWords(n, el) {
  document.querySelectorAll('#urlWordChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  targetWords = n;
}
function setTextWords(n, el) {
  document.querySelectorAll('#textWordChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  targetWords = n;
}
function setSocialStyle(el, style) {
  document.querySelectorAll('#socialStyleChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  socialStyle = style;
  document.getElementById('socialCustomStyle').value = '';
}
function setSocialLength(el, n) {
  document.querySelectorAll('#socialLengthChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  socialLength = n;
}
function selectTone(el, tone) {
  document.querySelectorAll('#toneChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedTone = tone;
}
function toggleRewrite() {
  const panel = document.getElementById('rewritePanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(barId, dotId, textId, state, msg) {
  const bar = document.getElementById(barId);
  const dot = document.getElementById(dotId);
  const txt = document.getElementById(textId);
  bar.style.display = 'flex';
  dot.className = 'status-dot ' + state;
  txt.textContent = msg;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API ‚Äî CLAUDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function waitForRateLimit() {
  const elapsed = Date.now() - lastApiCallTime;
  if (elapsed < COOLDOWN_MS) {
    const wait = COOLDOWN_MS - elapsed;
    const secs = Math.ceil(wait / 1000);
    return new Promise(resolve => {
      let remaining = secs;
      const interval = setInterval(() => {
        remaining--;
        if (remaining <= 0) { clearInterval(interval); resolve(); }
      }, 1000);
    });
  }
}

async function callClaude(systemPrompt, userPrompt, useSearch = false, retries = 2) {
  await waitForRateLimit();
  lastApiCallTime = Date.now();
  const tools = useSearch ? [{ type: 'web_search_20250305', name: 'web_search' }] : undefined;

  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      lastApiCallTime = Date.now();
      const response = await fetch(PROXY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-FGWW-Auth': PROXY_SECRET },
        body: JSON.stringify(Object.assign({
          model: MODEL, max_tokens: 8000,
          system: systemPrompt,
          messages: [{ role: 'user', content: userPrompt }]
        }, tools ? { tools } : {}))
      });

      if (response.status === 429 && attempt < retries) {
        await new Promise(r => setTimeout(r, 20000));
        continue;
      }
      if (!response.ok) {
        const errBody = await response.text();
        throw new Error('API error ' + response.status + ': ' + errBody.substring(0, 200));
      }
      const data = await response.json();
      const text = (data.content || [])
        .filter(b => b.type === 'text').map(b => b.text).join('\n')
        .replace(/<\/?cite[^>]*>/g, '');
      if (!text) throw new Error('No text returned from API');
      return text;
    } catch(err) {
      if (attempt === retries) throw err;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API ‚Äî NEWSAPI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchNewsAPI(query, region, fromDate, toDate) {
  const domains = NEWSAPI_DOMAINS[region] || NEWSAPI_DOMAINS[''];
  const body = {
    apiKey: NEWSAPI_KEY,
    q: query,
    language: 'en',
    sortBy: 'publishedAt',
    pageSize: 15,
    domains
  };
  if (fromDate) body.from = fromDate;
  if (toDate) body.to = toDate;

  const response = await fetch(PROXY_URL + '/newsapi', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-FGWW-Auth': PROXY_SECRET },
    body: JSON.stringify(body)
  });

  if (!response.ok) throw new Error('NewsAPI error ' + response.status);
  const data = await response.json();
  if (data.status !== 'ok') throw new Error(data.message || 'NewsAPI returned error status');
  if (!data.articles || data.articles.length === 0) throw new Error('No articles from NewsAPI');
  return data.articles;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API ‚Äî NEWSDATA (placeholder)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchNewsData(query, region, fromDate, toDate) {
  if (NEWSDATA_KEY === 'NEWSDATA_KEY_HERE') {
    throw new Error('NewsData.io key not configured');
  }
  const country = NEWSDATA_COUNTRIES[region] || '';
  const body = { q: query, language: 'en' };
  if (country) body.country = country;
  if (fromDate) body.from_date = fromDate;
  if (toDate) body.to_date = toDate;

  const response = await fetch(PROXY_URL + '/newsdata', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-FGWW-Auth': PROXY_SECRET },
    body: JSON.stringify(body)
  });
  const data = await response.json();
  if (data.status === 'placeholder') throw new Error('NewsData.io key not configured');
  if (data.status !== 'success') throw new Error('NewsData error: ' + (data.message || 'unknown'));
  if (!data.results || data.results.length === 0) throw new Error('No articles from NewsData');
  return data.results;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENRICH ARTICLES WITH CONTRARIAN ANGLES (no web search)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enrichArticlesWithAngles(rawArticles, topic) {
  const articlesText = rawArticles.slice(0, 12).map((a, i) => {
    const title = a.title || a.link || '';
    const desc = a.description || a.content_summary || a.content || '';
    const url = a.url || a.link || '';
    const source = a.source?.name || a.source_id || '';
    return `Article ${i+1}:\nTitle: ${title}\nSource: ${source}\nURL: ${url}\nDescription: ${desc.substring(0, 300)}`;
  }).join('\n\n');

  const result = await callClaude(
    `You are a research analyst for The Contrarian by Food Game. Given raw news articles, generate Contrarian angles for each one. Return ONLY a JSON array ‚Äî no other text, no markdown.`,
    `Topic context: "${topic}"

Raw articles:
${articlesText}

For each article, generate a Contrarian angle ‚Äî the counterintuitive argument hidden in this story. Return a JSON array: [{"title":"...","url":"...","source":"...","angle":"...","why":"..."}]
Only include articles that have genuine Contrarian potential. Return up to 10.`,
    false
  );

  return parseJSON(result);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRENDING ‚Äî waterfall: NewsData ‚Üí NewsAPI ‚Üí Claude
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runTrending() {
  const btn = document.getElementById('trendingBtn');
  btn.disabled = true;

  const periodLabels = { today:'today', '7days':'this past week', '30days':'this past month' };
  let periodLabel, fromDate, toDate;
  if (selectedPeriod === 'custom') {
    fromDate = document.getElementById('trendingDateFrom').value;
    toDate = document.getElementById('trendingDateTo').value;
    if (!fromDate || !toDate) { showToast('‚ö†Ô∏è Set both From and To dates'); btn.disabled = false; return; }
    periodLabel = `from ${fromDate} to ${toDate}`;
  } else {
    periodLabel = periodLabels[selectedPeriod] || 'recently';
    const now = new Date();
    toDate = now.toISOString().split('T')[0];
    if (selectedPeriod === 'today') { fromDate = toDate; }
    else if (selectedPeriod === '7days') { const d = new Date(now); d.setDate(d.getDate()-7); fromDate = d.toISOString().split('T')[0]; }
    else { const d = new Date(now); d.setDate(d.getDate()-30); fromDate = d.toISOString().split('T')[0]; }
  }

  const regionLabel = selectedRegion || 'globally';
  const query = 'business economics culture behaviour consumer trends';
  let items = null;
  let dataSource = 'both';

  // Run NewsData and NewsAPI in parallel, merge and deduplicate
  setStatus('statusBar','statusDot','statusText','working','üì° Fetching from NewsData.io + NewsAPI...');
  const [newsDataResult, newsApiResult] = await Promise.allSettled([
    fetchNewsData(query, selectedRegion, fromDate, toDate),
    fetchNewsAPI(query, selectedRegion, fromDate, toDate)
  ]);

  let combined = [];
  if (newsDataResult.status === 'fulfilled') combined = combined.concat(newsDataResult.value);
  if (newsApiResult.status === 'fulfilled') combined = combined.concat(newsApiResult.value);

  if (combined.length > 0) {
    // Deduplicate by URL
    const seen = new Set();
    combined = combined.filter(a => {
      const url = a.url || a.link || '';
      if (seen.has(url)) return false;
      seen.add(url);
      return true;
    }).slice(0, 20); // cap at 20 before enrichment

    const sourceLabel2 = newsDataResult.status === 'fulfilled' && newsApiResult.status === 'fulfilled'
      ? 'üì° NewsData + üì∞ NewsAPI' : newsDataResult.status === 'fulfilled' ? 'üì° NewsData.io' : 'üì∞ NewsAPI';
    setStatus('statusBar','statusDot','statusText','working',`${sourceLabel2} ‚Äî enriching ${combined.length} articles...`);
    try {
      items = await enrichArticlesWithAngles(combined, 'business culture behaviour ' + periodLabel);
      dataSource = 'both';
    } catch(e) {
      setStatus('statusBar','statusDot','statusText','error','Enrichment failed: ' + e.message);
      btn.disabled = false;
      return;
    }
  } else {
    // Fallback: Claude web search
    try {
      setStatus('statusBar','statusDot','statusText','working','‚ú® Claude web search fallback...');
      const result = await callClaude(
        `You are a news intelligence analyst for The Contrarian by Food Game. Find 15 trending stories. Return ONLY a JSON array: [{"title":"...","url":"...","source":"...","angle":"...","why":"..."}]`,
        `Find the 15 most interesting trending stories from ${periodLabel} ${selectedRegion ? 'in: ' + selectedRegion : 'globally'} with Contrarian potential ‚Äî counterintuitive angles across business, economics, culture, or human behaviour.`,
        true
      );
      items = parseJSON(result);
      dataSource = 'claude';
    } catch(e3) {
      setStatus('statusBar','statusDot','statusText','error','Error: ' + e3.message);
      btn.disabled = false;
      return;
    }
  }

  if (!Array.isArray(items) || items.length === 0) {
    setStatus('statusBar','statusDot','statusText','error','No results found');
    btn.disabled = false;
    return;
  }

  // Cap at 15
  items = items.slice(0, 15);
  digestItems = items.map((item, i) => ({ ...item, id: i, selected: false, dataSource }));
  const sourceLabel = dataSource === 'both' ? 'üì° NewsData + üì∞ NewsAPI' : dataSource === 'newsapi' ? 'üì∞ NewsAPI' : '‚ú® Claude';
  renderDigest(`üî• Trending ${periodLabel} ¬∑ ${selectedRegion ? regionLabel : 'Global'} ¬∑ ${sourceLabel}`);
  btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOPIC SEARCH ‚Äî same waterfall
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runTopicSearch() {
  const topic = document.getElementById('intelTopicInput').value.trim();
  if (!topic) { showToast('‚ö†Ô∏è Enter a topic first'); return; }

  const btn = document.getElementById('topicSearchBtn');
  btn.disabled = true;

  const dateFrom = document.getElementById('intelDateFrom').value;
  const dateTo = document.getElementById('intelDateTo').value;
  const dateRange = dateFrom ? `from ${dateFrom}${dateTo ? ' to ' + dateTo : ''}` : 'recent';
  let items = null;
  let dataSource = 'both';

  // Run NewsData and NewsAPI in parallel, merge and deduplicate
  setStatus('statusBar','statusDot','statusText','working','üì° Fetching from NewsData.io + NewsAPI...');
  const [newsDataResult, newsApiResult] = await Promise.allSettled([
    fetchNewsData(topic, selectedSearchRegion, dateFrom, dateTo),
    fetchNewsAPI(topic, selectedSearchRegion, dateFrom, dateTo)
  ]);

  let combined = [];
  if (newsDataResult.status === 'fulfilled') combined = combined.concat(newsDataResult.value);
  if (newsApiResult.status === 'fulfilled') combined = combined.concat(newsApiResult.value);

  if (combined.length > 0) {
    // Deduplicate by URL
    const seen = new Set();
    combined = combined.filter(a => {
      const url = a.url || a.link || '';
      if (seen.has(url)) return false;
      seen.add(url);
      return true;
    }).slice(0, 20);

    const sourceLabel2 = newsDataResult.status === 'fulfilled' && newsApiResult.status === 'fulfilled'
      ? 'üì° NewsData + üì∞ NewsAPI' : newsDataResult.status === 'fulfilled' ? 'üì° NewsData.io' : 'üì∞ NewsAPI';
    setStatus('statusBar','statusDot','statusText','working',`${sourceLabel2} ‚Äî enriching ${combined.length} articles...`);
    try {
      items = await enrichArticlesWithAngles(combined, topic);
      dataSource = 'both';
    } catch(e) {
      setStatus('statusBar','statusDot','statusText','error','Enrichment failed: ' + e.message);
      btn.disabled = false;
      return;
    }
  } else {
    // Fallback: Claude web search
    try {
      setStatus('statusBar','statusDot','statusText','working','‚ú® Claude web search fallback...');
      const result = await callClaude(
        `You are a research analyst for The Contrarian. Find 15 best articles on a topic. Return ONLY JSON array: [{"title":"...","url":"...","source":"...","angle":"...","why":"..."}]`,
        `Find 15 best articles about: "${topic}"${dateFrom ? '\nDate range: ' + dateRange : ''}${selectedSearchRegion ? '\nPrefer: ' + selectedSearchRegion : ''}`,
        true
      );
      items = parseJSON(result);
      dataSource = 'claude';
    } catch(e3) {
      setStatus('statusBar','statusDot','statusText','error','Error: ' + e3.message);
      btn.disabled = false;
      return;
    }
  }

  if (!Array.isArray(items) || items.length === 0) {
    setStatus('statusBar','statusDot','statusText','error','No results found');
    btn.disabled = false;
    return;
  }

  // Cap at 15
  items = items.slice(0, 15);
  digestItems = items.map((item, i) => ({ ...item, id: i, selected: false, dataSource }));
  const sourceLabel = dataSource === 'both' ? 'üì° NewsData + üì∞ NewsAPI' : dataSource === 'newsapi' ? 'üì∞ NewsAPI' : '‚ú® Claude';
  renderDigest(`üîç "${topic}" ¬∑ ${dateRange} ¬∑ ${sourceLabel}`);
  setStatus('statusBar','statusDot','statusText','done',`Found ${items.length} articles via ${sourceLabel}`);
  btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIGEST RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDigest(title) {
  document.getElementById('intelResults').style.display = 'block';
  document.getElementById('intelResultsTitle').textContent = title;

  const today = new Date().toLocaleDateString('en-AU', {day:'numeric', month:'short', year:'numeric'});

  const list = document.getElementById('digestList');
  list.innerHTML = digestItems.map((item, i) => {
    const ds = item.dataSource || 'claude';
    const badgeClass = ds === 'newsdata' ? 'badge-newsdata' : ds === 'newsapi' ? 'badge-newsapi' : 'badge-claude';
    const badgeLabel = ds === 'newsdata' ? 'üì° NewsData' : ds === 'newsapi' ? 'üì∞ NewsAPI' : '‚ú® Claude';
    return `
    <div class="digest-card ${item.selected ? 'selected' : ''}" id="digest-${item.id}">
      <div class="digest-rank">#${i+1}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span class="digest-source-badge ${badgeClass}">${badgeLabel}</span>
        <span style="font-size:9px;color:rgba(138,154,181,0.4);">${today}</span>
      </div>
      <div class="digest-source-tag">${escapeHtml(item.source || 'Source')}</div>
      <div class="digest-title">${escapeHtml(item.title || 'Untitled')}</div>
      <div class="digest-angle">"${escapeHtml(item.angle || '')}"</div>
      <div class="digest-url">${escapeHtml(item.url || '')}</div>
      <div class="digest-actions">
        <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;" onclick="writeFromDigest(${item.id})">‚úèÔ∏è Write this</button>
        <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;" onclick="toggleDigestSelect(${item.id})">${item.selected ? '‚úì Selected' : '+ Select'}</button>
        ${item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" rel="noopener" class="btn btn-ghost" style="font-size:11px;padding:6px 12px;text-decoration:none;">‚Üó Open</a>` : ''}
      </div>
    </div>`;
  }).join('');

  updateSynthesiseBtn();
  setStatus('statusBar','statusDot','statusText','done', `${digestItems.length} articles found`);
}

function toggleDigestSelect(id) {
  const item = digestItems.find(d => d.id === id);
  if (!item) return;
  item.selected = !item.selected;
  renderDigest(document.getElementById('intelResultsTitle').textContent);
}

function selectAllDigest() {
  digestItems.forEach(d => d.selected = true);
  renderDigest(document.getElementById('intelResultsTitle').textContent);
}

function updateSynthesiseBtn() {
  const selected = digestItems.filter(d => d.selected).length;
  const btn = document.getElementById('synthesiseBtn');
  btn.disabled = selected < 2;
  btn.textContent = selected >= 2 ? `‚ö° Synthesise ${selected} Selected` : '‚ö° Synthesise Selected';
}

function writeFromDigest(id) {
  const item = digestItems.find(d => d.id === id);
  if (!item) return;
  document.getElementById('topicInput').value = item.title || '';
  document.getElementById('contextInput').value = [
    item.angle ? `Contrarian angle: ${item.angle}` : '',
    item.why ? `Why it matters: ${item.why}` : '',
    item.url ? `Source: ${item.url}` : ''
  ].filter(Boolean).join('\n\n');
  document.getElementById('searchQueries').value = '';
  switchPanel('compose', document.querySelector('[data-panel=compose]'));
  showToast('Brief pre-filled from digest');
}

async function runSynthesis() {
  const selected = digestItems.filter(d => d.selected);
  if (selected.length < 2) { showToast('‚ö†Ô∏è Select at least 2 articles'); return; }

  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working',`Synthesising ${selected.length} stories...`);
  document.getElementById('tabPreview').style.display = 'block';
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Finding the thread across all stories...</div>';

  try {
    const storiesText = selected.map((s, i) =>
      `Story ${i+1}: ${s.title}\nSource: ${s.source}\nURL: ${s.url}\nContrarian angle: ${s.angle}`
    ).join('\n\n');
    const topic = `The hidden pattern connecting: ${selected.map(s => s.title).join(' / ')}`;

    const piece = await callClaude(RORY_VOICE,
      `Write a Contrarian opinion piece of approximately ${targetWords} words synthesising these ${selected.length} stories into one unified argument.\n\nSOURCE STORIES:\n${storiesText}\n\nFind the ONE underlying pattern. Do NOT cover each story separately. Cite URLs as markdown hyperlinks [text](url).`,
      false
    );

    const synthSources = selected.map(s => ({ title: s.title, url: s.url, snippet: s.angle }));
    const extracted = extractHeadline(piece);
    currentPiece = {
      topic, context: `Synthesised from ${selected.length} stories`,
      raw: piece, body: extracted.body,
      headline: extracted.headline || `The Pattern Nobody's Seeing`,
      html: renderPieceHTML(extracted.body, extracted.headline || `The Pattern Nobody's Seeing`, synthSources),
      sources: synthSources, date: new Date().toISOString(), words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done ¬∑ ~${countWords(piece)} words`);
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// URL DROP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addUrl() {
  const input = document.getElementById('urlInput');
  const url = input.value.trim();
  if (!url) return;
  if (!url.startsWith('http')) { showToast('‚ö†Ô∏è Please enter a valid URL'); return; }
  if (addedUrls.find(u => u.url === url)) { showToast('‚ö†Ô∏è URL already added'); return; }
  if (addedUrls.length >= 5) { showToast('‚ö†Ô∏è Maximum 5 URLs'); return; }
  addedUrls.push({ url, status: 'pending' });
  input.value = '';
  renderUrlList();
}

function removeUrl(idx) { addedUrls.splice(idx, 1); renderUrlList(); }
function clearUrls() { addedUrls = []; renderUrlList(); }

function renderUrlList() {
  const list = document.getElementById('urlList');
  const singleActions = document.getElementById('urlSingleActions');
  if (addedUrls.length === 0) { list.style.display = 'none'; singleActions.style.display = 'none'; return; }
  list.style.display = 'flex';
  singleActions.style.display = 'flex';
  const synthBtn = document.getElementById('urlSynthBtn');
  if (synthBtn) synthBtn.style.display = addedUrls.length >= 2 ? 'inline-flex' : 'none';
  list.innerHTML = addedUrls.map((item, i) => `
    <div class="url-item">
      <div class="url-text">${escapeHtml(item.url)}</div>
      <div class="url-status">${item.status === 'fetched' ? '‚úÖ' : item.status === 'error' ? '‚ùå' : '‚è≥'}</div>
      <button class="url-remove" onclick="removeUrl(${i})">√ó</button>
    </div>`).join('');
}

async function runUrlFetch() {
  if (addedUrls.length === 0) { showToast('‚ö†Ô∏è Add at least one URL'); return; }
  const btn = document.getElementById('urlSingleBtn');
  btn.disabled = true;
  setStatus('statusBar','statusDot','statusText','working','Fetching article content...');

  try {
    const urlsText = addedUrls.map((u, i) => `URL ${i+1}: ${u.url}`).join('\n');
    const isSingle = addedUrls.length === 1;

    const result = await callClaude(
      `You are a research assistant. Fetch and read the provided URL(s). Return ONLY JSON: ${isSingle ? '{"title":"...","summary":"...","key_points":["..."],"contrarian_angle":"...","access_error":false}' : '{"combined_topic":"...","articles":[{"title":"...","summary":"...","url":"..."}],"connecting_theme":"...","contrarian_angle":"...","access_error":false}'}`,
      `Fetch and read ${isSingle ? 'this article' : 'these articles'}:\n\n${urlsText}`,
      true
    );

    const data = parseJSON(result);
    if (data.access_error) {
      setStatus('statusBar','statusDot','statusText','error','‚ö†Ô∏è Could not access URL. Try "Paste Article Text" instead.');
      addedUrls[0].status = 'error';
      renderUrlList();
      btn.disabled = false;
      return;
    }

    if (isSingle) {
      document.getElementById('topicInput').value = data.title || addedUrls[0].url;
      document.getElementById('contextInput').value = [
        data.contrarian_angle ? `Contrarian angle: ${data.contrarian_angle}` : '',
        data.summary ? `Summary: ${data.summary}` : '',
        `Source: ${addedUrls[0].url}`
      ].filter(Boolean).join('\n\n');
      addedUrls[0].status = 'fetched';
      renderUrlList();
      switchPanel('compose', document.querySelector('[data-panel=compose]'));
      showToast('‚úÖ Brief pre-filled from article');
    } else {
      document.getElementById('topicInput').value = data.combined_topic || 'Multi-source synthesis';
      collectedSources = (data.articles || addedUrls).map((a, i) => ({
        id: i, title: a.title || `Article ${i+1}`, url: a.url || addedUrls[i]?.url || '',
        snippet: a.summary || '', selected: true
      }));
      addedUrls.forEach(u => u.status = 'fetched');
      renderUrlList();
      renderSources();
      switchPanel('sources', document.querySelector('[data-panel=sources]'));
    }
    setStatus('statusBar','statusDot','statusText','done', isSingle ? 'Article fetched' : 'Articles fetched');
  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Fetch failed ‚Äî try "Paste Article Text" if site blocks access.');
    addedUrls.forEach(u => u.status = 'error');
    renderUrlList();
  }
  btn.disabled = false;
}

async function runUrlSynthesis() {
  if (addedUrls.length < 2) { showToast('‚ö†Ô∏è Add at least 2 URLs'); return; }
  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working',`Reading ${addedUrls.length} articles...`);
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Reading all articles...</div>';

  try {
    const urlsText = addedUrls.map((u, i) => `Article ${i+1}: ${u.url}`).join('\n');
    const piece = await callClaude(RORY_VOICE,
      `Read these ${addedUrls.length} articles, write a Contrarian piece ~${targetWords} words synthesising them into one argument.\n\n${urlsText}\n\nCite URLs as markdown hyperlinks.`,
      true
    );
    const urlSources = addedUrls.map((u, i) => ({ title: `Article ${i+1}`, url: u.url, snippet: '' }));
    const extracted = extractHeadline(piece);
    currentPiece = {
      topic: `Synthesis: ${addedUrls.length} articles`, context: addedUrls.map(u => u.url).join('\n'),
      raw: piece, body: extracted.body, headline: extracted.headline || `The Pattern`,
      html: renderPieceHTML(extracted.body, extracted.headline || `The Pattern`, urlSources),
      sources: urlSources, date: new Date().toISOString(), words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = piece;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done ¬∑ ~${countWords(piece)} words`);
    addedUrls.forEach(u => u.status = 'fetched');
    renderUrlList();
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

async function runTextBrief() {
  const text = document.getElementById('pasteTextInput').value.trim();
  if (!text) { showToast('‚ö†Ô∏è Paste some article text first'); return; }
  const sourceUrl = document.getElementById('pasteUrlInput').value.trim();
  const sourceTitle = document.getElementById('pasteTitleInput').value.trim();
  setStatus('statusBar','statusDot','statusText','working','Analysing article text...');

  try {
    const result = await callClaude(
      'You are a research analyst. Extract key information from article text. Return ONLY JSON: {"title":"...","summary":"...","key_points":["..."],"contrarian_angle":"..."}',
      `Analyse this article:\n\n${text.substring(0, 8000)}\n\n${sourceUrl ? 'Source URL: ' + sourceUrl : ''}`,
      false
    );
    const data = parseJSON(result);
    document.getElementById('topicInput').value = sourceTitle || data.title || 'Article analysis';
    document.getElementById('contextInput').value = [
      data.contrarian_angle ? `Contrarian angle: ${data.contrarian_angle}` : '',
      data.summary ? `Summary: ${data.summary}` : '',
      sourceUrl ? `Source: ${sourceUrl}` : ''
    ].filter(Boolean).join('\n\n');
    collectedSources = [{ id:0, title: sourceTitle||data.title||'Pasted article', url: sourceUrl||'', snippet: data.summary||'', selected:true }];
    switchPanel('compose', document.querySelector('[data-panel=compose]'));
    showToast('‚úÖ Brief ready');
  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }
}

async function runTextDirect() {
  const text = document.getElementById('pasteTextInput').value.trim();
  if (!text) { showToast('‚ö†Ô∏è Paste some article text first'); return; }
  const sourceUrl = document.getElementById('pasteUrlInput').value.trim();
  const sourceTitle = document.getElementById('pasteTitleInput').value.trim();
  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Writing from article text...');
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Writing...</div>';

  try {
    const piece = await callClaude(RORY_VOICE,
      `Write a Contrarian piece ~${targetWords} words from this source.\n\nSOURCE: ${sourceTitle||'Article'}\n${sourceUrl ? 'URL: '+sourceUrl+'\n' : ''}\n${text.substring(0,8000)}`,
      false
    );
    const srcList = [{ title: sourceTitle||'Pasted article', url: sourceUrl||'', snippet:'' }];
    const extracted = extractHeadline(piece);
    currentPiece = {
      topic: sourceTitle||'From article text', context: sourceUrl||'',
      raw: piece, body: extracted.body, headline: extracted.headline||sourceTitle||'',
      html: renderPieceHTML(extracted.body, extracted.headline||sourceTitle||'', srcList),
      sources: srcList, date: new Date().toISOString(), words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done ¬∑ ~${countWords(piece)} words`);
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runResearch() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { showToast('‚ö†Ô∏è Enter a topic first'); return; }
  let queries = document.getElementById('searchQueries').value.trim().split('\n').filter(q => q.trim());
  setStatus('statusBar','statusDot','statusText','working','Researching sources...');
  document.getElementById('researchBtn').disabled = true;

  try {
    if (queries.length === 0) {
      const qResult = await callClaude('Generate 4-5 web search queries. Return ONLY a JSON array of strings.',
        `Topic for Contrarian piece:\n${topic}\n\nContext: ${document.getElementById('contextInput').value.trim()||'None'}`, false);
      try { queries = JSON.parse(qResult.replace(/```json\s*/g,'').replace(/```/g,'').trim()); }
      catch(e) { queries = [topic + ' behavioural economics', topic + ' counterintuitive']; }
      document.getElementById('searchQueries').value = queries.join('\n');
    }

    const searchPrompt = queries.map((q,i) => `Query ${i+1}: "${q}"`).join('\n');
    const searchResult = await callClaude(
      'Research assistant. Search the web for each query. Return ONLY a JSON array: [{"title":"...","url":"...","snippet":"..."}]. Return 6-10 results.',
      `Search these queries:\n${searchPrompt}\n\nContext: Contrarian piece about "${topic}".`,
      true
    );
    let sources = parseJSON(searchResult);
    if (!Array.isArray(sources) || sources.length === 0) throw new Error('No sources found. Try different queries.');
    collectedSources = sources.map((s, i) => ({ ...s, selected: true, id: i }));
    renderSources();
    setStatus('statusBar','statusDot','statusText','done',`Found ${sources.length} sources`);
    switchPanel('sources', document.querySelector('[data-panel=sources]'));
  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Error: ' + err.message);
  }
  document.getElementById('researchBtn').disabled = false;
}

function renderSources() {
  const list = document.getElementById('sourcesList');
  if (collectedSources.length === 0) {
    list.innerHTML = '<div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No sources found.</div>';
    document.getElementById('sourcesCount').textContent = 'No sources';
    return;
  }
  list.innerHTML = collectedSources.map(s => `
    <div class="source-card">
      <label class="source-check">
        <input type="checkbox" ${s.selected ? 'checked' : ''} onchange="toggleSource(${s.id})">
        <div class="source-title">${escapeHtml(s.title||'Untitled')}</div>
      </label>
      <div class="source-snippet">${escapeHtml(s.snippet||'')}</div>
      <a href="${escapeHtml(s.url||'#')}" target="_blank" rel="noopener" class="source-url">${escapeHtml(s.url||'')}</a>
    </div>`).join('');
  updateSourcesCount();
}

function toggleSource(id) {
  const s = collectedSources.find(s => s.id === id);
  if (s) s.selected = !s.selected;
  updateSourcesCount();
}
function selectAllSources() { collectedSources.forEach(s => s.selected = true); renderSources(); }
function deselectAllSources() { collectedSources.forEach(s => s.selected = false); renderSources(); }
function updateSourcesCount() {
  const sel = collectedSources.filter(s => s.selected).length;
  document.getElementById('sourcesCount').textContent = `${sel} of ${collectedSources.length} selected`;
  document.getElementById('writeBtn').disabled = sel === 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WRITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runWrite() {
  const topic = document.getElementById('topicInput').value.trim();
  const context = document.getElementById('contextInput').value.trim();
  const selected = collectedSources.filter(s => s.selected);
  if (selected.length === 0) { showToast('‚ö†Ô∏è Select at least one source'); return; }
  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Writing Contrarian piece...');
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Writing...</div>';

  try {
    const sourcesText = selected.map((s, i) =>
      `[Source ${i+1}] ${s.title}\nURL: ${s.url}\nSummary: ${s.snippet}`).join('\n\n');
    const piece = await callClaude(RORY_VOICE,
      `Write a Contrarian piece ~${targetWords} words.\n\nTOPIC: ${topic}${context ? '\n\nCONTEXT:\n' + context : ''}\n\nSOURCES (cite as [text](url)):\n${sourcesText}`,
      false
    );
    const extracted = extractHeadline(piece);
    currentPiece = {
      topic, context, raw: piece, body: extracted.body,
      headline: extracted.headline||topic,
      html: renderPieceHTML(extracted.body, extracted.headline||topic, selected),
      sources: selected, date: new Date().toISOString(), words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done ¬∑ ~${countWords(piece)} words`);
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

async function directWrite() {
  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) { showToast('‚ö†Ô∏è Enter a topic first'); return; }
  const context = document.getElementById('contextInput').value.trim();
  switchPanel('output', document.querySelector('[data-panel=output]'));
  document.getElementById('outputStatus').style.display = 'flex';
  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Researching and writing...');
  document.getElementById('outputPreview').innerHTML = '<div style="padding:60px;text-align:center;color:#888;">Searching and writing...</div>';

  try {
    const piece = await callClaude(RORY_VOICE,
      `Write a Contrarian piece ~${targetWords} words.\n\nTOPIC: ${topic}${context ? '\n\nCONTEXT:\n'+context : ''}\n\nSearch the web for sources. Cite as [text](url).`,
      true
    );
    const extracted = extractHeadline(piece);
    currentPiece = {
      topic, context, raw: piece, body: extracted.body,
      headline: extracted.headline||topic,
      html: renderPieceHTML(extracted.body, extracted.headline||topic, []),
      sources: [], date: new Date().toISOString(), words: targetWords
    };
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    setStatus('outputStatus','outputStatusDot','outputStatusText','done',`Done ¬∑ ~${countWords(piece)} words`);
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Error: ' + err.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOCIAL COMMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runSocialComment() {
  const post = document.getElementById('socialInput').value.trim();
  if (!post) { showToast('‚ö†Ô∏è Paste a post first'); return; }
  const btn = document.getElementById('socialBtn');
  btn.disabled = true;
  const customStyle = document.getElementById('socialCustomStyle').value.trim();
  const styleDesc = customStyle || socialStyle;

  try {
    const result = await callClaude(
      `You write sharp LinkedIn comments in the style of Rory Sutherland ‚Äî counterintuitive, witty, and precise. Find the argument nobody else is making. No hashtags. No emojis. No "Great post!" opener.`,
      `Write a ${socialLength === 1 ? 'single sentence' : 'two sentence'} LinkedIn comment on this post/article using the "${styleDesc}" approach.\n\nPOST:\n${post}`,
      false
    );
    document.getElementById('socialCommentText').textContent = result.trim();
    document.getElementById('socialOutput').style.display = 'block';
  } catch(err) {
    showToast('Error: ' + err.message);
  }
  btn.disabled = false;
}

async function copySocialComment() {
  const text = document.getElementById('socialCommentText').textContent;
  try { await navigator.clipboard.writeText(text); showToast('‚úÖ Copied!'); }
  catch(e) { showToast('Copy failed'); }
}

function saveSocialComment() {
  const text = document.getElementById('socialCommentText').textContent;
  if (!text) return;
  const history = JSON.parse(localStorage.getItem('contrarian_history') || '[]');
  history.unshift({ type:'comment', topic:'Social comment', raw:text, date:new Date().toISOString() });
  localStorage.setItem('contrarian_history', JSON.stringify(history.slice(0,50)));
  showToast('‚úÖ Saved to Articles');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REWRITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runRewrite() {
  if (!currentPiece.raw) { showToast('‚ö†Ô∏è No piece to rewrite'); return; }
  const custom = document.getElementById('rewriteCustom').value.trim();
  const tone = selectedTone;
  const instruction = custom || tone;
  if (!instruction) { showToast('‚ö†Ô∏è Pick a rewrite style or describe what to change'); return; }

  previousPieceHTML = currentPiece.html;
  previousPieceRaw = currentPiece.raw;
  document.getElementById('undoRewriteBtn').style.display = 'inline-flex';

  setStatus('outputStatus','outputStatusDot','outputStatusText','working','Rewriting...');
  document.getElementById('rewriteBtn').disabled = true;

  try {
    const toneInstructions = {
      punchier: 'Make it punchier and more direct. Sharpen every sentence.',
      softer: 'Make the tone more sympathetic and understanding.',
      funnier: 'Add more wit and humour while keeping the argument sharp.',
      sharper: 'Sharpen the central argument. Make it more precise and forceful.',
      shorter: 'Tighten the piece. Cut anything that doesn\'t earn its place.',
      longer: 'Expand the piece. Add more examples and depth.',
      opener: 'Rewrite the opening paragraphs to be more gripping.',
      closer: 'Rewrite the conclusion to land with more impact.'
    };
    const instruction2 = toneInstructions[tone] || custom;

    const piece = await callClaude(RORY_VOICE,
      `Here is a Contrarian piece to rewrite:\n\n${currentPiece.raw}\n\nRewrite instruction: ${instruction2}\n\nMaintain the voice and style. Keep the sign-off "- JB". Start with HEADLINE: on first line.`,
      false
    );
    const extracted = extractHeadline(piece);
    currentPiece.raw = piece;
    currentPiece.body = extracted.body;
    if (extracted.headline) currentPiece.headline = extracted.headline;
    currentPiece.html = renderPieceHTML(extracted.body, currentPiece.headline, currentPiece.sources);
    showHeadlineField(currentPiece.headline);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputRaw').value = extracted.body;
    document.getElementById('outputHtml').textContent = currentPiece.html;
    setStatus('outputStatus','outputStatusDot','outputStatusText','done','Rewrite done');
  } catch(err) {
    setStatus('outputStatus','outputStatusDot','outputStatusText','error','Rewrite failed: ' + err.message);
  }
  document.getElementById('rewriteBtn').disabled = false;
}

function undoRewrite() {
  if (!previousPieceRaw) return;
  currentPiece.raw = previousPieceRaw;
  currentPiece.html = previousPieceHTML;
  const extracted = extractHeadline(previousPieceRaw);
  currentPiece.body = extracted.body;
  document.getElementById('outputPreview').innerHTML = previousPieceHTML;
  document.getElementById('outputRaw').value = extracted.body;
  document.getElementById('outputHtml').textContent = previousPieceHTML;
  document.getElementById('undoRewriteBtn').style.display = 'none';
  showToast('‚Ü© Reverted to previous version');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER + HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function extractHeadline(text) {
  const lines = text.split('\n');
  const headlineLine = lines.find(l => l.startsWith('HEADLINE:'));
  if (headlineLine) {
    const headline = headlineLine.replace('HEADLINE:', '').trim();
    const body = lines.filter(l => !l.startsWith('HEADLINE:')).join('\n').replace(/^\n+/, '');
    return { headline, body };
  }
  const firstLine = lines[0].trim().replace(/^#+\s*/, '');
  if (firstLine.length < 120) {
    return { headline: firstLine, body: lines.slice(1).join('\n').replace(/^\n+/, '') };
  }
  return { headline: '', body: text };
}

function showHeadlineField(headline) {
  document.getElementById('headlineGroup').style.display = 'block';
  document.getElementById('headlineInput').value = headline;
}

function updatePreviewFromRaw() {
  const body = document.getElementById('outputRaw').value;
  if (!body) { showToast('‚ö†Ô∏è Nothing in Raw Text'); return; }
  currentPiece.body = body;
  currentPiece.raw = body;
  currentPiece.html = renderPieceHTML(body, currentPiece.headline || '', currentPiece.sources || []);
  document.getElementById('outputPreview').innerHTML = currentPiece.html;
  document.getElementById('outputHtml').textContent = currentPiece.html;
  switchOutputTab('preview', document.querySelector('.output-tab'));
  showToast('‚úÖ Preview updated');
}

function updatePreviewHeadline() {
  const headline = document.getElementById('headlineInput').value;
  if (currentPiece.raw) {
    currentPiece.headline = headline;
    currentPiece.html = renderPieceHTML(currentPiece.body || currentPiece.raw, headline, currentPiece.sources);
    document.getElementById('outputPreview').innerHTML = currentPiece.html;
    document.getElementById('outputHtml').textContent = currentPiece.html;
  }
}

function renderPieceHTML(markdown, headline, sources) {
  sources = sources || [];

  // Split on double newlines first, preserve <img> tags before escaping
  const paragraphs = markdown.split(/\n\n+/);

  let html = paragraphs.map(p => {
    p = p.trim();
    if (!p) return '';

    // Extract and preserve any <img> tags before escaping
    const imgTags = [];
    const pClean = p.replace(/<img\s[^>]*>/gi, match => {
      imgTags.push(match);
      return '%%%IMG' + (imgTags.length - 1) + '%%%';
    });

    // Escape then process markdown
    p = escapeHtml(pClean);
    p = p.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:#e91e8c;font-weight:600;">$1</a>');

    // If paragraph was only an img tag, render as block
    if (imgTags.length > 0 && p.trim().replace(/%%%IMG\d+%%%/g,'').trim() === '') {
      return imgTags.map(img => `<div style="margin:16px 0;">${img}</div>`).join('');
    }

    // Restore img tags unescaped into paragraph text
    p = p.replace(/%%%IMG(\d+)%%%/g, (_, i) => imgTags[i]);

    if (p.startsWith('# ') || p.startsWith('## ')) return '';
    if (p.startsWith('&gt; ')) return `<div style="border-left:4px solid #f4a7b9;padding:14px 18px;margin:0 0 18px;background:rgba(233,30,140,0.05);border-radius:0 8px 8px 0;font-size:14px;line-height:1.75;color:#1a1a2e;font-style:italic;">${p.replace(/^&gt; /,'')}</div>`;
    if (p === '- JB' || p === '‚Äî JB') return `<p style="font-size:13px;color:#888;margin:0;font-style:italic;">- JB</p>`;
    p = p.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>');
    return `<p style="font-size:14px;line-height:1.85;color:#333;margin:0 0 16px;font-family:'DM Sans',Arial,sans-serif;">${p.replace(/\n/g,'<br>')}</p>`;
  }).join('');



  const validSources = sources.filter(s => s && (s.title || s.url));
  const sourceBlock = validSources.length > 0 ? `
    <div style="margin-top:24px;padding-top:18px;border-top:1px solid #e8e0f0;">
      <div style="font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:#aaa;font-weight:700;margin-bottom:8px;">Source${validSources.length > 1 ? 's' : ''}</div>
      ${validSources.map(s => `<div style="font-size:12px;color:#777;line-height:1.6;margin-bottom:4px;">
        ${s.title ? `<span style="font-weight:600;color:#555;">${escapeHtml(s.title)}</span>` : ''}
        ${s.url ? `${s.title?' &middot; ':''}<a href="${s.url}" target="_blank" rel="noopener" style="color:#e91e8c;text-decoration:none;word-break:break-all;">${s.url}</a>` : ''}
      </div>`).join('')}
    </div>` : '';

  const today = new Date().toLocaleDateString('en-AU', {day:'numeric', month:'long', year:'numeric'});

  return `<div style="font-family:'DM Sans',Arial,sans-serif;color:#1a1a2e;max-width:660px;margin:0 auto;">
  <div style="background:#0f1f38;padding:36px 44px 30px;text-align:center;border-radius:12px 12px 0 0;">
    <div style="font-size:8px;letter-spacing:4px;text-transform:uppercase;color:#f4a7b9;margin-bottom:12px;opacity:0.8;font-weight:600;">The Contrarian &middot; by Food Game Media</div>
    <div style="font-family:'Playfair Display',Georgia,serif;font-size:clamp(22px,3.5vw,32px);font-weight:900;color:#fff;line-height:1.15;font-style:italic;letter-spacing:-0.5px;">${escapeHtml(headline)}</div>
    <div style="width:48px;height:2px;background:linear-gradient(90deg,transparent,#f4a7b9,transparent);margin:18px auto 0;"></div>
    <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:12px;letter-spacing:0.3px;">${today}</div>
  </div>
  <div style="background:#cdc8d9;padding:36px 44px 40px;">
    <div style="margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid rgba(15,31,56,0.12);">
      <div style="display:inline-block;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:#fff;background:#0f1f38;border-radius:4px;padding:4px 10px;">Opinion</div>
    </div>
    ${html}

    <div style="background:#fce4ec;padding:28px 32px;border-radius:10px;margin-top:32px;">
      <div style="font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#e91e8c;font-weight:700;margin-bottom:18px;">About the Author</div>
      <table cellpadding="0" cellspacing="0" border="0" width="100%">
        <tr>
          <td style="width:122px;vertical-align:top;padding-right:22px;">
            <img src="data:image/jpeg;base64,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" alt="Julian Blok" style="width:100px;height:100px;border-radius:50%;border:3px solid #f4a7b9;display:block;">
          </td>
          <td style="vertical-align:top;">
            <div style="font-family:'Playfair Display',Georgia,serif;font-size:16px;color:#0f1f38;font-weight:700;margin-bottom:10px;">Julian Blok</div>
            <div style="font-size:12px;color:#444;line-height:1.8;margin-bottom:11px;">Contrarians are not born. They are assembled ‚Äî slowly, accidentally, and usually at someone else's expense. A stint in European banking teaches you that confidence and correctness are not the same thing. Extensive travel teaches you that the obvious answer is mostly just the local one. A decade supplying hospitality businesses teaches you that the industry's most repeated problems are not bad luck ‚Äî they are bad defaults, faithfully maintained.</div>
            <div style="font-size:12px;color:#444;line-height:1.8;">Julian Blok consults on behavioural insight and systems-led change for hospitality and business operators. <em>The Contrarian</em> is what happens when someone who has spent too long watching the same mistakes recur decides, rather belatedly, to say something about it.</div>
          </td>
        </tr>
      </table>
    </div>
    ${sourceBlock}
  </div>
</div>`;
}

function countWords(text) {
  return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function parseJSON(str) {
  let clean = str.trim().replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/```$/,'').trim();
  const arrMatch = clean.match(/\[[\s\S]*\]/);
  if (arrMatch) return JSON.parse(arrMatch[0]);
  const objMatch = clean.match(/\{[\s\S]*\}/);
  if (objMatch) return JSON.parse(objMatch[0]);
  return JSON.parse(clean);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OUTPUT ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cleanRawText(text) {
  return text
    // Remove markdown bold/italic
    .replace(/\*\*([^*]+)\*\*/g, '$1')
    .replace(/\*([^*]+)\*/g, '$1')
    // Remove markdown headings
    .replace(/^#{1,3}\s+/gm, '')
    // Replace em dashes with comma-space
    .replace(/\s*‚Äî\s*/g, ', ')
    // Fix lines that start with punctuation (.,) due to markdown stripping
    .replace(/^\s*[,\.]\s*/gm, '')
    // Remove markdown links, keep text
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    // Normalise multiple blank lines to double
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}

async function copyRawText() {
  const text = currentPiece.body || currentPiece.raw || '';
  if (!text) { showToast('‚ö†Ô∏è No text to copy'); return; }
  try { await navigator.clipboard.writeText(cleanRawText(text)); showToast('‚úÖ Copied!'); }
  catch(e) { showToast('Copy failed ‚Äî use the Raw Text tab'); }
}

async function copyHtml() {
  const html = currentPiece.html || '';
  if (!html) { showToast('‚ö†Ô∏è No HTML to copy'); return; }
  try { await navigator.clipboard.writeText(html); showToast('‚úÖ HTML copied!'); }
  catch(e) { showToast('Copy failed'); }
}

function downloadHtml() {
  if (!currentPiece.html) { showToast('‚ö†Ô∏è Generate a piece first'); return; }
  const now = new Date();
  const dd = String(now.getDate()).padStart(2,'0');
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const yy = String(now.getFullYear()).slice(-2);
  const sourceVal = (
    (document.getElementById('sourceInput') && document.getElementById('sourceInput').value.trim()) ||
    (document.getElementById('sourceInputUrl') && document.getElementById('sourceInputUrl').value.trim()) ||
    (document.getElementById('sourceInputText') && document.getElementById('sourceInputText').value.trim()) ||
    (document.getElementById('sourceInputIntel') && document.getElementById('sourceInputIntel').value.trim()) ||
    'source'
  );
  const sourceSlug = sourceVal.replace(/[^a-zA-Z0-9.]+/g,'-').substring(0,30);
  const headlineSlug = (currentPiece.headline || currentPiece.topic || 'contrarian-piece').replace(/[^a-zA-Z0-9]+/g,'-').substring(0,50);
  const filename = `${dd}.${mm}.${yy}-${headlineSlug}-${sourceSlug}.html`;
  const blob = new Blob([`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:32px;background:#f5f5f5;">${currentPiece.html}</body></html>`], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

async function saveToHistory() {
  if (!currentPiece.html) { showToast('‚ö†Ô∏è Nothing to save'); return; }
  const now = new Date();
  const dd = String(now.getDate()).padStart(2,'0');
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const yy = String(now.getFullYear()).slice(-2);
  const sourceVal = (
    (document.getElementById('sourceInput') && document.getElementById('sourceInput').value.trim()) ||
    (document.getElementById('sourceInputUrl') && document.getElementById('sourceInputUrl').value.trim()) ||
    (document.getElementById('sourceInputText') && document.getElementById('sourceInputText').value.trim()) ||
    (document.getElementById('sourceInputIntel') && document.getElementById('sourceInputIntel').value.trim()) ||
    'source'
  );
  const sourceSlug = sourceVal.replace(/[^a-zA-Z0-9.]+/g,'-').substring(0,30);
  const headlineSlug = (currentPiece.headline || currentPiece.topic || 'contrarian-piece').replace(/[^a-zA-Z0-9]+/g,'-').substring(0,50);
  const filename = dd+'.'+mm+'.'+yy+'-'+headlineSlug+'-'+sourceSlug+'.html';
  const fullHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:32px;background:#f5f5f5;">'+currentPiece.html+'</body></html>';
  const encoded = btoa(unescape(encodeURIComponent(fullHtml)));
  showToast('‚è≥ Saving to GitHub...');
  try {
    let sha = null;
    const checkRes = await fetch('https://api.github.com/repos/'+GITHUB_OWNER+'/'+GITHUB_REPO+'/contents/articles/'+filename, {
      headers: { 'Authorization': 'token '+GITHUB_TOKEN, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (checkRes.ok) { const existing = await checkRes.json(); sha = existing.sha; }
    const body = { message: 'Save article: '+filename, content: encoded, branch: GITHUB_BRANCH };
    if (sha) body.sha = sha;
    const res = await fetch('https://api.github.com/repos/'+GITHUB_OWNER+'/'+GITHUB_REPO+'/contents/articles/'+filename, {
      method: 'PUT',
      headers: { 'Authorization': 'token '+GITHUB_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) { const err = await res.json(); throw new Error(err.message || 'GitHub API error'); }
    showToast('‚úÖ Saved to GitHub Articles');
  } catch(err) {
    showToast('‚ùå Save failed: ' + err.message);
  }
}

async function renderHistory() {
  const list = document.getElementById('historyList');
  list.innerHTML = '<div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">‚è≥ Loading articles...</div>';
  try {
    const res = await fetch('https://api.github.com/repos/'+GITHUB_OWNER+'/'+GITHUB_REPO+'/contents/articles', {
      headers: { 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!res.ok) throw new Error('Could not fetch articles');
    const files = await res.json();
    const articles = files.filter(f => f.name.endsWith('.html') && f.name !== '.gitkeep');
    if (articles.length === 0) {
      list.innerHTML = '<div style="color:var(--grey);font-size:13px;text-align:center;padding:40px;">No saved articles yet.</div>';
      return;
    }
    // Parse date and title from filename ‚Äî handles both dd.mm.yy-Headline-source.html and freeform names
    list.innerHTML = articles.map((file, i) => {
      const name = file.name.replace('.html','');
      // Check if filename matches naming protocol: starts with dd.mm.yy
      const protocolMatch = name.match(/^(\d{2}\.\d{2}\.\d{2})-(.+)$/);
      let dateStr, label;
      if (protocolMatch) {
        dateStr = protocolMatch[1];
        label = protocolMatch[2].replace(/-/g, ' ');
      } else {
        dateStr = '';
        label = name.replace(/[-_]/g, ' ');
      }
      return `
      <div class="history-item">
        <div class="history-title">${escapeHtml(label)}</div>
        <div class="history-meta">${dateStr ? 'üìÖ ' + escapeHtml(dateStr) : 'üìÑ ' + escapeHtml(file.name)}</div>
        <div class="btn-row">
          <button class="btn btn-ghost" onclick="loadFromGitHub('${escapeHtml(file.name)}','${escapeHtml(file.download_url)}')">‚Ü© Load</button>
          <button class="btn btn-ghost" onclick="deleteFromGitHub('${escapeHtml(file.name)}','${escapeHtml(file.sha)}')" style="color:#f87171;">üóë Delete</button>
        </div>
      </div>`;
    }).join('');
  } catch(err) {
    list.innerHTML = '<div style="color:#f87171;font-size:13px;text-align:center;padding:40px;">‚ùå '+escapeHtml(err.message)+'</div>';
  }
}

async function loadFromGitHub(filename, downloadUrl) {
  showToast('‚è≥ Loading article...');
  try {
    const res = await fetch(downloadUrl);
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = doc.body.innerHTML || html;
    // Extract clean readable text for raw/edit panel
    const rawText = (doc.body.textContent || '').trim();
    const protocolMatch = filename.replace('.html','').match(/^(\d{2}\.\d{2}\.\d{2})-(.+)$/);
    const headline = protocolMatch ? protocolMatch[2].replace(/-/g,' ') : filename.replace('.html','').replace(/[-_]/g,' ');
    currentPiece.html = content;
    currentPiece.raw = rawText;
    currentPiece.body = rawText;
    currentPiece.topic = filename.replace('.html','');
    currentPiece.headline = headline;
    currentPiece.sources = [];
    document.getElementById('outputPreview').innerHTML = content;
    document.getElementById('outputRaw').value = rawText;
    document.getElementById('outputHtml').textContent = content;
    showHeadlineField(headline);
    document.getElementById('rewriteToggleBtn').style.display = 'block';
    switchPanel('output', document.querySelector('[data-panel=output]'));
    showToast('‚úÖ Article loaded');
  } catch(err) {
    showToast('‚ùå Load failed: ' + err.message);
  }
}

async function deleteFromGitHub(filename, sha) {
  if (!confirm('Delete "'+filename+'" from GitHub?')) return;
  showToast('‚è≥ Deleting...');
  try {
    const res = await fetch('https://api.github.com/repos/'+GITHUB_OWNER+'/'+GITHUB_REPO+'/contents/articles/'+filename, {
      method: 'DELETE',
      headers: { 'Authorization': 'token '+GITHUB_TOKEN, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'Delete article: '+filename, sha: sha, branch: GITHUB_BRANCH })
    });
    if (!res.ok) throw new Error('Delete failed');
    showToast('üóë Deleted');
    renderHistory();
  } catch(err) {
    showToast('‚ùå '+err.message);
  }
}

function editBackToBrief() {
  if (!currentPiece.topic) { showToast('‚ö†Ô∏è No piece loaded'); return; }
  document.getElementById('topicInput').value = currentPiece.topic;
  document.getElementById('contextInput').value = currentPiece.context || '';
  switchPanel('compose', document.querySelector('[data-panel=compose]'));
}

function newAngleSameSources() {
  if (!currentPiece.sources || currentPiece.sources.length === 0) { showToast('‚ö†Ô∏è No sources to reuse'); return; }
  collectedSources = currentPiece.sources.map((s, i) => ({ ...s, id: i, selected: true }));
  document.getElementById('topicInput').value = '';
  document.getElementById('contextInput').value = '';
  renderSources();
  switchPanel('compose', document.querySelector('[data-panel=compose]'));
  showToast('Sources loaded ‚Äî add new angle and write');
}

function resetAll() {
  document.getElementById('topicInput').value = '';
  document.getElementById('contextInput').value = '';
  document.getElementById('searchQueries').value = '';
  document.getElementById('sourceInput').value = '';
  collectedSources = [];
  currentPiece = { topic:'', context:'', raw:'', html:'', sources:[] };
  showToast('Reset');
}

function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const html = e.target.result;
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const content = doc.body.innerHTML || html;
    currentPiece.html = content;
    currentPiece.raw = doc.body.textContent || '';
    currentPiece.topic = file.name.replace('.html','').replace('.htm','');
    document.getElementById('outputPreview').innerHTML = content;
    document.getElementById('outputRaw').value = currentPiece.raw;
    document.getElementById('outputHtml').textContent = content;
    switchPanel('output', document.querySelector('[data-panel=output]'));
    showToast('‚úÖ File imported');
  };
  reader.readAsText(file);
}

async function testConnection() {
  setStatus('statusBar','statusDot','statusText','working','Testing connection...');
  try {
    const result = await callClaude('Respond with exactly: OK', 'ping', false);
    setStatus('statusBar','statusDot','statusText','done','Connection OK ‚Äî Claude is live');
    showToast('‚úÖ Connected to Claude');
  } catch(err) {
    setStatus('statusBar','statusDot','statusText','error','Connection failed: ' + err.message);
    document.getElementById('localModeBadge').style.display = 'flex';
  }
}
</script>
</body>
</html>
